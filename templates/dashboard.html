<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF Analyzer - Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/common.css') }}" rel="stylesheet">
    <style>
        /* Style specyficzne dla dashboard */
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 20px 0;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
        }
        .search-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .yield-high { color: #28a745; font-weight: 600; }
        .yield-medium { color: #ffc107; font-weight: 600; }
        .yield-low { color: #dc3545; font-weight: 600; }
        .yield-unknown { color: #6c757d; font-weight: 600; }
        .frequency-badge {
            font-size: 0.8em;
            padding: 2px 8px;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .alert {
            border-radius: 8px;
            border: none;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mt-3">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="h3 mb-0">
                        <i class="bi bi-graph-up text-primary"></i>
                        ETF Analyzer Dashboard
                    </h1>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="refreshData()">
                            <i class="bi bi-arrow-clockwise"></i> Odśwież z DB
                        </button>
                        <button class="btn btn-outline-success" onclick="refreshFromAPI()" id="refreshApiBtn">
                            <i class="bi bi-cloud-download"></i> Odśwież API
                        </button>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEtfModal">
                            <i class="bi bi-plus"></i> Dodaj ETF
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="row mt-3">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Łącznie ETF</h6>
                            <h3 class="mb-0" id="totalEtfs">-</h3>
                        </div>
                        <i class="bi bi-collection display-6"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Ostatnia aktualizacja</h6>
                            <h6 class="mb-0" id="lastUpdate">-</h6>
                        </div>
                        <i class="bi bi-clock display-6"></i>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <a href="/system/status" class="text-decoration-none">
                    <div class="stats-card">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h6 class="mb-1">Status systemu</h6>
                                <h6 class="mb-0" id="systemStatus">-</h6>
                            </div>
                            <i class="bi bi-server display-6"></i>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">Wersja systemu</h6>
                            <h6 class="mb-0" id="systemVersion">-</h6>
                        </div>
                        <i class="bi bi-info-circle display-6"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search and Filter Section -->
        <div class="row mb-3">
            <div class="col-md-6">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search"></i>
                    </span>
                    <input type="text" class="form-control" id="searchInput" 
                           placeholder="Szukaj po tickerze lub nazwie" style="max-width: 300px;">
                </div>
            </div>
            <div class="col-md-6">
                <div class="input-group" style="max-width: 300px;">
                    <span class="input-group-text">
                        <i class="bi bi-percent"></i>
                    </span>
                    <input type="number" class="form-control" id="taxRateInput" 
                           placeholder="Podatek od dyw.: 0%" min="0" max="100" step="1" value="0">
                    <span class="input-group-text">%</span>
                </div>
            </div>
        </div>

        <!-- ETF Table -->
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-hover" id="etfTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0, 'ticker')">
                                Ticker <i class="bi bi-arrow-down-up sort-icon" id="sort-0"></i>
                            </th>
                            <th onclick="sortTable(1, 'name')">
                                Nazwa <i class="bi bi-arrow-down-up sort-icon" id="sort-1"></i>
                            </th>
                            <th onclick="sortTable(2, 'current_price')">
                                Cena <i class="bi bi-arrow-down-up sort-icon" id="sort-2"></i>
                            </th>
                            <th onclick="sortTable(3, 'current_yield')">
                                Yield <i class="bi bi-arrow-down-up sort-icon" id="sort-3"></i>
                            </th>
                            <th onclick="sortTable(4, 'frequency')">
                                Częstotliwość <i class="bi bi-arrow-down-up sort-icon" id="sort-4"></i>
                            </th>
                            <th onclick="sortTable(5, 'last_updated')">
                                Ostatnia aktualizacja <i class="bi bi-arrow-down-up sort-icon" id="sort-5"></i>
                            </th>
                            <th onclick="sortTable(6, 'dsg')">
                                DSG <i class="bi bi-arrow-down-up sort-icon" id="sort-6"></i>
                            </th>
                            <th onclick="sortTable(7, 'age')">
                                Wiek ETF <i class="bi bi-arrow-down-up sort-icon" id="sort-7"></i>
                            </th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody id="etfTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingSpinner" class="text-center d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Ładowanie...</span>
            </div>
            <p class="mt-2">Ładowanie danych...</p>
        </div>

        <!-- No Data Message -->
        <div id="noDataMessage" class="text-center d-none">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <h4 class="text-muted mt-3">Brak danych</h4>
            <p class="text-muted">Dodaj swój pierwszy ETF, aby rozpocząć analizę.</p>
        </div>
    </div>

    <!-- Add ETF Modal -->
    <div class="modal fade" id="addEtfModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Dodaj nowy ETF</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addEtfForm">
                        <div class="mb-3">
                            <label for="tickerInput" class="form-label">Ticker ETF</label>
                            <input type="text" class="form-control" id="tickerInput" 
                                   placeholder="np. SPY, QQQ, VTI" required>
                            <div class="form-text">Wprowadź ticker ETF (np. SPY, QQQ, VTI)</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                    <button type="button" class="btn btn-primary" onclick="addEtf()">
                        <span id="addEtfBtnText">Dodaj ETF</span>
                        <span id="addEtfBtnSpinner" class="spinner-border spinner-border-sm d-none"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Container -->
    <div id="alertContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let etfData = [];
        let currentSort = { column: 0, direction: 'asc' };
        let filteredData = [];
        let currentTaxRate = 0.0;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, starting dashboard initialization...');
            
            // Najpierw ustawiamy event listeners
            setupEventListeners();
            
            // Potem ładujemy dane
            loadDashboard();
        });

        function setupEventListeners() {
            console.log('🔧 Setting up event listeners...');
            
            // Search input
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', filterData);
                console.log('✅ Search input listener added');
            } else {
                console.log('❌ Search input not found!');
            }
            
            // Filters
            const frequencyFilter = document.getElementById('frequencyFilter');
            const yieldFilter = document.getElementById('yieldFilter');
            
            if (frequencyFilter) {
                frequencyFilter.addEventListener('change', filterData);
                console.log('✅ Frequency filter listener added');
            } else {
                console.log('❌ Frequency filter not found!');
            }
            
            if (yieldFilter) {
                yieldFilter.addEventListener('change', filterData);
                console.log('✅ Yield filter listener added');
            } else {
                console.log('❌ Yield filter not found!');
            }

            // Tax rate change
            const taxRateInput = document.getElementById('taxRateInput');
            if (taxRateInput) {
                console.log('✅ Tax rate input found, adding listener...');
                taxRateInput.addEventListener('input', function() {
                    const newTaxRate = parseFloat(this.value) || 0;
                    console.log('🎯 Tax rate input changed to:', newTaxRate, 'current:', currentTaxRate);
                    if (newTaxRate !== currentTaxRate) {
                        currentTaxRate = newTaxRate;
                        console.log('🔄 Tax rate updated, calling recalculateAllValues()...');
                        // Natychmiastowe przeliczenie wszystkich wartości
                        recalculateAllValues();
                        // Aktualizacja w bazie danych
                        console.log('💾 Saving tax rate to database...');
                        updateTaxRate(newTaxRate);
                    }
                });
                console.log('✅ Tax rate listener added');
            } else {
                console.log('❌ Tax rate input not found!');
            }
            
            console.log('🔧 Event listeners setup complete');
        }

        async function loadDashboard() {
            showLoading(true);
            try {
                const response = await fetch('/api/etfs');
                const result = await response.json();
                
                if (result.success) {
                    etfData = result.data;
                    
                    // Obliczanie wieku ETF na podstawie inception_date z FMP API
                    etfData.forEach(etf => {
                        if (etf.inception_date) {
                            const inceptionDate = new Date(etf.inception_date);
                            const now = new Date();
                            const diffTime = Math.abs(now - inceptionDate);
                            const diffYears = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 365.25));
                            etf.age = diffYears;
                        } else {
                            etf.age = null;
                        }
                    });
                    
                    filteredData = [...etfData];
                    
                    // Ładowanie DSG dla każdego ETF
                    await loadDSGForAllETFs();
                    
                    renderTable();
                    updateStats();
                    
                    // Po załadowaniu wszystkich danych ETF, ładujemy stawkę podatku i przeliczamy
                    await loadTaxRate();
                    
                    // Ładowanie wersji systemu
                    await loadSystemVersion();
                } else {
                    showAlert('Błąd podczas ładowania danych: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('Błąd połączenia: ' + error.message, 'danger');
            } finally {
                showLoading(false);
            }
        }

        async function loadDSGForAllETFs() {
            // Ładowanie DSG dla każdego ETF równolegle
            const dsgPromises = etfData.map(async (etf) => {
                try {
                    // Sprawdź czy ETF ma dywidendy przed wywołaniem DSG
                    const dividendsResponse = await fetch(`/api/etfs/${etf.ticker}/dividends`);
                    const dividendsResult = await dividendsResponse.json();
                    
                    if (dividendsResult.count === 0) {
                        // ETF bez dywidend - ustaw DSG na 0
                        etf.dsg = {
                            current_streak: 0,
                            total_years: 0,
                            streak_start_year: null,
                            last_dividend_change: 'Brak dywidend',
                            calculation_method: 'no dividends'
                        };
                        return;
                    }
                    
                    // ETF z dywidendami - pobierz DSG
                    const response = await fetch(`/api/etfs/${etf.ticker}/dsg`);
                    const result = await response.json();
                    
                    if (result.success) {
                        etf.dsg = result.data.dsg;
                    } else {
                        etf.dsg = null;
                    }
                } catch (error) {
                    console.error(`Error loading DSG for ${etf.ticker}:`, error);
                    etf.dsg = null;
                }
            });
            
            // Czekamy na załadowanie wszystkich DSG
            await Promise.all(dsgPromises);
        }
        
        // Funkcja do formatowania liczb z przecinkiem (polski format)
        function formatNumber(number, decimals = 2) {
            if (isNaN(number)) return 'N/A';
            return number.toFixed(decimals).replace('.', ',');
        }

        async function loadTaxRate() {
            try {
                console.log('🔄 Loading tax rate from API...');
                const response = await fetch('/api/system/dividend-tax-rate');
                const result = await response.json();
                
                if (result.success) {
                    currentTaxRate = result.data.tax_rate;
                    console.log('📊 Tax rate loaded:', currentTaxRate);
                    console.log('📊 currentTaxRate variable set to:', currentTaxRate);
                    document.getElementById('taxRateInput').value = currentTaxRate;
                    // Natychmiastowe przeliczenie wszystkich wartości po załadowaniu stawki
                    console.log('🧮 Calling recalculateAllValues() with currentTaxRate:', currentTaxRate);
                    recalculateAllValues();
                }
            } catch (error) {
                console.error('Error loading tax rate:', error);
            }
        }

        async function loadSystemVersion() {
            try {
                console.log('🔄 Loading system version from API...');
                const response = await fetch('/api/system/version');
                const result = await response.json();
                
                console.log('📊 API response:', result);
                
                if (result.success) {
                    const version = result.version; // Usunięto .data
                    console.log('📊 System version loaded:', version);
                    
                    // Aktualizacja pola wersji systemu
                    document.getElementById('systemVersion').textContent = `v${version}`;
                } else {
                    console.error('❌ Failed to load system version:', result.error);
                    document.getElementById('systemVersion').textContent = 'N/A';
                }
            } catch (error) {
                console.error('❌ Error loading system version:', error);
                document.getElementById('systemVersion').textContent = 'N/A';
            }
        }

        async function updateTaxRate(newTaxRate) {
            try {
                const response = await fetch('/api/system/dividend-tax-rate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        tax_rate: newTaxRate
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('Tax rate updated:', result.message);
                    // Przelicz wszystkie wartości
                    recalculateAllValues();
                } else {
                    console.error('Error updating tax rate:', result.error);
                }
            } catch (error) {
                console.error('Error updating tax rate:', error);
            }
        }

        function recalculateAllValues() {
            console.log('🔢 recalculateAllValues() called with tax rate:', currentTaxRate);
            console.log('📊 ETF data before recalculation:', etfData);
            console.log('📊 ETF data length:', etfData ? etfData.length : 'undefined');
            
            if (!etfData || etfData.length === 0) {
                console.log('❌ No ETF data available for recalculation!');
                return;
            }
            
            // Przelicz yield i kwoty dywidend dla wszystkich ETF
            etfData.forEach((etf, index) => {
                console.log(`🔍 Processing ETF ${index + 1}/${etfData.length}: ${etf.ticker}`);
                console.log(`🔍 ETF data:`, etf);
                
                if (etf.current_yield && etf.current_yield > 0) {
                    etf.after_tax_yield = calculateAfterTaxYield(etf.current_yield, currentTaxRate);
                    console.log(`📈 ${etf.ticker}: Yield ${etf.current_yield}% -> ${etf.after_tax_yield}% (tax: ${currentTaxRate}%)`);
                } else {
                    console.log(`⚠️ ${etf.ticker}: No current_yield or current_yield <= 0`);
                }
                
                if (etf.annual_dividend && etf.annual_dividend > 0) {
                    etf.after_tax_annual_dividend = calculateAfterTaxAmount(etf.annual_dividend, currentTaxRate);
                    console.log(`💰 ${etf.ticker}: Annual dividend $${etf.annual_dividend} -> $${etf.after_tax_annual_dividend} (tax: ${currentTaxRate}%)`);
                } else {
                    console.log(`⚠️ ${etf.ticker}: No annual_dividend or annual_dividend <= 0`);
                }
            });
            
            console.log('🔄 Refreshing table and stats...');
            // Odśwież tabelę
            renderTable();
            updateStats();
            console.log('✅ Recalculation complete!');
        }


        
        function calculateAfterTaxYield(originalYield, taxRate) {
            if (taxRate <= 0) return originalYield;
            return originalYield * (1 - taxRate / 100);
        }

        function calculateAfterTaxAmount(originalAmount, taxRate) {
            if (taxRate <= 0) return originalAmount;
            return originalAmount * (1 - taxRate / 100);
        }



        function renderTable() {
            const tbody = document.getElementById('etfTableBody');
            
            if (filteredData.length === 0) {
                document.getElementById('noDataMessage').classList.remove('d-none');
                document.getElementById('etfTable').classList.add('d-none');
                return;
            }
            
            document.getElementById('noDataMessage').classList.add('d-none');
            document.getElementById('etfTable').classList.remove('d-none');
            
            tbody.innerHTML = filteredData.map(etf => `
                <tr>
                    <td><strong>${etf.ticker}</strong></td>
                    <td>${etf.name || 'N/A'}</td>
                    <td>${etf.current_price ? '$' + formatNumber(etf.current_price, 2) : 'N/A'}</td>
                    <td>
                        ${etf.current_yield ? 
                            `<div class="text-center">
                                <div class="fw-bold yield-${getYieldClass(etf.current_yield)}">
                                    ${formatNumber(etf.after_tax_yield || calculateAfterTaxYield(etf.current_yield, currentTaxRate), 2)}%
                                </div>
                                <small class="text-muted">
                                    ${formatNumber(etf.current_yield, 2)}%
                                </small>
                            </div>` : 
                            '<span class="yield-unknown">N/A</span>'
                        }
                    </td>
                    <td>
                        ${etf.frequency ? 
                            `<span class="badge bg-secondary frequency-badge">${getFrequencyLabel(etf.frequency)}</span>` : 
                            '<span class="badge bg-light text-dark frequency-badge">N/A</span>'
                        }
                    </td>

                    <td>
                        ${etf.last_updated ? 
                            new Date(etf.last_updated).toLocaleString('pl-PL') : 
                            'N/A'
                        }
                    </td>
                    <td>
                        ${etf.dsg && etf.dsg.current_streak !== undefined ? 
                            `<div class="text-center">
                                <div class="badge bg-success text-white frequency-badge">${etf.dsg.current_streak}</div>
                            </div>` : 
                            '<span class="badge bg-light text-dark frequency-badge">N/A</span>'
                        }
                    </td>
                    <td>
                        <div class="text-center">
                            <span class="badge bg-info text-white frequency-badge">
                                ${etf.age !== null ? `${etf.age} lat` : 'N/A'}
                            </span>
                        </div>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="/etf/${etf.ticker}" class="btn btn-outline-primary">
                                <i class="bi bi-eye"></i>
                            </a>
                            <button class="btn btn-outline-danger" onclick="deleteEtf('${etf.ticker}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function filterData() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const frequencyFilter = document.getElementById('frequencyFilter').value;
            const yieldFilter = document.getElementById('yieldFilter').value;
            
            filteredData = etfData.filter(etf => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    etf.ticker.toLowerCase().includes(searchTerm) ||
                    (etf.name && etf.name.toLowerCase().includes(searchTerm));
                
                // Frequency filter
                const matchesFrequency = !frequencyFilter || etf.frequency === frequencyFilter;
                
                // Yield filter
                let matchesYield = true;
                if (yieldFilter && etf.current_yield && etf.current_yield > 0) {
                    switch (yieldFilter) {
                        case 'high': matchesYield = etf.current_yield > 5; break;
                        case 'medium': matchesYield = etf.current_yield >= 2 && etf.current_yield <= 5; break;
                        case 'low': matchesYield = etf.current_yield < 2; break;
                    }
                }
                
                return matchesSearch && matchesFrequency && matchesYield;
            });
            
            renderTable();
        }

        function sortTable(columnIndex, field) {
            const direction = currentSort.column === columnIndex && currentSort.direction === 'asc' ? 'desc' : 'asc';
            
            // Update sort indicators
            document.querySelectorAll('.sort-icon').forEach(icon => icon.classList.remove('active'));
            document.getElementById(`sort-${columnIndex}`).classList.add('active');
            
            // Update sort direction
            currentSort = { column: columnIndex, direction };
            
            // Sort data
            filteredData.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                // Handle null values and N/A cases
                if (aVal === null || aVal === undefined || aVal === 'N/A') aVal = '';
                if (bVal === null || bVal === undefined || bVal === 'N/A') bVal = '';
                
                // Handle numbers
                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return direction === 'asc' ? aVal - bVal : bVal - aVal;
                }
                
                // Handle dates
                if (field === 'last_updated') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }
                
                // Handle DSG sorting
                if (field === 'dsg') {
                    aVal = aVal && aVal.current_streak !== undefined ? aVal.current_streak : 0;
                    bVal = bVal && bVal.current_streak !== undefined ? bVal.current_streak : 0;
                }
                
                // Handle age sorting
                if (field === 'age') {
                    aVal = aVal !== null ? aVal : 0;
                    bVal = bVal !== null ? bVal : 0;
                }
                
                // Handle strings
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    return direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                }
                
                return 0;
            });
            
            renderTable();
        }

        function getYieldClass(yield) {
            if (!yield || yield === null || yield === undefined) return 'unknown';
            if (yield > 5) return 'high';
            if (yield >= 2) return 'medium';
            return 'low';
        }

        function getFrequencyLabel(frequency) {
            if (!frequency || frequency === 'unknown') return 'N/A';
            const labels = {
                'monthly': 'Miesięczne',
                'quarterly': 'Kwartalne',
                'annual': 'Roczne'
            };
            return labels[frequency] || frequency;
        }

        function updateStats() {
            document.getElementById('totalEtfs').textContent = etfData.length;
            
            const lastUpdate = etfData.length > 0 ? 
                new Date(Math.max(...etfData.map(etf => new Date(etf.last_updated || 0)))).toLocaleString('pl-PL') : 
                'N/A';
            document.getElementById('lastUpdate').textContent = lastUpdate;
            
            // Update system status
            updateSystemStatus();
        }

        async function updateSystemStatus() {
            try {
                const response = await fetch('/api/system/status');
                const result = await response.json();
                
                if (result.success) {
                    const status = result.data.scheduler_running ? 'Aktywny' : 'Nieaktywny';
                    document.getElementById('systemStatus').textContent = status;
                }
            } catch (error) {
                document.getElementById('systemStatus').textContent = 'Błąd';
            }
        }

        async function addEtf() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            if (!ticker) {
                showAlert('Wprowadź ticker ETF', 'warning');
                return;
            }
            
            // Show loading state
            const btn = document.getElementById('addEtfBtnText');
            const spinner = document.getElementById('addEtfBtnSpinner');
            btn.classList.add('d-none');
            spinner.classList.remove('d-none');
            
            try {
                const response = await fetch('/api/etfs', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ ticker })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`ETF ${ticker} został dodany pomyślnie!`, 'success');
                    document.getElementById('addEtfModal').querySelector('.btn-close').click();
                    document.getElementById('tickerInput').value = '';
                    loadDashboard(); // Reload data
                } else {
                    showAlert('Błąd podczas dodawania ETF: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('Błąd połączenia: ' + error.message, 'danger');
            } finally {
                // Hide loading state
                btn.classList.remove('d-none');
                spinner.classList.add('d-none');
            }
        }


        
        async function deleteEtf(ticker) {
            if (!confirm(`Czy na pewno chcesz usunąć ETF ${ticker}? Ta operacja usunie wszystkie powiązane dane (ceny, dywidendy) i nie może być cofnięta.`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/etfs/${ticker}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert(`ETF ${ticker} został usunięty wraz z wszystkimi danymi!`, 'success');
                    loadDashboard(); // Reload data
                } else {
                    showAlert('Błąd podczas usuwania: ' + result.error, 'danger');
                }
            } catch (error) {
                showAlert('Błąd połączenia: ' + error.message, 'danger');
            }
        }

        function refreshData() {
            loadDashboard();
        }

        async function refreshFromAPI() {
            const btn = document.getElementById('refreshApiBtn');
            const originalText = btn.innerHTML;
            
            try {
                // Pokazanie stanu loading
                btn.disabled = true;
                btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Aktualizacja w toku...';
                btn.classList.remove('btn-outline-success');
                btn.classList.add('btn-warning');
                
                // Wywołanie API
                const response = await fetch('/api/system/update-all-etfs', {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Sukces - zmiana na zielony
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-success');
                    btn.innerHTML = '<i class="bi bi-check-circle"></i> Zakończono!';
                    
                    showAlert('Aktualizacja wszystkich ETF została uruchomiona! Sprawdź logi w sekcji System Status.', 'success');
                    
                    // Automatyczne odświeżenie dashboard po 3 sekundach
                    setTimeout(() => {
                        loadDashboard();
                        // Przywrócenie oryginalnego wyglądu po 2 sekundach
                        setTimeout(() => {
                            btn.disabled = false;
                            btn.innerHTML = originalText;
                            btn.classList.remove('btn-success');
                            btn.classList.add('btn-outline-success');
                        }, 2000);
                    }, 3000);
                    
                } else {
                    // Błąd - zmiana na czerwony
                    btn.classList.remove('btn-warning');
                    btn.classList.add('btn-danger');
                    btn.innerHTML = '<i class="bi bi-x-circle"></i> Błąd!';
                    
                    showAlert('Błąd podczas aktualizacji: ' + result.error, 'danger');
                    
                    // Przywrócenie oryginalnego wyglądu po 3 sekundach
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                        btn.classList.remove('btn-danger');
                        btn.classList.add('btn-outline-success');
                    }, 3000);
                }
                
            } catch (error) {
                // Błąd połączenia - zmiana na czerwony
                btn.classList.remove('btn-warning');
                btn.classList.add('btn-danger');
                btn.innerHTML = '<i class="bi bi-x-circle"></i> Błąd połączenia!';
                
                showAlert('Błąd połączenia: ' + error.message, 'danger');
                
                // Przywrócenie oryginalnego wyglądu po 3 sekundach
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-success');
                }, 3000);
            }
        }

        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            const table = document.getElementById('etfTable');
            
            if (show) {
                spinner.classList.remove('d-none');
                table.classList.add('loading');
            } else {
                spinner.classList.add('d-none');
                table.classList.remove('loading');
            }
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" id="${alertId}" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            alertContainer.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const alert = document.getElementById(alertId);
                if (alert) {
                    alert.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
