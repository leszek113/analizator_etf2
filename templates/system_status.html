<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status systemu - ETF Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .status-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .system-status-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Back Button -->
    <div class="back-button">
        <a href="/" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Powrót do dashboard
        </a>
    </div>

    <div class="container mt-5 pt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="bi bi-server text-primary"></i>
                    Status systemu ETF Analyzer
                </h1>
                <p class="text-center text-muted mb-5">Monitorowanie stanu systemu, bazy danych i tokenów API</p>
            </div>
        </div>

        <!-- System Status Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card system-status-card">
                    <div class="card-body text-center">
                        <h3 class="card-title">
                            <i class="bi bi-gear-wide-connected"></i>
                            Status systemu
                        </h3>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <h4 class="mb-1">{{ total_etfs }}</h4>
                                <small>ETF w bazie</small>
                            </div>
                            <div class="col-md-3">
                                <h4 class="mb-1">{{ scheduler_status }}</h4>
                                <small>Status schedulera</small>
                            </div>
                            <div class="col-md-3">
                                <h4 class="mb-1">{{ etfs_completeness|length }}</h4>
                                <small>ETF sprawdzonych</small>
                            </div>
                            <div class="col-md-3">
                                <h4 class="mb-1">
                                    {% set complete_count = etfs_completeness|selectattr('prices_complete', 'equalto', true)|selectattr('dividends_complete', 'equalto', true)|list|length %}
                                    {{ complete_count }}
                                </h4>
                                <small>Z kompletną historią</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Combined API Status and Plan Information -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-credit-card"></i>
                            Status tokenów API i plany
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for provider, limits in api_limits.items() %}
                            <div class="col-md-4 mb-3">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h5 class="card-title text-uppercase text-center">{{ provider }}</h5>
                                        
                                        <!-- Plan Information -->
                                        <div class="text-center mb-3">
                                            {% if provider == 'fmp' %}
                                                {% if limits.daily_limit >= 1000 %}
                                                    <span class="badge bg-success">Premium (1000+ calls/day)</span>
                                                {% elif limits.daily_limit >= 500 %}
                                                    <span class="badge bg-warning">Standard (500 calls/day)</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Free (250 calls/day)</span>
                                                {% endif %}
                                            {% elif provider == 'eodhd' %}
                                                {% if limits.daily_limit >= 1000 %}
                                                    <span class="badge bg-success">Premium (1000+ calls/day)</span>
                                                {% elif limits.daily_limit >= 100 %}
                                                    <span class="badge bg-warning">Standard (100 calls/day)</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Free (100 calls/day)</span>
                                                {% endif %}
                                            {% elif provider == 'tiingo' %}
                                                {% if limits.daily_limit >= 1000 %}
                                                    <span class="badge bg-success">Premium (1000+ calls/day)</span>
                                                {% elif limits.daily_limit >= 50 %}
                                                    <span class="badge bg-warning">Standard (50 calls/day)</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Free (50 calls/day)</span>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Usage Information -->
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                Użyto: {{ limits.current_usage }}/{{ limits.daily_limit }}
                                            </small>
                                            <div class="progress mt-1" style="height: 8px;">
                                                {% set percentage = (limits.current_usage / limits.daily_limit * 100) | round %}
                                                {% if percentage < 50 %}
                                                    <div class="progress-bar bg-success" style="width: {{ percentage }}%"></div>
                                                {% elif percentage < 80 %}
                                                    <div class="progress-bar bg-warning" style="width: {{ percentage }}%"></div>
                                                {% else %}
                                                    <div class="progress-bar bg-danger" style="width: {{ percentage }}%"></div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Reset Information -->
                                        <div class="text-center">
                                            <small class="text-muted">
                                                <i class="bi bi-clock"></i>
                                                Reset za: {{ "%.1f"|format(limits.hours_until_reset) }}h
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- API Capabilities Info -->
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                <strong>Free plan:</strong> 5 lat historii | <strong>Premium plan:</strong> 15+ lat historii + więcej wywołań
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Completeness Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-database-check"></i>
                            Kompletność danych historycznych
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ETF</th>
                                        <th>Wiek ETF</th>
                                        <th>Oczekiwane lata</th>
                                        <th>Ceny</th>
                                        <th>Dywidendy</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for etf in etfs_completeness %}
                                    <tr>
                                        <td><strong>{{ etf.ticker }}</strong></td>
                                        <td>{{ "%.1f"|format(etf.etf_age_years) }} lat</td>
                                        <td>{{ etf.expected_years }} lat</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if etf.prices_complete %}
                                                    <span class="badge bg-success me-2">✓</span>
                                                {% else %}
                                                    <span class="badge bg-warning me-2">⚠</span>
                                                {% endif %}
                                                <small>{{ "%.1f"|format(etf.years_of_price_data) }} lat</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if etf.dividends_complete %}
                                                    <span class="badge bg-success me-2">✓</span>
                                                {% else %}
                                                    <span class="badge bg-warning me-2">⚠</span>
                                                {% endif %}
                                                <small>{{ "%.1f"|format(etf.years_of_dividend_data) }} lat</small>
                                            </div>
                                        </td>
                                        <td>
                                            {% if etf.prices_complete and etf.dividends_complete %}
                                                <span class="badge bg-success">Kompletne</span>
                                            {% elif etf.prices_complete or etf.dividends_complete %}
                                                <span class="badge bg-warning">Częściowo</span>
                                            {% else %}
                                                <span class="badge bg-danger">Brakuje</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                System sprawdza kompletność danych względem rzeczywistego wieku ETF. 
                                ETF młodszy niż 15 lat jest "kompletny" jeśli ma dane od momentu powstania.
                                System automatycznie uzupełnia brakujące dane historyczne raz dziennie o 09:00 UTC.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Zaplanowane zadania w tle -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-clock-history"></i>
                            Zaplanowane zadania w tle
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Status schedulera:</h6>
                                <div class="d-flex align-items-center mb-3">
                                    <span class="badge bg-success me-2">Aktywny</span>
                                    <small class="text-muted">Ostatnie uruchomienie: {{ scheduler_status }}</small>
                                </div>
                                
                                <h6>Zaplanowane zadania:</h6>
                                <div id="scheduledJobs">
                                    <div class="job-item mb-2 p-2 border rounded">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>Poniedziałek-piątek o 5:00 CET</strong><br>
                                                <small class="text-muted">Aktualizacja wszystkich ETF</small>
                                            </div>
                                            <span class="badge bg-success">Aktywne</span>
                                        </div>
                                    </div>
                                    <div class="job-item mb-2 p-2 border rounded">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>Co 15 min (pon-piątek 13:00-23:00 CET)</strong><br>
                                                <small class="text-muted">Aktualizacja cen ETF</small>
                                            </div>
                                            <span class="badge bg-success">Aktywne</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="bi bi-lightbulb"></i>
                                        <strong>Tip:</strong> Scheduler automatycznie zarządza danymi. 
                                        <br><strong>"Aktualizacja wszystkich ETF":</strong> Sprawdza nowe dywidendy, ceny i uzupełnia brakującą historię
                                        <br><strong>"Aktualizacja cen ETF":</strong> Aktualizuje tylko ceny co 15 min w dni robocze
                                        <br><strong>Strefa czasowa:</strong> Wszystkie czasy wyświetlane w CET (czas polski)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logi i status zadań wykonanych w tle -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="bi bi-list-check"></i>
                            Logi i status zadań wykonanych w tle
                        </h4>
                        <button class="btn btn-outline-light btn-sm" onclick="refreshAllJobLogs()">
                            <i class="bi bi-arrow-clockwise"></i> Odśwież wszystkie logi
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Tabela 1: Aktualizacja wszystkich ETF -->
                        <div class="mb-4">
                            <h5 class="text-primary">
                                <i class="bi bi-arrow-repeat"></i>
                                Aktualizacja wszystkich ETF
                                <small class="text-muted">(Historia: 3 miesiące)</small>
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-hover table-sm" id="updateAllEtfsTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Data i godzina (CET)</th>
                                            <th>Status</th>
                                            <th>Czas wykonania</th>
                                            <th>ETF zaktualizowane</th>
                                            <th>Ceny uzupełnione</th>
                                            <th>Dywidendy uzupełnione</th>
                                            <th>Wywołania API</th>
                                            <th>Szczegóły</th>
                                        </tr>
                                    </thead>
                                    <tbody id="updateAllEtfsBody" style="max-height: 200px; overflow-y: auto;">
                                        <!-- Dynamicznie wypełniane przez JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted">Wyświetlanie: 5 wierszy + scroll (ostatnie 20 wykonań)</small>
                            </div>
                        </div>

                        <!-- Tabela 2: Aktualizacja cen ETF -->
                        <div class="mb-4">
                            <h5 class="text-success">
                                <i class="bi bi-graph-up"></i>
                                Aktualizacja cen ETF
                                <small class="text-muted">(Historia: 2 tygodnie)</small>
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-hover table-sm" id="updateEtfPricesTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Data i godzina (CET)</th>
                                            <th>Status</th>
                                            <th>Czas wykonania</th>
                                            <th>Ceny zaktualizowane</th>
                                            <th>ETF z błędami</th>
                                            <th>Szczegóły</th>
                                        </tr>
                                    </thead>
                                    <tbody id="updateEtfPricesBody" style="max-height: 200px; overflow-y: auto;">
                                        <!-- Dynamicznie wypełniane przez JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted">Wyświetlanie: 5 wierszy + scroll (ostatnie 20 wykonań)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-secondary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-info-circle"></i>
                            Informacje o systemie
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Inteligentne uzupełnianie historii:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle text-success"></i> Poniedziałek-piątek o 5:00 CET (czas polski)</li>
                                    <li><i class="bi bi-check-circle text-success"></i> Sprawdza kompletność względem wieku ETF</li>
                                    <li><i class="bi bi-check-circle text-success"></i> Uzupełnia brakujące dane</li>
                                    <li><i class="bi bi-check-circle text-success"></i> Oszczędza tokeny API</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Strategia pobierania:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-arrow-up-circle text-primary"></i> Nowe ceny: co 7 dni</li>
                                    <li><i class="bi bi-arrow-up-circle text-primary"></i> Nowe dywidendy: co 30 dni</li>
                                    <li><i class="bi bi-arrow-up-circle text-primary"></i> Historia: tylko brakujące</li>
                                    <li><i class="bi bi-arrow-up-circle text-primary"></i> Cache: maksymalne wykorzystanie</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Funkcje do zarządzania schedulerem
        function runSchedulerJob() {
            if (confirm('Czy na pewno chcesz uruchomić zadanie schedulera teraz? To może zająć kilka minut.')) {
                // Użyj istniejącego endpointu do aktualizacji zadania
                fetch('/api/system/scheduler/update-job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        job_id: 'create_app.<locals>.update_all_etfs',
                        hour: 9,
                        minute: 0
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Zadanie zostało uruchomione! Sprawdź logi w terminalu.');
                        location.reload(); // Odśwież stronę
                    } else {
                        alert('Błąd: ' + (data.error || 'Nie udało się uruchomić zadania'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Błąd komunikacji z serwerem');
                });
            }
        }
        
        function checkSchedulerStatus() {
            // Pokaż prosty status bez API call
            let status = 'Status schedulera:\n';
            status += '- Status: Aktywny\n';
            status += '- Zadanie: Aktualizacja wszystkich ETF\n';
            status += '- Czas: Poniedziałek-piątek o 5:00 CET (czas polski)\n';
            status += '- Ostatnie uruchomienie: ' + (new Date().toLocaleString('pl-PL')) + '\n';
            status += '- Następne uruchomienie: Jutro o 5:00 CET';
            alert(status);
        }
        
        function viewSchedulerLogs() {
            alert('Logi schedulera są wyświetlane w terminalu gdzie uruchomiona jest aplikacja.\n\n' +
                  'Możesz też sprawdzić logi w przeglądarce na stronie /system/status - ' +
                  'tam zobaczysz aktualny status i kompletność danych.');
        }
        
        function updateSchedulerTime() {
            const hour = document.getElementById('schedulerHour').value;
            const minute = document.getElementById('schedulerMinute').value;
            
            if (hour === '' || minute === '' || hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                alert('Podaj poprawną godzinę (0-23) i minutę (0-59).');
                return;
            }
            
            if (confirm(`Czy na pewno chcesz zmienić czas wykonania zadania na ${hour.padStart(2, '0')}:${minute.padStart(2, '0')} UTC?`)) {
                fetch('/api/system/scheduler/update-job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        job_id: 'create_app.<locals>.update_all_etfs',
                        hour: parseInt(hour),
                        minute: parseInt(minute)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Czas wykonania zadania został zmieniony na ${hour.padStart(2, '0')}:${minute.padStart(2, '0')} UTC!\n\nNastępne uruchomienie: ${data.next_run || 'sprawdź status'}`);
                        location.reload(); // Odśwież stronę
                    } else {
                        alert('Błąd: ' + (data.error || 'Nie udało się zmienić czasu wykonania'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Błąd komunikacji z serwerem');
                });
            }
        }
        
        // Funkcje do zarządzania logami zadań schedulera
        function refreshAllJobLogs() {
            refreshUpdateAllEtfsLogs();
            refreshUpdateEtfPricesLogs();
        }
        
        function refreshUpdateAllEtfsLogs() {
            fetch('/api/system/job-logs/update_all_etfs')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateUpdateAllEtfsTable(data.logs);
                    } else {
                        console.error('Błąd pobierania logów update_all_etfs:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        function refreshUpdateEtfPricesLogs() {
            fetch('/api/system/job-logs/update_etf_prices')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateUpdateEtfPricesTable(data.logs);
                    } else {
                        console.error('Błąd pobierania logów update_etf_prices:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        function populateUpdateAllEtfsTable(logs) {
            const tbody = document.getElementById('updateAllEtfsBody');
            tbody.innerHTML = '';
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Brak logów dla tego zadania</td></tr>';
                return;
            }
            
            logs.forEach(log => {
                const row = document.createElement('tr');
                const timestamp = new Date(log.timestamp).toLocaleString('pl-PL');
                const status = log.success ? 
                    '<span class="badge bg-success">✅ Sukces</span>' : 
                    '<span class="badge bg-danger">❌ Błąd</span>';
                const executionTime = log.execution_time_ms ? `${log.execution_time_ms}ms` : 'N/A';
                
                // Parsowanie metadanych
                let etfsUpdated = 'N/A';
                let pricesFilled = 'N/A';
                let dividendsFilled = 'N/A';
                let apiCallsUsed = 'N/A';
                
                if (log.metadata) {
                    etfsUpdated = log.metadata.etfs_updated || 'N/A';
                    pricesFilled = log.metadata.prices_filled || 'N/A';
                    dividendsFilled = log.metadata.dividends_filled || 'N/A';
                    apiCallsUsed = log.metadata.api_calls_used || 'N/A';
                }
                
                row.innerHTML = `
                    <td><small>${timestamp}</small></td>
                    <td>${status}</td>
                    <td><small>${executionTime}</small></td>
                    <td><small>${etfsUpdated}</small></td>
                    <td><small>${pricesFilled}</small></td>
                    <td><small>${dividendsFilled}</small></td>
                    <td><small>${apiCallsUsed}</small></td>
                    <td>
                        <button class="btn btn-outline-info btn-sm" onclick="showJobDetails('${log.id}', 'update_all_etfs')">
                            <i class="bi bi-info-circle"></i> Szczegóły
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function populateUpdateEtfPricesTable(logs) {
            const tbody = document.getElementById('updateEtfPricesBody');
            tbody.innerHTML = '';
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Brak logów dla tego zadania</td></tr>';
                return;
            }
            
            logs.forEach(log => {
                const row = document.createElement('tr');
                const timestamp = new Date(log.timestamp).toLocaleString('pl-PL');
                const status = log.success ? 
                    '<span class="badge bg-success">✅ Sukces</span>' : 
                    '<span class="badge bg-danger">❌ Błąd</span>';
                const executionTime = log.execution_time_ms ? `${log.execution_time_ms}ms` : 'N/A';
                
                // Parsowanie metadanych
                let etfsUpdated = 'N/A';
                let errors = 'N/A';
                
                if (log.metadata) {
                    etfsUpdated = log.metadata.etfs_updated || 'N/A';
                    errors = log.metadata.errors || '0';
                }
                
                row.innerHTML = `
                    <td><small>${timestamp}</small></td>
                    <td>${status}</td>
                    <td><small>${executionTime}</small></td>
                    <td><small>${etfsUpdated}</small></td>
                    <td><small>${errors}</small></td>
                    <td>
                        <button class="btn btn-outline-info btn-sm" onclick="showJobDetails('${log.id}', 'update_etf_prices')">
                            <i class="bi bi-info-circle"></i> Szczegóły
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function showJobDetails(logId, jobType) {
            // Pobierz szczegóły zadania z bazy danych
            fetch(`/api/system/job-logs?job_name=${jobType}&limit=1`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.logs.length > 0) {
                        const log = data.logs.find(l => l.id == logId);
                        if (log) {
                            displayJobDetailsModal(log);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        function displayJobDetailsModal(log) {
            const details = log.details || 'Brak szczegółów';
            const errorMessage = log.error_message || 'Brak';
            const metadata = log.metadata ? JSON.stringify(log.metadata, null, 2) : 'Brak';
            
            const modalContent = `
                <div class="modal fade" id="jobDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Szczegóły zadania: ${log.job_name}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Podstawowe informacje:</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>Status:</strong> ${log.success ? '✅ Sukces' : '❌ Błąd'}</li>
                                            <li><strong>Data:</strong> ${new Date(log.timestamp).toLocaleString('pl-PL')}</li>
                                            <li><strong>Czas wykonania:</strong> ${log.execution_time_ms || 'N/A'}ms</li>
                                            <li><strong>Rekordy:</strong> ${log.records_processed || 'N/A'}</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Szczegóły:</h6>
                                        <p class="text-muted">${details}</p>
                                        ${log.error_message ? `<h6>Błąd:</h6><p class="text-danger">${errorMessage}</p>` : ''}
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h6>Metadane:</h6>
                                        <pre class="bg-light p-2 rounded"><code>${metadata}</code></pre>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Usuń istniejący modal jeśli istnieje
            const existingModal = document.getElementById('jobDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Dodaj nowy modal do body
            document.body.insertAdjacentHTML('beforeend', modalContent);
            
            // Pokaż modal
            const modal = new bootstrap.Modal(document.getElementById('jobDetailsModal'));
            modal.show();
        }
        
        // Inicjalizacja przy ładowaniu strony
        document.addEventListener('DOMContentLoaded', function() {
            // Załaduj logi zadań przy starcie
            refreshAllJobLogs();
        });
    </script>
</body>
</html>
