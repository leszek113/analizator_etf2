<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status systemu - ETF Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .status-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .system-status-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
        
        /* Poprawka dla Bootstrap - zachowanie uk≈Çadu tabeli */
        .table-scroll thead {
            background: #343a40;
            color: white;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Back Button -->
    <div class="back-button">
        <a href="/" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Powr√≥t do dashboard
        </a>
    </div>

    <div class="container mt-5 pt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="bi bi-server text-primary"></i>
                    Status systemu ETF Analyzer
                </h1>
                <p class="text-center text-muted mb-5">Monitorowanie stanu systemu, bazy danych i token√≥w API</p>
            </div>
        </div>

        <!-- System Status Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card system-status-card">
                    <div class="card-body text-center">
                        <h3 class="card-title">
                            <i class="bi bi-gear-wide-connected"></i>
                            Status systemu
                        </h3>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <h4 class="mb-1">{{ total_etfs }}</h4>
                                <small>ETF w bazie</small>
                            </div>
                            <div class="col-md-3">
                                <h4 class="mb-1">{{ scheduler_status }}</h4>
                                <small>Status schedulera</small>
                            </div>
                            <div class="col-md-3">
                                <h4 class="mb-1">{{ etfs_completeness|length }}</h4>
                                <small>ETF sprawdzonych</small>
                            </div>
                            <div class="col-md-3">
                                <h4 class="mb-1">
                                    {% set complete_count = etfs_completeness|selectattr('prices_complete', 'equalto', true)|selectattr('dividends_complete', 'equalto', true)|list|length %}
                                    {{ complete_count }}
                                </h4>
                                <small>Z kompletnƒÖ historiƒÖ</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Combined API Status and Plan Information -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-credit-card"></i>
                            Status token√≥w API i plany
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for provider, limits in api_limits.items() %}
                            <div class="col-md-4 mb-3">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h5 class="card-title text-uppercase text-center">{{ provider }}</h5>
                                        
                                        <!-- Plan Information -->
                                        <div class="text-center mb-3">
                                            {% if provider == 'fmp' %}
                                                {% if limits.daily_limit >= 1000 %}
                                                    <span class="badge bg-success">Premium (1000+ calls/day)</span>
                                                {% elif limits.daily_limit >= 500 %}
                                                    <span class="badge bg-warning">Standard (500 calls/day)</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Free (250 calls/day)</span>
                                                {% endif %}
                                            {% elif provider == 'eodhd' %}
                                                {% if limits.daily_limit >= 1000 %}
                                                    <span class="badge bg-success">Premium (1000+ calls/day)</span>
                                                {% elif limits.daily_limit >= 100 %}
                                                    <span class="badge bg-warning">Standard (100 calls/day)</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Free (100 calls/day)</span>
                                                {% endif %}
                                            {% elif provider == 'tiingo' %}
                                                {% if limits.daily_limit >= 1000 %}
                                                    <span class="badge bg-success">Premium (1000+ calls/day)</span>
                                                {% elif limits.daily_limit >= 50 %}
                                                    <span class="badge bg-warning">Standard (50 calls/day)</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Free (50 calls/day)</span>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Usage Information -->
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                U≈ºyto: {{ limits.current_usage }}/{{ limits.daily_limit }}
                                            </small>
                                            <div class="progress mt-1" style="height: 8px;">
                                                {% set percentage = (limits.current_usage / limits.daily_limit * 100) | round %}
                                                {% if percentage < 50 %}
                                                    <div class="progress-bar bg-success" style="width: {{ percentage }}%"></div>
                                                {% elif percentage < 80 %}
                                                    <div class="progress-bar bg-warning" style="width: {{ percentage }}%"></div>
                                                {% else %}
                                                    <div class="progress-bar bg-danger" style="width: {{ percentage }}%"></div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Reset Information -->
                                        <div class="text-center">
                                            <small class="text-muted">
                                                <i class="bi bi-clock"></i>
                                                Reset za: {{ "%.1f"|format(limits.hours_until_reset) }}h
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- API Capabilities Info -->
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                <strong>Free plan:</strong> 5 lat historii | <strong>Premium plan:</strong> 15+ lat historii + wiƒôcej wywo≈Ça≈Ñ
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Completeness Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-database-check"></i>
                            Kompletno≈õƒá danych historycznych
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ETF</th>
                                        <th>Wiek ETF</th>
                                        <th>Oczekiwane lata</th>
                                        <th>Ceny</th>
                                        <th>Dywidendy</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for etf in etfs_completeness %}
                                    <tr>
                                        <td><strong>{{ etf.ticker }}</strong></td>
                                        <td>{{ "%.1f"|format(etf.etf_age_years) }} lat</td>
                                        <td>{{ etf.expected_years }} lat</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if etf.prices_complete %}
                                                    <span class="badge bg-success me-2">‚úì</span>
                                                {% else %}
                                                    <span class="badge bg-warning me-2">‚ö†</span>
                                                {% endif %}
                                                <small>{{ "%.1f"|format(etf.years_of_price_data) }} lat</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if etf.dividends_complete %}
                                                    <span class="badge bg-success me-2">‚úì</span>
                                                {% else %}
                                                    <span class="badge bg-warning me-2">‚ö†</span>
                                                {% endif %}
                                                <small>{{ "%.1f"|format(etf.years_of_dividend_data) }} lat</small>
                                            </div>
                                        </td>
                                        <td>
                                            {% if etf.prices_complete and etf.dividends_complete %}
                                                <span class="badge bg-success">Kompletne</span>
                                            {% elif etf.prices_complete or etf.dividends_complete %}
                                                <span class="badge bg-warning">Czƒô≈õciowo</span>
                                            {% else %}
                                                <span class="badge bg-danger">Brakuje</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                System sprawdza kompletno≈õƒá danych wzglƒôdem rzeczywistego wieku ETF. 
                                ETF m≈Çodszy ni≈º 15 lat jest "kompletny" je≈õli ma dane od momentu powstania.
                                System automatycznie uzupe≈Çnia brakujƒÖce dane historyczne raz dziennie o 09:00 UTC.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Zaplanowane zadania w tle -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-clock-history"></i>
                            Zaplanowane zadania w tle
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Status schedulera:</h6>
                                <div class="d-flex align-items-center mb-3">
                                    <span class="badge bg-success me-2">Aktywny</span>
                                    <small class="text-muted">Ostatnie uruchomienie: {{ scheduler_status }}</small>
                                </div>
                                
                                <h6>Zaplanowane zadania:</h6>
                                <div id="scheduledJobs">
                                    <div class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">≈Åadowanie...</span>
                                        </div>
                                        <p class="mt-2">≈Åadowanie zada≈Ñ schedulera...</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mt-3">
                                    <small class="text-muted">
                                        <i class="bi bi-lightbulb"></i>
                                        <strong>Tip:</strong> Scheduler automatycznie zarzƒÖdza danymi. 
                                        <br><strong>"Aktualizacja wszystkich ETF":</strong> Sprawdza nowe dywidendy, ceny i uzupe≈Çnia brakujƒÖcƒÖ historiƒô
                                        <br><strong>"Aktualizacja cen ETF":</strong> Aktualizuje tylko ceny co 15 min w dni robocze
                                        <br><strong>Strefa czasowa:</strong> Wszystkie czasy wy≈õwietlane w CET (czas polski)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logi i status zada≈Ñ wykonanych w tle -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="bi bi-list-check"></i>
                            Logi i status zada≈Ñ wykonanych w tle
                        </h4>
                        <button class="btn btn-outline-light btn-sm" onclick="refreshAllJobLogs()">
                            <i class="bi bi-arrow-clockwise"></i> Od≈õwie≈º wszystkie logi
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Tabela 1: Aktualizacja wszystkich ETF -->
                        <div class="mb-4">
                            <h5 class="text-primary">
                                <i class="bi bi-arrow-repeat"></i>
                                Aktualizacja wszystkich ETF
                                <small class="text-muted">(Historia: 3 miesiƒÖce)</small>
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-hover table-sm table-scroll" id="updateAllEtfsTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Data i godzina (CET)</th>
                                            <th>Status</th>
                                            <th>Czas wykonania</th>
                                            <th>ETF zaktualizowane</th>
                                            <th>Ceny uzupe≈Çnione</th>
                                            <th>Dywidendy uzupe≈Çnione</th>
                                            <th>Wywo≈Çania API</th>
                                            <th>Szczeg√≥≈Çy</th>
                                        </tr>
                                    </thead>
                                    <tbody id="updateAllEtfsBody">
                                        <!-- Dynamicznie wype≈Çniane przez JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted update-all-etfs-info">Wy≈õwietlanie: 5 wierszy + scroll (ostatnie 20 wykona≈Ñ)</small>
                            </div>
                        </div>

                        <!-- Tabela 2: Aktualizacja cen ETF -->
                        <div class="mb-4">
                            <h5 class="text-success">
                                <i class="bi bi-graph-up"></i>
                                Aktualizacja cen ETF
                                <small class="text-muted">(Historia: 2 tygodnie)</small>
                            </h5>
                            <div class="table-responsive">
                                <table class="table table-hover table-sm table-scroll" id="updateEtfPricesTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Data i godzina (CET)</th>
                                            <th>Status</th>
                                            <th>Czas wykonania</th>
                                            <th>Ceny zaktualizowane</th>
                                            <th>ETF z b≈Çƒôdami</th>
                                            <th>Szczeg√≥≈Çy</th>
                                        </tr>
                                    </thead>
                                    <tbody id="updateEtfPricesBody">
                                        <!-- Dynamicznie wype≈Çniane przez JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted update-etf-prices-info">Wy≈õwietlanie: 5 wierszy + scroll (ostatnie 20 wykona≈Ñ)</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-secondary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-info-circle"></i>
                            Informacje o systemie
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Inteligentne uzupe≈Çnianie historii:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle text-success"></i> Poniedzia≈Çek-piƒÖtek o 23:50 CET (czas polski)</li>
                                    <li><i class="bi bi-check-circle text-success"></i> Sprawdza kompletno≈õƒá wzglƒôdem wieku ETF</li>
                                    <li><i class="bi bi-check-circle text-success"></i> Uzupe≈Çnia brakujƒÖce dane</li>
                                    <li><i class="bi bi-check-circle text-success"></i> Oszczƒôdza tokeny API</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Strategia pobierania:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-arrow-up-circle text-primary"></i> Nowe ceny: co 7 dni</li>
                                    <li><i class="bi bi-arrow-up-circle text-primary"></i> Nowe dywidendy: co 30 dni</li>
                                    <li><i class="bi bi-arrow-up-circle text-primary"></i> Historia: tylko brakujƒÖce</li>
                                    <li><i class="bi bi-arrow-up-circle text-primary"></i> Cache: maksymalne wykorzystanie</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Funkcje do zarzƒÖdzania schedulerem
        function runSchedulerJob() {
            if (confirm('Czy na pewno chcesz uruchomiƒá zadanie schedulera teraz? To mo≈ºe zajƒÖƒá kilka minut.')) {
                // U≈ºyj istniejƒÖcego endpointu do aktualizacji zadania
                fetch('/api/system/scheduler/update-job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        job_id: 'create_app.<locals>.update_all_timeframes',
                        hour: 9,
                        minute: 0
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Zadanie zosta≈Ço uruchomione! Sprawd≈∫ logi w terminalu.');
                        location.reload(); // Od≈õwie≈º stronƒô
                    } else {
                        alert('B≈ÇƒÖd: ' + (data.error || 'Nie uda≈Ço siƒô uruchomiƒá zadania'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('B≈ÇƒÖd komunikacji z serwerem');
                });
            }
        }
        
        function checkSchedulerStatus() {
            // Poka≈º prosty status bez API call
            let status = 'Status schedulera:\n';
            status += '- Status: Aktywny\n';
            status += '- Zadanie: Aktualizacja wszystkich ram czasowych (1M, 1W, 1D)\n';
            status += '- Czas: Poniedzia≈Çek-piƒÖtek o 23:50 CET (czas polski)\n';
            status += '- Ostatnie uruchomienie: ' + (new Date().toLocaleString('pl-PL')) + '\n';
            status += '- Nastƒôpne uruchomienie: Jutro o 23:50 CET';
            alert(status);
        }
        
        function viewSchedulerLogs() {
            alert('Logi schedulera sƒÖ wy≈õwietlane w terminalu gdzie uruchomiona jest aplikacja.\n\n' +
                  'Mo≈ºesz te≈º sprawdziƒá logi w przeglƒÖdarce na stronie /system/status - ' +
                  'tam zobaczysz aktualny status i kompletno≈õƒá danych.');
        }
        
        function updateSchedulerTime() {
            const hour = document.getElementById('schedulerHour').value;
            const minute = document.getElementById('schedulerMinute').value;
            
            if (hour === '' || minute === '' || hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                alert('Podaj poprawnƒÖ godzinƒô (0-23) i minutƒô (0-59).');
                return;
            }
            
            if (confirm(`Czy na pewno chcesz zmieniƒá czas wykonania zadania na ${hour.padStart(2, '0')}:${minute.padStart(2, '0')} UTC?`)) {
                fetch('/api/system/scheduler/update-job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        job_id: 'create_app.<locals>.update_all_timeframes',
                        hour: parseInt(hour),
                        minute: parseInt(minute)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Czas wykonania zadania zosta≈Ç zmieniony na ${hour.padStart(2, '0')}:${minute.padStart(2, '0')} UTC!\n\nNastƒôpne uruchomienie: ${data.next_run || 'sprawd≈∫ status'}`);
                        location.reload(); // Od≈õwie≈º stronƒô
                    } else {
                        alert('B≈ÇƒÖd: ' + (data.error || 'Nie uda≈Ço siƒô zmieniƒá czasu wykonania'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('B≈ÇƒÖd komunikacji z serwerem');
                });
            }
        }
        
        // Funkcje do zarzƒÖdzania logami zada≈Ñ schedulera
        function refreshAllJobLogs() {
            refreshUpdateAllEtfsLogs();
            refreshUpdateEtfPricesLogs();
        }
        
        // Funkcja do ≈Çadowania zada≈Ñ schedulera
        function loadSchedulerJobs() {
            console.log('üîÑ ≈Åadowanie zada≈Ñ schedulera...');
            fetch('/api/system/scheduler/jobs')
                .then(response => response.json())
                .then(data => {
                    console.log('üìä Otrzymane zadania:', data);
                    if (data.success) {
                        displaySchedulerJobs(data.jobs);
                    } else {
                        console.error('‚ùå B≈ÇƒÖd ≈Çadowania zada≈Ñ:', data.error);
                        document.getElementById('scheduledJobs').innerHTML = 
                            '<div class="alert alert-danger">B≈ÇƒÖd ≈Çadowania zada≈Ñ schedulera: ' + data.error + '</div>';
                    }
                })
                .catch(error => {
                    console.error('‚ùå B≈ÇƒÖd komunikacji:', error);
                    document.getElementById('scheduledJobs').innerHTML = 
                        '<div class="alert alert-danger">B≈ÇƒÖd komunikacji z serwerem</div>';
                });
        }
        
        // Funkcja do wy≈õwietlania zada≈Ñ schedulera
        function displaySchedulerJobs(jobs) {
            const container = document.getElementById('scheduledJobs');
            
            if (!jobs || jobs.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">Brak aktywnych zada≈Ñ schedulera</div>';
                return;
            }
            
            let html = '';
            jobs.forEach(job => {
                const nextRun = job.next_run ? new Date(job.next_run).toLocaleString('pl-PL', {
                    timeZone: 'Europe/Warsaw',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Nie zaplanowane';
                
                html += `
                    <div class="job-item mb-2 p-2 border rounded">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${job.trigger}</strong><br>
                                <small class="text-muted">${job.name}</small><br>
                                <small class="text-info">Nastƒôpne uruchomienie: ${nextRun}</small>
                            </div>
                            <span class="badge bg-success">Aktywne</span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function refreshUpdateAllEtfsLogs() {
            console.log('üîÑ ≈Åadowanie log√≥w update_all_timeframes...');
            fetch('/api/system/job-logs?job_name=update_all_timeframes&limit=50')
                .then(response => response.json())
                .then(data => {
                    console.log('üìä Otrzymane dane:', data);
                    if (data.success) {
                        console.log(`‚úÖ Znaleziono ${data.logs.length} log√≥w`);
                        populateUpdateAllEtfsTable(data.logs);
                    } else {
                        console.error('‚ùå B≈ÇƒÖd pobierania log√≥w update_all_timeframes:', data.error);
                    }
                })
                .catch(error => {
                    console.error('‚ùå Error:', error);
                });
        }
        
        function refreshUpdateEtfPricesLogs() {
            fetch('/api/system/job-logs?job_name=update_etf_prices&limit=50')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateUpdateEtfPricesTable(data.logs);
                    } else {
                        console.error('B≈ÇƒÖd pobierania log√≥w update_etf_prices:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
        
        function populateUpdateAllEtfsTable(logs) {
            console.log('üìã Wype≈Çnianie tabeli updateAllEtfsBody z', logs.length, 'logami');
            const tbody = document.getElementById('updateAllEtfsBody');
            if (!tbody) {
                console.error('‚ùå Nie znaleziono elementu updateAllEtfsBody!');
                return;
            }
            console.log('‚úÖ Znaleziono element updateAllEtfsBody:', tbody);
            tbody.innerHTML = '';
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Brak log√≥w dla tego zadania</td></tr>';
                return;
            }
            
            // Ograniczenie do 10 ostatnich wywo≈Ça≈Ñ
            const displayLogs = logs.slice(0, 10);
            const totalLogs = logs.length;
            
            displayLogs.forEach(log => {
                const row = document.createElement('tr');
                const timestamp = new Date(log.timestamp).toLocaleString('pl-PL');
                const status = log.success ? 
                    '<span class="badge bg-success">‚úÖ Sukces</span>' : 
                    '<span class="badge bg-danger">‚ùå B≈ÇƒÖd</span>';
                const executionTime = log.execution_time_ms ? `${log.execution_time_ms}ms` : 'N/A';
                
                // Parsowanie metadanych
                let etfsUpdated = 'N/A';
                let pricesFilled = 'N/A';
                let dividendsFilled = 'N/A';
                let apiCallsUsed = 'N/A';
                
                if (log.metadata) {
                    etfsUpdated = log.metadata.etfs_updated || 'N/A';
                    pricesFilled = log.metadata.prices_filled || 'N/A';
                    dividendsFilled = log.metadata.dividends_filled || 'N/A';
                    apiCallsUsed = log.metadata.api_calls_used || 'N/A';
                }
                
                row.innerHTML = `
                    <td><small>${timestamp}</small></td>
                    <td>${status}</td>
                    <td><small>${executionTime}</small></td>
                    <td><small>${etfsUpdated}</small></td>
                    <td><small>${pricesFilled}</small></td>
                    <td><small>${dividendsFilled}</small></td>
                    <td><small>${apiCallsUsed}</small></td>
                    <td>
                        <button class="btn btn-outline-info btn-sm" onclick="showJobDetails('${log.id}', 'update_all_timeframes')">
                            <i class="bi bi-info-circle"></i> Szczeg√≥≈Çy
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Aktualizacja informacji o wy≈õwietlaniu
            const infoElement = document.querySelector('.update-all-etfs-info');
            if (infoElement) {
                infoElement.textContent = `Wy≈õwietlanie: 10 ostatnich wywo≈Ça≈Ñ (z ${totalLogs} dostƒôpnych)`;
            }
        }
        
        function populateUpdateEtfPricesTable(logs) {
            const tbody = document.getElementById('updateEtfPricesBody');
            tbody.innerHTML = '';
            
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Brak log√≥w dla tego zadania</td></tr>';
                return;
            }
            
            // Ograniczenie do 10 ostatnich wywo≈Ça≈Ñ
            const displayLogs = logs.slice(0, 10);
            const totalLogs = logs.length;
            
            displayLogs.forEach(log => {
                const row = document.createElement('tr');
                const timestamp = new Date(log.timestamp).toLocaleString('pl-PL');
                const status = log.success ? 
                    '<span class="badge bg-success">‚úÖ Sukces</span>' : 
                    '<span class="badge bg-danger">‚ùå B≈ÇƒÖd</span>';
                const executionTime = log.execution_time_ms ? `${log.execution_time_ms}ms` : 'N/A';
                
                // Parsowanie metadanych
                let etfsUpdated = 'N/A';
                let errors = 'N/A';
                
                if (log.metadata) {
                    etfsUpdated = log.metadata.etfs_updated || 'N/A';
                    errors = log.metadata.errors || '0';
                }
                
                row.innerHTML = `
                    <td><small>${timestamp}</small></td>
                    <td>${status}</td>
                    <td><small>${executionTime}</small></td>
                    <td><small>${etfsUpdated}</small></td>
                    <td><small>${errors}</small></td>
                    <td>
                        <button class="btn btn-outline-info btn-sm" onclick="showJobDetails('${log.id}', 'update_etf_prices')">
                            <i class="bi bi-info-circle"></i> Szczeg√≥≈Çy
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Aktualizacja informacji o wy≈õwietlaniu
            const infoElement = document.querySelector('.update-etf-prices-info');
            if (infoElement) {
                infoElement.textContent = `Wy≈õwietlanie: 10 ostatnich wywo≈Ça≈Ñ (z ${totalLogs} dostƒôpnych)`;
            }
        }
        
        function showJobDetails(logId, jobType) {
            // Pobierz szczeg√≥≈Çy zadania z bazy danych
            fetch(`/api/system/job-logs?job_name=${jobType}&limit=100`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.logs.length > 0) {
                        const log = data.logs.find(l => l.id == logId);
                        if (log) {
                            displayJobDetailsModal(log);
                        } else {
                            console.error('Log not found for ID:', logId);
                            alert('Nie znaleziono szczeg√≥≈Ç√≥w dla tego zadania');
                        }
                    } else {
                        console.error('No logs found for job type:', jobType);
                        alert('Brak log√≥w dla tego typu zadania');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('B≈ÇƒÖd podczas pobierania szczeg√≥≈Ç√≥w zadania');
                });
        }
        
        function displayJobDetailsModal(log) {
            const details = log.details || 'Brak szczeg√≥≈Ç√≥w';
            const errorMessage = log.error_message || 'Brak';
            const metadata = log.metadata ? JSON.stringify(log.metadata, null, 2) : 'Brak';
            
            const modalContent = `
                <div class="modal fade" id="jobDetailsModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Szczeg√≥≈Çy zadania: ${log.job_name}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Podstawowe informacje:</h6>
                                        <ul class="list-unstyled">
                                            <li><strong>Status:</strong> ${log.success ? '‚úÖ Sukces' : '‚ùå B≈ÇƒÖd'}</li>
                                            <li><strong>Data:</strong> ${new Date(log.timestamp).toLocaleString('pl-PL')}</li>
                                            <li><strong>Czas wykonania:</strong> ${log.execution_time_ms || 'N/A'}ms</li>
                                            <li><strong>Rekordy:</strong> ${log.records_processed || 'N/A'}</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Szczeg√≥≈Çy:</h6>
                                        <p class="text-muted">${details}</p>
                                        ${log.error_message ? `<h6>B≈ÇƒÖd:</h6><p class="text-danger">${errorMessage}</p>` : ''}
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h6>Metadane:</h6>
                                        <pre class="bg-light p-2 rounded"><code>${metadata}</code></pre>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Zamknij</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Usu≈Ñ istniejƒÖcy modal je≈õli istnieje
            const existingModal = document.getElementById('jobDetailsModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Dodaj nowy modal do body
            document.body.insertAdjacentHTML('beforeend', modalContent);
            
            // Poka≈º modal
            const modal = new bootstrap.Modal(document.getElementById('jobDetailsModal'));
            modal.show();
        }
        
        // Inicjalizacja przy ≈Çadowaniu strony
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM loaded, inicjalizacja...');
            console.log('üîç Sprawdzanie element√≥w...');
            console.log('updateAllEtfsBody:', document.getElementById('updateAllEtfsBody'));
            console.log('updateEtfPricesBody:', document.getElementById('updateEtfPricesBody'));
            // Za≈Çaduj logi zada≈Ñ przy starcie
            console.log('üìä ≈Åadowanie log√≥w zada≈Ñ...');
            refreshAllJobLogs();
            
            // Za≈Çaduj zadania schedulera przy starcie
            console.log('üìÖ ≈Åadowanie zada≈Ñ schedulera...');
            loadSchedulerJobs();
        });
    </script>
</body>
</html>
