<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Status systemu - ETF Analyzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .status-card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .status-card:hover {
            transform: translateY(-2px);
        }
        .system-status-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Back Button -->
    <div class="back-button">
        <a href="/" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Powrót do dashboard
        </a>
    </div>

    <div class="container mt-5 pt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="bi bi-server text-primary"></i>
                    Status systemu ETF Analyzer
                </h1>
                <p class="text-center text-muted mb-5">Monitorowanie stanu systemu, bazy danych i tokenów API</p>
            </div>
        </div>

        <!-- System Status Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card system-status-card">
                    <div class="card-body text-center">
                        <h3 class="card-title">
                            <i class="bi bi-gear-wide-connected"></i>
                            Status systemu
                        </h3>
                        <div class="row mt-3">
                            <div class="col-md-3">
                                <h4 class="mb-1">{{ total_etfs }}</h4>
                                <small>ETF w bazie</small>
                            </div>
                            <div class="col-md-3">
                                <h4 class="mb-1">{{ scheduler_status }}</h4>
                                <small>Status schedulera</small>
                            </div>
                            <div class="col-md-3">
                                <h4 class="mb-1">{{ etfs_completeness|length }}</h4>
                                <small>ETF sprawdzonych</small>
                            </div>
                            <div class="col-md-3">
                                <h4 class="mb-1">
                                    {% set complete_count = etfs_completeness|selectattr('prices_complete', 'equalto', true)|selectattr('dividends_complete', 'equalto', true)|list|length %}
                                    {{ complete_count }}
                                </h4>
                                <small>Z kompletną historią</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Combined API Status and Plan Information -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-credit-card"></i>
                            Status tokenów API i plany
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for provider, limits in api_limits.items() %}
                            <div class="col-md-4 mb-3">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <h5 class="card-title text-uppercase text-center">{{ provider }}</h5>
                                        
                                        <!-- Plan Information -->
                                        <div class="text-center mb-3">
                                            {% if provider == 'fmp' %}
                                                {% if limits.daily_limit >= 1000 %}
                                                    <span class="badge bg-success">Premium (1000+ calls/day)</span>
                                                {% elif limits.daily_limit >= 500 %}
                                                    <span class="badge bg-warning">Standard (500 calls/day)</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Free (250 calls/day)</span>
                                                {% endif %}
                                            {% elif provider == 'eodhd' %}
                                                {% if limits.daily_limit >= 1000 %}
                                                    <span class="badge bg-success">Premium (1000+ calls/day)</span>
                                                {% elif limits.daily_limit >= 100 %}
                                                    <span class="badge bg-warning">Standard (100 calls/day)</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Free (100 calls/day)</span>
                                                {% endif %}
                                            {% elif provider == 'tiingo' %}
                                                {% if limits.daily_limit >= 1000 %}
                                                    <span class="badge bg-success">Premium (1000+ calls/day)</span>
                                                {% elif limits.daily_limit >= 50 %}
                                                    <span class="badge bg-warning">Standard (50 calls/day)</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Free (50 calls/day)</span>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        
                                        <!-- Usage Information -->
                                        <div class="mb-2">
                                            <small class="text-muted">
                                                Użyto: {{ limits.current_usage }}/{{ limits.daily_limit }}
                                            </small>
                                            <div class="progress mt-1" style="height: 8px;">
                                                {% set percentage = (limits.current_usage / limits.daily_limit * 100) | round %}
                                                {% if percentage < 50 %}
                                                    <div class="progress-bar bg-success" style="width: {{ percentage }}%"></div>
                                                {% elif percentage < 80 %}
                                                    <div class="progress-bar bg-warning" style="width: {{ percentage }}%"></div>
                                                {% else %}
                                                    <div class="progress-bar bg-danger" style="width: {{ percentage }}%"></div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <!-- Reset Information -->
                                        <div class="text-center">
                                            <small class="text-muted">
                                                <i class="bi bi-clock"></i>
                                                Reset za: {{ "%.1f"|format(limits.hours_until_reset) }}h
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- API Capabilities Info -->
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                <strong>Free plan:</strong> 5 lat historii | <strong>Premium plan:</strong> 15+ lat historii + więcej wywołań
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Completeness Status -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-database-check"></i>
                            Kompletność danych historycznych
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>ETF</th>
                                        <th>Wiek ETF</th>
                                        <th>Oczekiwane lata</th>
                                        <th>Ceny</th>
                                        <th>Dywidendy</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for etf in etfs_completeness %}
                                    <tr>
                                        <td><strong>{{ etf.ticker }}</strong></td>
                                        <td>{{ "%.1f"|format(etf.etf_age_years) }} lat</td>
                                        <td>{{ etf.expected_years }} lat</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if etf.prices_complete %}
                                                    <span class="badge bg-success me-2">✓</span>
                                                {% else %}
                                                    <span class="badge bg-warning me-2">⚠</span>
                                                {% endif %}
                                                <small>{{ "%.1f"|format(etf.years_of_price_data) }} lat</small>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                {% if etf.dividends_complete %}
                                                    <span class="badge bg-success me-2">✓</span>
                                                {% else %}
                                                    <span class="badge bg-warning me-2">⚠</span>
                                                {% endif %}
                                                <small>{{ "%.1f"|format(etf.years_of_dividend_data) }} lat</small>
                                            </div>
                                        </td>
                                        <td>
                                            {% if etf.prices_complete and etf.dividends_complete %}
                                                <span class="badge bg-success">Kompletne</span>
                                            {% elif etf.prices_complete or etf.dividends_complete %}
                                                <span class="badge bg-warning">Częściowo</span>
                                            {% else %}
                                                <span class="badge bg-danger">Brakuje</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                System sprawdza kompletność danych względem rzeczywistego wieku ETF. 
                                ETF młodszy niż 15 lat jest "kompletny" jeśli ma dane od momentu powstania.
                                System automatycznie uzupełnia brakujące dane historyczne raz dziennie o 09:00 UTC.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>



        <!-- Scheduler Management -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-success text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-clock-history"></i>
                            Zarządzanie schedulerem
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Status schedulera:</h6>
                                <div class="d-flex align-items-center mb-3">
                                    <span class="badge bg-success me-2">Aktywny</span>
                                    <small class="text-muted">Ostatnie uruchomienie: {{ scheduler_status }}</small>
                                </div>
                                
                                <h6>Zaplanowane zadania:</h6>
                                <div id="scheduledJobs">
                                    <div class="job-item mb-2 p-2 border rounded">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>Codziennie o 09:00 CET</strong><br>
                                                <small class="text-muted">Aktualizacja wszystkich ETF</small>
                                            </div>
                                            <span class="badge bg-success">Aktywne</span>
                                        </div>
                                    </div>
                                    <div class="job-item mb-2 p-2 border rounded">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <strong>Co 15 min (pon-piątek 9:00-17:00 CET)</strong><br>
                                                <small class="text-muted">Aktualizacja cen ETF</small>
                                            </div>
                                            <span class="badge bg-success">Aktywne</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6>Dodaj nowe zadanie:</h6>
                                    <div class="row g-2 mb-2">
                                        <div class="col-6">
                                            <select class="form-select form-select-sm" id="newJobType">
                                                <option value="price_update">Aktualizacja cen ETF</option>
                                                <option value="dividend_check">Sprawdzenie dywidend</option>
                                                <option value="data_cleanup">Czyszczenie danych</option>
                                                <option value="custom">Własne zadanie</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <select class="form-select form-select-sm" id="newJobFrequency">
                                                <option value="daily">Codziennie</option>
                                                <option value="weekly">Co tydzień</option>
                                                <option value="monthly">Co miesiąc</option>
                                                <option value="custom">Własne</option>
                                            </select>
                                        </div>
                                    </div>
                                    <button class="btn btn-outline-info btn-sm w-100" onclick="addNewJob()">
                                        <i class="bi bi-plus-circle"></i> Dodaj zadanie
                                    </button>
                                </div>
                            </div>
                            
                                                            <div class="col-md-6">
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <i class="bi bi-lightbulb"></i>
                                            <strong>Tip:</strong> Scheduler automatycznie zarządza danymi. 
                                            <br><strong>"Aktualizacja wszystkich ETF":</strong> Sprawdza nowe dywidendy, ceny i uzupełnia brakującą historię
                                            <br><strong>"Aktualizacja cen ETF":</strong> Aktualizuje tylko ceny co 15 min w dni robocze
                                        </small>
                                    </div>
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Job Execution Logs -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-info text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-list-check"></i>
                            Logi wykonanych zadań
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Ostatnie wykonania:</h6>
                                <div id="jobLogs" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                                                                            <div class="job-log-item mb-2 p-2 bg-light rounded">
                                            <div class="d-flex justify-content-between">
                                                <strong>Aktualizacja wszystkich ETF</strong>
                                                <small class="text-muted">2 godziny temu</small>
                                            </div>
                                            <small class="text-success">✓ Ukończone pomyślnie</small>
                                            <div class="mt-1">
                                                <small class="text-muted">Zaktualizowano 5 ETF, uzupełniono 12 cen, 3 dywidendy</small>
                                            </div>
                                        </div>
                                                                            <div class="job-log-item mb-2 p-2 bg-light rounded">
                                            <div class="d-flex justify-content-between">
                                                <strong>Aktualizacja cen ETF</strong>
                                                <small class="text-muted">15 minut temu</small>
                                            </div>
                                            <small class="text-success">✓ Ukończone pomyślnie</small>
                                            <div class="mt-1">
                                                <small class="text-muted">Zaktualizowano ceny 5 ETF</small>
                                            </div>
                                        </div>
                                </div>
                                <button class="btn btn-outline-secondary btn-sm mt-2" onclick="refreshJobLogs()">
                                    <i class="bi bi-arrow-clockwise"></i> Odśwież logi
                                </button>
                            </div>
                            <div class="col-md-6">
                                <h6>Statystyki wykonania:</h6>
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <h5 class="text-success mb-0">24</h5>
                                            <small class="text-muted">Dzisiaj</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <h5 class="text-primary mb-0">168</h5>
                                            <small class="text-muted">Ten tydzień</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="border rounded p-2">
                                            <h5 class="text-info mb-0">98.5%</h5>
                                            <small class="text-muted">Sukces</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <h6>Filtruj logi:</h6>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <select class="form-select form-select-sm" id="logFilter">
                                                <option value="all">Wszystkie</option>
                                                <option value="success">Tylko sukcesy</option>
                                                <option value="error">Tylko błędy</option>
                                                <option value="today">Dzisiaj</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <button class="btn btn-outline-warning btn-sm w-100" onclick="exportJobLogs()">
                                                <i class="bi bi-download"></i> Eksportuj
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Information -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card status-card">
                    <div class="card-header bg-secondary text-white">
                        <h4 class="mb-0">
                            <i class="bi bi-info-circle"></i>
                            Informacje o systemie
                        </h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Inteligentne uzupełnianie historii:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-check-circle text-success"></i> Codziennie o 09:00 CET (czas polski)</li>
                                    <li><i class="bi bi-check-circle text-success"></i> Sprawdza kompletność względem wieku ETF</li>
                                    <li><i class="bi bi-check-circle text-success"></i> Uzupełnia brakujące dane</li>
                                    <li><i class="bi bi-check-circle text-success"></i> Oszczędza tokeny API</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Strategia pobierania:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-arrow-up-circle text-primary"></i> Nowe ceny: co 7 dni</li>
                                    <li><i class="bi bi-arrow-up-circle text-primary"></i> Nowe dywidendy: co 30 dni</li>
                                    <li><i class="bi bi-arrow-up-circle text-primary"></i> Historia: tylko brakujące</li>
                                    <li><i class="bi bi-arrow-up-circle text-primary"></i> Cache: maksymalne wykorzystanie</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Funkcje do zarządzania schedulerem
        function runSchedulerJob() {
            if (confirm('Czy na pewno chcesz uruchomić zadanie schedulera teraz? To może zająć kilka minut.')) {
                // Użyj istniejącego endpointu do aktualizacji zadania
                fetch('/api/system/scheduler/update-job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        job_id: 'create_app.<locals>.update_all_etfs',
                        hour: 9,
                        minute: 0
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Zadanie zostało uruchomione! Sprawdź logi w terminalu.');
                        location.reload(); // Odśwież stronę
                    } else {
                        alert('Błąd: ' + (data.error || 'Nie udało się uruchomić zadania'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Błąd komunikacji z serwerem');
                });
            }
        }
        
        function checkSchedulerStatus() {
            // Pokaż prosty status bez API call
            let status = 'Status schedulera:\n';
            status += '- Status: Aktywny\n';
            status += '- Zadanie: Aktualizacja wszystkich ETF\n';
            status += '- Czas: Codziennie o 09:00 CET (czas polski)\n';
            status += '- Ostatnie uruchomienie: ' + (new Date().toLocaleString('pl-PL')) + '\n';
            status += '- Następne uruchomienie: Jutro o 09:00 CET';
            alert(status);
        }
        
        function viewSchedulerLogs() {
            alert('Logi schedulera są wyświetlane w terminalu gdzie uruchomiona jest aplikacja.\n\n' +
                  'Możesz też sprawdzić logi w przeglądarce na stronie /system/status - ' +
                  'tam zobaczysz aktualny status i kompletność danych.');
        }
        
        function updateSchedulerTime() {
            const hour = document.getElementById('schedulerHour').value;
            const minute = document.getElementById('schedulerMinute').value;
            
            if (hour === '' || minute === '' || hour < 0 || hour > 23 || minute < 0 || minute > 59) {
                alert('Podaj poprawną godzinę (0-23) i minutę (0-59).');
                return;
            }
            
            if (confirm(`Czy na pewno chcesz zmienić czas wykonania zadania na ${hour.padStart(2, '0')}:${minute.padStart(2, '0')} UTC?`)) {
                fetch('/api/system/scheduler/update-job', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        job_id: 'create_app.<locals>.update_all_etfs',
                        hour: parseInt(hour),
                        minute: parseInt(minute)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Czas wykonania zadania został zmieniony na ${hour.padStart(2, '0')}:${minute.padStart(2, '0')} UTC!\n\nNastępne uruchomienie: ${data.next_run || 'sprawdź status'}`);
                        location.reload(); // Odśwież stronę
                    } else {
                        alert('Błąd: ' + (data.error || 'Nie udało się zmienić czasu wykonania'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Błąd komunikacji z serwerem');
                });
            }
        }
        
        // Nowe funkcje do zarządzania zadaniami
        function addNewJob() {
            const jobType = document.getElementById('newJobType').value;
            const jobFrequency = document.getElementById('newJobFrequency').value;
            
            if (confirm(`Czy chcesz dodać nowe zadanie typu "${jobType}" z częstotliwością "${jobFrequency}"?`)) {
                // Tutaj można dodać logikę do tworzenia nowych zadań
                alert('Funkcja dodawania nowych zadań będzie dostępna w następnej wersji.\n\n' +
                      'Na razie możesz:\n' +
                      '1. Zmienić czas istniejących zadań\n' +
                      '2. Uruchomić zadania ręcznie\n' +
                      '3. Sprawdzić status i logi');
            }
        }
        
        function refreshJobLogs() {
            // Symulacja odświeżenia logów
            const logsContainer = document.getElementById('jobLogs');
            const now = new Date();
            const timeAgo = Math.floor(Math.random() * 60) + ' minut temu';
            
            const newLog = document.createElement('div');
            newLog.className = 'job-log-item mb-2 p-2 bg-light rounded';
            newLog.innerHTML = `
                <div class="d-flex justify-content-between">
                    <strong>Manual Refresh</strong>
                    <small class="text-muted">${timeAgo}</small>
                </div>
                <small class="text-info">ℹ Odświeżono logi</small>
                <div class="mt-1">
                    <small class="text-muted">Logi zostały odświeżone o ${now.toLocaleTimeString('pl-PL')}</small>
                </div>
            `;
            
            logsContainer.insertBefore(newLog, logsContainer.firstChild);
            
            // Usuń stare logi jeśli jest ich za dużo
            const logs = logsContainer.querySelectorAll('.job-log-item');
            if (logs.length > 10) {
                logs[logs.length - 1].remove();
            }
            
            alert('Logi zostały odświeżone!');
        }
        
        function exportJobLogs() {
            // Symulacja eksportu logów
            const exportData = {
                timestamp: new Date().toISOString(),
                logs: [
                    {
                                                            job: 'Aktualizacja wszystkich ETF',
                        status: 'success',
                        timestamp: '2 godziny temu',
                        details: 'Zaktualizowano 5 ETF, uzupełniono 12 cen, 3 dywidendy'
                    },
                                            {
                            job: 'Aktualizacja cen ETF',
                            status: 'success',
                            timestamp: '15 minut temu',
                            details: 'Zaktualizowano ceny 5 ETF'
                        }
                ]
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `job_logs_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('Logi zostały wyeksportowane do pliku JSON!');
        }
        
        // Inicjalizacja przy ładowaniu strony
        document.addEventListener('DOMContentLoaded', function() {
            // Dodaj event listener do filtra logów
            document.getElementById('logFilter').addEventListener('change', function() {
                const filter = this.value;
                console.log('Filtrowanie logów:', filter);
                // Tutaj można dodać logikę filtrowania
            });
        });
    </script>
</body>
</html>
