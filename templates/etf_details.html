<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF {{ etf.ticker }} - Szczegóły</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .dividend-matrix {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }
        .matrix-table {
            font-size: 0.9em;
            border-collapse: collapse;
        }
        .matrix-table th {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 4px;
            text-align: center;
            font-weight: 600;
            min-width: 50px;
        }
        .matrix-table td {
            border: 1px solid #dee2e6;
            padding: 6px 4px;
            text-align: center;
            min-width: 50px;
        }
        .matrix-table .year-column {
            background: #e9ecef;
            font-weight: 600;
            text-align: right;
            padding-right: 12px;
            min-width: 60px;
        }
        .dividend-value {
            background: #d4edda;
            color: #155724;
            font-weight: 600;
        }
        .no-dividend {
            background: #f8f9fa;
            color: #6c757d;
        }
        .table-success {
            background: #d1e7dd !important;
            color: #0f5132 !important;
        }
        .table-warning {
            background: #fff3cd !important;
            color: #664d03 !important;
        }
        .table-secondary {
            background: #e2e3e5 !important;
            color: #41464b !important;
        }
                            .table-light {
                        background: #f8f9fa !important;
                        color: #6c757d !important;
                    }
                    .split-info {
                        background: #f8f9fa;
                        text-align: center;
                        min-width: 60px;
                    }
                    .split-info .badge {
                        font-size: 0.8em;
                    }
                    .header-card {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border-radius: 10px;
                        padding: 20px;
                        margin: 20px 0;
                    }
        .back-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }
        .back-button:hover {
            background: rgba(255,255,255,0.3);
            color: white;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <!-- Back Button -->
        <div class="row mt-3">
            <div class="col-12">
                <a href="/" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Powrót do Dashboard
                </a>
            </div>
        </div>

        <!-- ETF Header Info -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2 class="card-title mb-2">
                                    <i class="bi bi-graph-up text-primary"></i>
                                    {{ etf.ticker }} - {{ etf.name or 'N/A' }}
                                </h2>
                                <div class="etf-info">
                                    <span class="badge bg-primary me-2">
                                        <i class="bi bi-currency-dollar"></i>
                                        Cena: ${{ etf.current_price | comma_format(2) if etf.current_price else 'N/A' }}
                                    </span>
                                    <span class="badge bg-success me-2">
                                        <i class="bi bi-percent"></i>
                                        Yield: <span id="currentYield" data-original="{{ etf.current_yield | dot_format(2) if etf.current_yield else 'N/A' }}">{{ etf.current_yield | comma_format(2) if etf.current_yield else 'N/A' }}</span>%
                                    </span>
                                    <span class="badge bg-warning text-dark me-2" id="taxRateBadge">
                                        <i class="bi bi-receipt"></i>
                                        Podatek od dyw.: <span id="currentTaxRate">0</span>%
                                    </span>
                                    <span class="badge bg-info me-2">
                                        <i class="bi bi-calendar-event"></i>
                                        Częstotliwość: {{ etf.frequency or 'N/A' }}
                                    </span>
                                    <span class="badge bg-secondary me-2">
                                        <i class="bi bi-calculator"></i>
                                        Suma {{ "12" if etf.frequency == "monthly" else "4" }} ost.: 
                                        $<span id="lastDividendsSum" data-original="{{ last_dividends_sum | dot_format(5) if last_dividends_sum else 'N/A' }}">{{ last_dividends_sum | comma_format(5) if last_dividends_sum else 'N/A' }}</span>
                                    </span>
                                    {% if dividend_growth_forecast and dividend_growth_forecast != 0 %}
                                        <span class="badge bg-{% if dividend_growth_forecast > 0 %}success{% else %}danger{% endif %} me-2">
                                            <i class="bi bi-trending-up"></i>
                                            Prognozowany wzrost dyw.: 
                                            <span id="dividendGrowthForecast">{{ dividend_growth_forecast | comma_format(2) }}%</span>
                                            <i class="bi bi-info-circle text-info" 
                                               title="Obliczane jako: (Suma ostatnich {{ '12' if etf.frequency == 'monthly' else '4' }} dywidend - Suma roczna z poprzedniego roku) / Suma roczna z poprzedniego roku × 100%"></i>
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="mb-2">
                                    <small class="text-muted">Ostatnia aktualizacja:</small><br>
                                    <span class="badge bg-light text-dark">
                                        {{ etf.last_updated.strftime('%Y-%m-%d %H:%M') if etf.last_updated else 'N/A' }}
                                    </span>
                                </div>
                                <button class="btn btn-success btn-sm" onclick="updateEtfData()">
                                    <i class="bi bi-arrow-clockwise"></i> Aktualizuj
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dividend Matrix -->
        <div class="dividend-matrix">
            <h3 class="mb-4">
                <i class="bi bi-calendar-check"></i>
                Historia wypłaconych dywidend
            </h3>

            
            <div class="table-responsive">
                <table class="table matrix-table">
                                            <thead>
                            <tr>
                                <th class="year-column">Suma Roczna</th>
                                <th class="year-column">Rok</th>
                                <th>Sty</th>
                                <th>Lut</th>
                                <th>Mar</th>
                                <th>Kwi</th>
                                <th>Maj</th>
                                <th>Cze</th>
                                <th>Lip</th>
                                <th>Sie</th>
                                <th>Wrz</th>
                                <th>Paź</th>
                                <th>Lis</th>
                                <th>Gru</th>
                            </tr>
                        </thead>
                    <tbody>
                        {% set dividends_by_year_month = {} %}
                        {% set yearly_totals = {} %}
                        {% for dividend in dividends %}
                            {% set year = dividend.payment_date.year %}
                            {% set month = dividend.payment_date.month %}
                            {% if year not in dividends_by_year_month %}
                                {% set _ = dividends_by_year_month.update({year: {}}) %}
                                {% set _ = yearly_totals.update({year: 0}) %}
                            {% endif %}
                            {% if month not in dividends_by_year_month[year] %}
                                {% set _ = dividends_by_year_month[year].update({month: []}) %}
                            {% endif %}
                            {% set _ = dividends_by_year_month[year][month].append(dividend.normalized_amount) %}
                            {% set _ = yearly_totals.update({year: yearly_totals[year] + dividend.normalized_amount}) %}
                        {% endfor %}
                        
                        {% set years = dividends_by_year_month.keys()|sort(reverse=true) %}
                        {% for year in years %}
                            {% set current_total = yearly_totals[year] %}
                            {% set previous_year = years[loop.index0 + 1] if loop.index0 + 1 < years|length else None %}
                            {% set previous_total = yearly_totals[previous_year] if previous_year else None %}
                            
                            {% if previous_total %}
                                {% if current_total > previous_total %}
                                    {% set total_class = "table-success" %}
                                    {% set total_title = "Wzrost z " + (previous_total | comma_format(5)) + " na " + (current_total | comma_format(5)) %}
                                {% elif current_total < previous_total %}
                                    {% set total_class = "table-warning" %}
                                    {% set total_title = "Spadek z " + (previous_total | comma_format(5)) + " na " + (current_total | comma_format(5)) %}
                                {% else %}
                                    {% set total_class = "table-secondary" %}
                                    {% set total_title = "Bez zmian: " + (current_total | comma_format(5)) %}
                                {% endif %}
                            {% else %}
                                {% set total_class = "table-light" %}
                                                                    {% set total_title = "Pierwszy rok: " + (current_total | comma_format(5)) %}
                            {% endif %}
                            
                                                                    <tr>
                                            <td class="{{ total_class }} yearly-total" title="{{ total_title }}" data-original="{{ current_total | dot_format(5) }}">
                                                <strong>{{ current_total | comma_format(5) }}</strong>
                                            </td>
                                            <td class="year-column">{{ year }}</td>
                                            {% for month in range(1, 13) %}
                                                {% if month in dividends_by_year_month[year] %}
                                                    {% set amounts = dividends_by_year_month[year][month] %}
                                                    {% set total = amounts|sum %}
                                                    {% set count = amounts|length %}
                                                    {% if count > 1 %}
                                                        <td class="dividend-value monthly-dividend" title="Liczba wypłat: {{ count }}" data-original="{{ total | dot_format(5) }}">
                                                            {{ total | comma_format(5) }}
                                                        </td>
                                                    {% else %}
                                                        <td class="dividend-summary" data-original="{{ total | dot_format(5) }}">
                                                            {{ total | comma_format(5) }}
                                                        </td>
                                                    {% endif %}
                                                {% else %}
                                                    <td class="no-dividend">0,00</td>
                                                {% endif %}
                                            {% endfor %}
                                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
                                    <div class="mt-3 text-muted">
                            <small>
                                <i class="bi bi-info-circle"></i>
                                <strong>Suma Roczna:</strong> 
                                <span class="text-success">Zielone</span> = wzrost dywidendy rok do roku, 
                                <span class="text-warning">Żółte</span> = spadek dywidendy rok do roku, 
                                <span class="text-secondary">Szare</span> = bez zmian. 
                                <br>
                                <strong>Split akcji:</strong> 
                                {% if etf.splits.count() > 0 %}
                                    {% for split in etf.splits %}
                                        {{ split.description }} dnia {{ split.split_date.strftime('%d %B %Y') }}
                                        {% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    Brak splitów akcji w historii tego ETF.
                                {% endif %}
                                <br>
                                <strong>Komórki miesięczne:</strong> Suma dywidend wypłaconych w danym miesiącu. 
                                Jeśli w miesiącu wypłacono kilka dywidend, pokazana jest suma.
                                <br>
                                <strong>Uwaga:</strong> Dywidendy przed splitem są automatycznie normalizowane dla porównywalności.
                            </small>
                        </div>
        </div>
        
        <!-- Wykres rocznych dywidend -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-bar-chart"></i> 
                            Wykres rocznych dywidend - ostatnie 15 lat
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Przełącznik brutto/netto -->
                        <div class="row mb-3">
                            <div class="col-12 text-center">
                                <div class="btn-group" role="group" aria-label="Przełącznik typu dywidend">
                                    <input type="radio" class="btn-check" name="dividendType" id="grossBtn" value="gross">
                                    <label class="btn btn-outline-primary" for="grossBtn">
                                        <i class="bi bi-cash-stack"></i> Dywidendy brutto
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="dividendType" id="netBtn" value="net" checked>
                                    <label class="btn btn-outline-success" for="netBtn">
                                        <i class="bi bi-cash"></i> Dywidendy netto (po podatku)
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container" style="position: relative; height:400px;">
                            <canvas id="dividendChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                Wykres pokazuje sumę rocznych dywidend brutto i netto (po podatku). 
                                Bieżący rok to estymacja na podstawie wypłaconych dywidend.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wykres break-even dywidend -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                                     <div class="card-header">
                         <div class="d-flex justify-content-between align-items-center">
                             <h5 class="mb-0">
                                 <i class="bi bi-clock-history"></i> 
                                 Break-even time dla dywidend - ostatnie 15 lat
                             </h5>
                             <div class="d-flex align-items-center">
                                 <label class="me-2 mb-0">Cel ROI:</label>
                                 <div class="input-group input-group-sm" style="width: 120px;">
                                     <button class="btn btn-outline-secondary btn-sm" type="button" onclick="changeTargetPercentage(-0.1)">
                                         <i class="bi bi-dash"></i>
                                     </button>
                                     <input type="number" class="form-control form-control-sm text-center" id="targetPercentage" 
                                            value="5.00" step="0.1" min="0.1" max="20.0" 
                                            onchange="updateBreakEvenChart()">
                                     <button class="btn btn-outline-secondary btn-sm" type="button" onclick="changeTargetPercentage(0.1)">
                                         <i class="bi bi-plus"></i>
                                     </button>
                                 </div>
                                 <span class="ms-2">%</span>
                             </div>
                         </div>
                     </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:400px;">
                        <canvas id="breakEvenChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Wykres pokazuje ile miesięcy potrzeba, żeby dywidenda netto z inwestycji $1000 osiągnęła <span id="targetAmount">$50</span> (<span id="targetPercentageDisplay">5.00</span>% ROI). 
                            Każdy punkt to inwestycja w danym miesiącu po cenie zamknięcia tego miesiąca.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wykres cen miesięcznych -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i> 
                        Ceny miesięczne - ostatnie 15 lat
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:400px;">
                        <canvas id="priceChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Wykres pokazuje oryginalne ceny historyczne (jakie były w danym momencie). 
                            Dywidendy w tabeli powyżej są znormalizowane względem splitów akcji.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Skrypty JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
        // Rejestracja pluginu DataLabels
        Chart.register(ChartDataLabels);
        
        let currentTaxRate = 0.0;
        
        // Inicjalizacja wykresów
        let priceChart = null;
        let dividendChart = null;
        let breakEvenChart = null;
        
        // Funkcja do tworzenia wykresu dywidend
        function createDividendChart(ticker, currentYearEstimate) {
            fetch(`/api/etfs/${ticker}/dividends`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const ctx = document.getElementById('dividendChart').getContext('2d');
                        
                        // Grupowanie dywidend po latach
                        const dividendsByYear = {};
                        data.data.forEach(dividend => {
                            const year = new Date(dividend.payment_date).getFullYear();
                            if (!dividendsByYear[year]) {
                                dividendsByYear[year] = [];
                            }
                            dividendsByYear[year].push(dividend.normalized_amount);
                        });
                        
                        // Przygotowanie danych dla wykresu
                        const years = Object.keys(dividendsByYear).sort();
                        const currentYear = new Date().getFullYear();
                        
                        // Ograniczenie do ostatnich 15 lat
                        const startYear = Math.max(Math.min(...years), currentYear - 14);
                        const filteredYears = years.filter(year => year >= startYear);
                        
                        const labels = filteredYears.map(year => year);
                        const grossData = filteredYears.map(year => {
                            const yearDividends = dividendsByYear[year] || [];
                            let total = yearDividends.reduce((sum, amount) => sum + amount, 0);
                            
                            // Dla bieżącego roku dodaj estymację jeśli dostępna
                            if (parseInt(year) === currentYear && currentYearEstimate) {
                                total = Math.max(total, currentYearEstimate.gross);
                            }
                            
                            return total;
                        });
                        
                        const netData = filteredYears.map(year => {
                            const yearDividends = dividendsByYear[year] || [];
                            let total = yearDividends.reduce((sum, amount) => sum + amount, 0);
                            
                            // Dla bieżącego roku dodaj estymację jeśli dostępna
                            if (parseInt(year) === currentYear && currentYearEstimate) {
                                total = Math.max(total, currentYearEstimate.net);
                            }
                            
                            // Zastosuj podatek
                            return total * (1 - currentTaxRate / 100);
                        });
                        
                        // Zapisanie danych globalnie dla przełącznika
                        window.dividendChartData = {
                            labels: labels,
                            grossData: grossData,
                            netData: netData,
                            currentYear: currentYear
                        };
                        
                        // Pobranie aktualnie wybranego typu
                        const selectedType = document.querySelector('input[name="dividendType"]:checked').value;
                        updateDividendChart(selectedType);
                        
                        console.log(`Wykres dywidend utworzony dla ${ticker}: ${labels.length} lat`);
                    } else {
                        console.error('Błąd pobierania danych dywidendowych:', data.error);
                        document.getElementById('dividendChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu dywidend</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych dywidendowych:', error);
                    document.getElementById('dividendChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu dywidend</div>';
                });
        }
        
        // Funkcja do aktualizacji wykresu na podstawie wybranego typu
        function updateDividendChart(type) {
            if (!window.dividendChartData) return;
            
            const { labels, grossData, netData, currentYear } = window.dividendChartData;
            const currentYearEstimate = window.currentYearEstimate;
            
            // Wybór danych na podstawie typu
            let data, backgroundColor, borderColor, label, yAxisTitle;
            
            if (type === 'gross') {
                data = grossData;
                backgroundColor = 'rgba(54, 162, 235, 0.8)';
                borderColor = 'rgb(54, 162, 235)';
                label = 'Dywidendy brutto';
                yAxisTitle = 'Suma dywidend brutto ($)';
            } else {
                data = netData;
                backgroundColor = 'rgba(75, 192, 192, 0.8)';
                borderColor = 'rgb(75, 192, 192)';
                label = 'Dywidendy netto (po podatku)';
                yAxisTitle = 'Suma dywidend netto ($)';
            }
            
            // Obliczenie procentów wzrostu względem poprzedniego roku
            const growthPercentages = data.map((value, index) => {
                if (index === 0) return null; // Pierwszy rok - brak poprzedniego
                const previousValue = data[index - 1];
                if (previousValue === 0) return null; // Unikanie dzielenia przez zero
                return ((value - previousValue) / previousValue * 100).toFixed(1);
            });
            
            // Usunięcie poprzedniego wykresu jeśli istnieje
            if (dividendChart) {
                dividendChart.destroy();
            }
            
            // Tworzenie nowego wykresu
            const ctx = document.getElementById('dividendChart').getContext('2d');
            dividendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: data.map((value, index) => {
                            const year = parseInt(labels[index]);
                            const currentYear = new Date().getFullYear();
                            // Bieżący rok - jaśniejszy kolor dla estymacji
                            if (year === currentYear) {
                                if (type === 'gross') {
                                    return 'rgba(54, 162, 235, 0.4)'; // Jaśniejszy niebieski
                                } else {
                                    return 'rgba(75, 192, 192, 0.4)'; // Jaśniejszy zielony
                                }
                            }
                            return backgroundColor;
                        }),
                        borderColor: borderColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 50
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        tooltip: {
                            enabled: false
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        datalabels: {
                            display: true,
                            color: '#333',
                            anchor: 'end',
                            align: 'top',
                            offset: 4,
                            font: {
                                weight: 'bold',
                                size: 10
                            },
                            formatter: function(value, context) {
                                const growth = growthPercentages[context.dataIndex];
                                let label = `$${formatNumber(value, 4)}`;
                                
                                if (growth !== null) {
                                    const growthSymbol = parseFloat(growth) >= 0 ? '↗' : '↘';
                                    label += `\n${growthSymbol} ${growth}%`;
                                }
                                
                                return label;
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Rok'
                            },
                            ticks: {
                                maxRotation: 0
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: yAxisTitle
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + formatNumber(value, 4);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Funkcja do tworzenia wykresu break-even dywidend
        function createBreakEvenChart(ticker) {
            console.log(`🚀 Tworzenie wykresu break-even dla ticker: "${ticker}" (typ: ${typeof ticker}, długość: ${ticker ? ticker.length : 'undefined'})`);
            
            // Sprawdzenie czy ticker jest poprawny
            if (!ticker || ticker.trim() === '') {
                console.error('❌ Ticker jest pusty lub undefined!');
                return;
            }
            
            // Sprawdzenie czy Chart.js jest dostępny
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js nie jest załadowany!');
                return;
            }
            console.log(`📊 Chart.js dostępny:`, Chart);
            
            // Sprawdzenie czy element canvas istnieje
            const canvasElement = document.getElementById('breakEvenChart');
            if (!canvasElement) {
                console.error('❌ Element breakEvenChart nie został znaleziony!');
                return;
            }
            console.log(`🎨 Canvas element:`, canvasElement);
            
            // Pobieranie aktualnej wartości target percentage
            const targetPercentageElement = document.getElementById('targetPercentage');
            if (!targetPercentageElement) {
                console.error('❌ Element targetPercentage nie został znaleziony w createBreakEvenChart!');
                return;
            }
            const targetPercentage = targetPercentageElement.value;
            console.log(`📊 Target percentage w createBreakEvenChart: ${targetPercentage}%`);
            
            console.log(`🔗 Tworzę URL: /api/etfs/${ticker}/break-even-dividends?target_percentage=${targetPercentage}`);
            fetch(`/api/etfs/${ticker}/break-even-dividends?target_percentage=${targetPercentage}`)
                .then(response => response.json())
                .then(data => {
                    console.log(`📊 Otrzymane dane break-even:`, data);
                    if (data.success) {
                        const ctx = canvasElement.getContext('2d');
                        console.log(`🎨 Canvas context:`, ctx);
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.data.map(item => item.month);
                        const breakEvenMonths = data.data.data.map(item => item.months_to_break_even);
                        console.log(`📈 Labels:`, labels);
                        console.log(`📊 Break-even months:`, breakEvenMonths);
                        console.log(`📊 Liczba labels:`, labels.length);
                        console.log(`📊 Liczba breakEvenMonths:`, breakEvenMonths.length);
                        console.log(`📊 Pierwsze 5 labels:`, labels.slice(0, 5));
                        console.log(`📊 Pierwsze 5 breakEvenMonths:`, breakEvenMonths.slice(0, 5));
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (breakEvenChart) {
                            breakEvenChart.destroy();
                        }
                        
                        // Tworzenie nowego wykresu
                        console.log(`🎨 Tworzenie obiektu Chart...`);
                        breakEvenChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: `Break-even time ${ticker} (miesiące do ${targetPercentage}% ROI)`,
                                    data: breakEvenMonths,
                                    borderColor: 'rgb(255, 99, 132)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    borderWidth: 2,
                                    pointRadius: 3,
                                    pointHoverRadius: 6,
                                    tension: 0.1,
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const months = context.parsed.y;
                                                if (months === null) {
                                                    return 'Break-even nie osiągnięty';
                                                }
                                                return `Miesięcy do ${targetPercentage}% ROI: ${months}`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Miesiąc inwestycji'
                                        },
                                        ticks: {
                                            maxTicksLimit: 15,
                                            maxRotation: 45
                                        }
                                    },
                                    y: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: `Miesięcy do ${targetPercentage}% ROI`
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                if (value === null) return 'N/A';
                                                return value;
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Wykres break-even utworzony dla ${ticker}: ${data.data.data.length} punktów danych`);
                        console.log(`🎯 Wykres obiekt:`, breakEvenChart);
                        
                        // Test renderowania
                        console.log(`🔍 Test renderowania - canvas width:`, canvasElement.width);
                        console.log(`🔍 Test renderowania - canvas height:`, canvasElement.height);
                        console.log(`🔍 Test renderowania - chart options:`, breakEvenChart.options);
                        
                        // Test widoczności
                        console.log(`🔍 Test widoczności - canvas display:`, window.getComputedStyle(canvasElement).display);
                        console.log(`🔍 Test widoczności - canvas visibility:`, window.getComputedStyle(canvasElement).visibility);
                        console.log(`🔍 Test widoczności - canvas opacity:`, window.getComputedStyle(canvasElement).opacity);
                    } else {
                        console.error('❌ Błąd pobierania danych break-even:', data.error);
                        document.getElementById('breakEvenChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu break-even</div>';
                    }
                })
                .catch(error => {
                    console.error('❌ Błąd podczas pobierania danych break-even:', error);
                    document.getElementById('breakEvenChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu break-even</div>';
                });
        }
         
        // Funkcja do zmiany target percentage
        function changeTargetPercentage(delta) {
            console.log(`🔄 Zmiana target percentage o ${delta}`);
            const input = document.getElementById('targetPercentage');
            if (!input) {
                console.error('❌ Element targetPercentage nie został znaleziony!');
                return;
            }
            let currentValue = parseFloat(input.value);
            let newValue = currentValue + delta;
            
            // Ograniczenie wartości do zakresu 0.1 - 20.0
            newValue = Math.max(0.1, Math.min(20.0, newValue));
            
            // Formatowanie do 2 miejsc po przecinku
            input.value = newValue.toFixed(2);
            console.log(`📊 Nowa wartość target percentage: ${newValue}%`);
            
            // Aktualizacja opisów na stronie
            updateTargetDisplays();
            
            // Aktualizacja wykresu
            updateBreakEvenChart();
        }
        
        // Funkcja do aktualizacji wykresu break-even
        function updateBreakEvenChart() {
            console.log(`🔄 Aktualizacja wykresu break-even...`);
            const h2Element = document.querySelector('h2');
            if (!h2Element) {
                console.error('❌ Element h2 nie został znaleziony!');
                return;
            }
            console.log(`🔍 H2 element text: "${h2Element.textContent}"`);
            // Poprawiona logika wyciągania tickera - ignorujemy puste elementy
            const words = h2Element.textContent.trim().split(/\s+/).filter(word => word.length > 0);
            const currentTicker = words[0];
            console.log(`📊 Słowa po split: [${words.map(w => `"${w}"`).join(', ')}]`);
            console.log(`📊 Znaleziony ticker: "${currentTicker}" (typ: ${typeof currentTicker}, długość: ${currentTicker ? currentTicker.length : 'undefined'})`);
            updateTargetDisplays(); // Aktualizacja opisów przed wykresem
            createBreakEvenChart(currentTicker);
        }
        
        // Funkcja do aktualizacji opisów na stronie
        function updateTargetDisplays() {
            console.log(`🔄 Aktualizacja opisów na stronie...`);
            const targetPercentage = document.getElementById('targetPercentage').value;
            const targetAmount = (1000 * parseFloat(targetPercentage) / 100).toFixed(2);
            console.log(`📊 Target percentage: ${targetPercentage}%, Target amount: $${targetAmount}`);
            
            // Aktualizacja opisu pod wykresem
            const targetAmountElement = document.getElementById('targetAmount');
            const targetPercentageElement = document.getElementById('targetPercentageDisplay');
            
            if (targetAmountElement && targetPercentageElement) {
                targetAmountElement.textContent = `$${targetAmount}`;
                targetPercentageElement.textContent = targetPercentage;
                console.log(`✅ Opisy zaktualizowane`);
            } else {
                console.error('❌ Elementy opisów nie zostały znalezione!');
            }
        }
        
        // Funkcja do tworzenia wykresu cen
        function createPriceChart(ticker) {
            fetch(`/api/etfs/${ticker}/prices`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const ctx = document.getElementById('priceChart').getContext('2d');
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.prices.map(p => p.date);
                        const prices = data.data.prices.map(p => p.original_price);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (priceChart) {
                            priceChart.destroy();
                        }
                        
                        // Tworzenie nowego wykresu
                        priceChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: `Cena miesięczna ${ticker} (oryginalna)`,
                                    data: prices,
                                    borderColor: 'rgb(75, 192, 192)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                    borderWidth: 2,
                                    pointRadius: 3,
                                    pointHoverRadius: 6,
                                    tension: 0.1,
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const price = context.parsed.y;
                                                return `Cena: $${formatNumber(price, 2)}`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Data'
                                        },
                                        ticks: {
                                            maxTicksLimit: 15,
                                            maxRotation: 45
                                        }
                                    },
                                    y: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Cena ($)'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return '$' + formatNumber(value, 2);
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`Wykres cen utworzony dla ${ticker}: ${data.data.count} punktów danych`);
                    } else {
                        console.error('Błąd pobierania danych cenowych:', data.error);
                        document.getElementById('priceChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu cen</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych cenowych:', error);
                    document.getElementById('priceChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu cen</div>';
                });
        }
        
        // Inicjalizacja wykresu po załadowaniu strony
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, initializing...');
            const ticker = '{{ etf.ticker }}';
            console.log('📊 Ticker:', ticker);
            
            createPriceChart(ticker);
            createBreakEvenChart(ticker);
            
            // Inicjalizacja opisów target percentage
            updateTargetDisplays();
            
            // Pobieranie estymacji bieżącego roku z nagłówka
            const lastDividendsSumElement = document.getElementById('lastDividendsSum');
            let currentYearEstimate = null;
            if (lastDividendsSumElement) {
                const originalValue = parseFloat(lastDividendsSumElement.getAttribute('data-original'));
                if (originalValue && !isNaN(originalValue)) {
                    currentYearEstimate = {
                        gross: originalValue,
                        net: originalValue // Będzie przeliczane po załadowaniu stawki podatku
                    };
                }
            }
            
            createDividendChart(ticker, currentYearEstimate);
            
            // Dodanie event listener dla przełącznika brutto/netto
            document.querySelectorAll('input[name="dividendType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateDividendChart(this.value);
                });
            });
            
            // Ładowanie stawki podatku i przeliczanie wartości
            console.log('🔄 Calling loadTaxRate()...');
            loadTaxRate();
        });
        
        // Funkcja do formatowania liczb z przecinkiem (polski format)
        function formatNumber(number, decimals = 2) {
            if (isNaN(number)) return 'N/A';
            return number.toFixed(decimals).replace('.', ',');
        }
        
        // Funkcje pomocnicze do obliczania wartości po podatku
        function calculateAfterTaxYield(originalYield, taxRate) {
            if (taxRate <= 0) return originalYield;
            return originalYield * (1 - taxRate / 100);
        }

        function calculateAfterTaxAmount(originalAmount, taxRate) {
            if (taxRate <= 0) return originalAmount;
            return originalAmount * (1 - taxRate / 100);
        }
        
        // Funkcje do obsługi podatku od dywidend
        
        async function loadTaxRate() {
            try {
                console.log('🔄 Fetching tax rate from API...');
                const response = await fetch('/api/system/dividend-tax-rate');
                const result = await response.json();
                console.log('📊 API response:', result);
                
                if (result.success) {
                    currentTaxRate = result.data.tax_rate;
                    console.log('📊 Tax rate loaded:', currentTaxRate);
                    
                    // Aktualizacja badge z stawką podatku
                    const taxRateElement = document.getElementById('currentTaxRate');
                    if (taxRateElement) {
                        taxRateElement.textContent = currentTaxRate;
                        console.log('✅ Tax rate badge updated');
                    } else {
                        console.error('❌ Tax rate element not found');
                    }
                    
                    // Przeliczenie wszystkich wartości
                    console.log('🔄 Calling recalculateAllValues()...');
                    recalculateAllValues();
                } else {
                    console.error('❌ API returned error:', result.error);
                }
            } catch (error) {
                console.error('❌ Error loading tax rate:', error);
            }
        }
        
        function recalculateAllValues() {
            console.log('🔢 Recalculating values with tax rate:', currentTaxRate);
            
            // Przeliczenie yield w nagłówku - BRUTTO i NETTO w formacie 2 miejsc po przecinku
            const currentYieldElement = document.getElementById('currentYield');
            if (currentYieldElement) {
                const originalYield = parseFloat(currentYieldElement.getAttribute('data-original'));
                if (originalYield && !isNaN(originalYield)) {
                    const afterTaxYield = calculateAfterTaxYield(originalYield, currentTaxRate);
                    currentYieldElement.textContent = `${formatNumber(originalYield, 2)} (B), ${formatNumber(afterTaxYield, 2)} (N)`;
                }
            }
            
            // Przeliczenie sumy ostatnich dywidend w nagłówku - BRUTTO i NETTO w jednej linii
            const lastDividendsSumElement = document.getElementById('lastDividendsSum');
            if (lastDividendsSumElement) {
                const originalValue = parseFloat(lastDividendsSumElement.getAttribute('data-original'));
                if (originalValue && !isNaN(originalValue)) {
                    const afterTaxValue = calculateAfterTaxAmount(originalValue, currentTaxRate);
                    lastDividendsSumElement.textContent = `${formatNumber(originalValue, 5)} (B), ${formatNumber(afterTaxValue, 5)} (N)`;
                }
            }
            
            // Przeliczenie kolumny "Suma Roczna" w tabeli dywidend
            recalculateYearlyTotals();
            
            // Aktualizacja wykresu dywidend z nową stawką podatku
            if (dividendChart && window.dividendChartData) {
                // Aktualizacja danych netto z nową stawką podatku
                const { labels, grossData, currentYear } = window.dividendChartData;
                const lastDividendsSumElement = document.getElementById('lastDividendsSum');
                
                if (lastDividendsSumElement) {
                    const originalValue = parseFloat(lastDividendsSumElement.getAttribute('data-original'));
                    if (originalValue && !isNaN(originalValue)) {
                        // Aktualizacja estymacji bieżącego roku
                        window.currentYearEstimate = {
                            gross: originalValue,
                            net: originalValue * (1 - currentTaxRate / 100)
                        };
                        
                        // Aktualizacja danych netto z nową stawką podatku
                        window.dividendChartData.netData = grossData.map(gross => gross * (1 - currentTaxRate / 100));
                        
                        // Pobranie aktualnie wybranego typu i aktualizacja wykresu
                        const selectedType = document.querySelector('input[name="dividendType"]:checked').value;
                        updateDividendChart(selectedType);
                    }
                }
            }
        }
        
        function recalculateYearlyTotals() {
            // Przeliczenie kolumny "Suma Roczna"
            const yearlyTotalCells = document.querySelectorAll('.yearly-total');
            yearlyTotalCells.forEach(cell => {
                const originalValue = parseFloat(cell.getAttribute('data-original'));
                if (originalValue && !isNaN(originalValue)) {
                    const afterTaxValue = calculateAfterTaxAmount(originalValue, currentTaxRate);
                    cell.innerHTML = `
                        <div class="text-center">
                            <div class="fw-bold">${formatNumber(afterTaxValue, 5)}</div>
                            <small class="text-muted">${formatNumber(originalValue, 5)}</small>
                        </div>
                    `;
                }
            });
            
            // Przeliczenie WSZYSTKICH komórek z dywidendami (miesięczne/kwartalne)
            const allDividendCells = document.querySelectorAll('.monthly-dividend, .dividend-summary');
            allDividendCells.forEach(cell => {
                const originalValue = parseFloat(cell.getAttribute('data-original'));
                if (originalValue && !isNaN(originalValue)) {
                    const afterTaxValue = calculateAfterTaxAmount(originalValue, currentTaxRate);
                    cell.innerHTML = `
                        <div class="text-center">
                            <div class="fw-bold">${formatNumber(afterTaxValue, 5)}</div>
                            <small class="text-muted">${formatNumber(originalValue, 5)}</small>
                        </div>
                    `;
                }
            });
        }
        
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
