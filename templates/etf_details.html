<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF {{ etf.ticker }} - Szczegóły</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .dividend-matrix {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }
        .matrix-table {
            font-size: 0.9em;
            border-collapse: collapse;
        }
        .matrix-table th {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 4px;
            text-align: center;
            font-weight: 600;
            min-width: 50px;
        }
        .matrix-table td {
            border: 1px solid #dee2e6;
            padding: 6px 4px;
            text-align: center;
            min-width: 50px;
        }
        .matrix-table .year-column {
            background: #e9ecef;
            font-weight: 600;
            text-align: right;
            padding-right: 12px;
            min-width: 60px;
        }
        .dividend-value {
            background: #d4edda;
            color: #155724;
            font-weight: 600;
        }
        .no-dividend {
            background: #f8f9fa;
            color: #6c757d;
        }
        .table-success {
            background: #d1e7dd !important;
            color: #0f5132 !important;
        }
        .table-warning {
            background: #fff3cd !important;
            color: #664d03 !important;
        }
        .table-secondary {
            background: #e2e3e5 !important;
            color: #41464b !important;
        }
                            .table-light {
                        background: #f8f9fa !important;
                        color: #6c757d !important;
                    }
                    .split-info {
                        background: #f8f9fa;
                        text-align: center;
                        min-width: 60px;
                    }
                    .split-info .badge {
                        font-size: 0.8em;
                    }
                    .header-card {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border-radius: 10px;
                        padding: 20px;
                        margin: 20px 0;
                    }
        .back-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }
        .back-button:hover {
            background: rgba(255,255,255,0.3);
            color: white;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <!-- Back Button -->
        <div class="row mt-3">
            <div class="col-12">
                <a href="/" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Powrót do Dashboard
                </a>
            </div>
        </div>

        <!-- ETF Header Info -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2 class="card-title mb-2">
                                    <i class="bi bi-graph-up text-primary"></i>
                                    {{ etf.ticker }} - {{ etf.name or 'N/A' }}
                                </h2>
                                <div class="etf-info">
                                    <span class="badge bg-primary me-2">
                                        <i class="bi bi-currency-dollar"></i>
                                        Cena: ${{ etf.current_price | comma_format(2) if etf.current_price else 'N/A' }}
                                    </span>
                                    <span class="badge bg-success me-2">
                                        <i class="bi bi-percent"></i>
                                        Yield: <span id="currentYield" data-original="{{ etf.current_yield | dot_format(2) if etf.current_yield else 'N/A' }}">{{ etf.current_yield | comma_format(2) if etf.current_yield else 'N/A' }}</span>%
                                    </span>
                                    <span class="badge bg-warning text-dark me-2" id="taxRateBadge">
                                        <i class="bi bi-receipt"></i>
                                        Podatek od dyw.: <span id="currentTaxRate">0</span>%
                                    </span>
                                    <span class="badge bg-info me-2">
                                        <i class="bi bi-calendar-event"></i>
                                        Częstotliwość: {{ etf.frequency or 'N/A' }}
                                    </span>
                                    <span class="badge bg-secondary me-2">
                                        <i class="bi bi-calculator"></i>
                                        Suma {{ "12" if etf.frequency == "monthly" else "4" }} ost.: 
                                        $<span id="lastDividendsSum" data-original="{{ last_dividends_sum | dot_format(5) if last_dividends_sum else 'N/A' }}">{{ last_dividends_sum | comma_format(5) if last_dividends_sum else 'N/A' }}</span>
                                    </span>
                                    {% if dividend_growth_forecast and dividend_growth_forecast != 0 %}
                                        <span class="badge bg-{% if dividend_growth_forecast > 0 %}success{% else %}danger{% endif %} me-2">
                                            <i class="bi bi-trending-up"></i>
                                            Prognozowany wzrost dyw.: 
                                            <span id="dividendGrowthForecast">{{ dividend_growth_forecast | comma_format(2) }}%</span>
                                            <i class="bi bi-info-circle text-info" 
                                               title="Obliczane jako: (Suma ostatnich {{ '12' if etf.frequency == 'monthly' else '4' }} dywidend - Suma roczna z poprzedniego roku) / Suma roczna z poprzedniego roku × 100%"></i>
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="mb-2">
                                    <small class="text-muted">Ostatnia aktualizacja:</small><br>
                                    <span class="badge bg-light text-dark">
                                        {{ etf.last_updated.strftime('%Y-%m-%d %H:%M') if etf.last_updated else 'N/A' }}
                                    </span>
                                </div>
                                <button class="btn btn-success btn-sm" onclick="updateEtfData()">
                                    <i class="bi bi-arrow-clockwise"></i> Aktualizuj
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dividend Matrix -->
        <div class="dividend-matrix">
            <h3 class="mb-4">
                <i class="bi bi-calendar-check"></i>
                Historia wypłaconych dywidend
            </h3>

            
            <div class="table-responsive">
                <table class="table matrix-table">
                                            <thead>
                            <tr>
                                <th class="year-column">Suma Roczna</th>
                                <th class="year-column">Rok</th>
                                <th>Sty</th>
                                <th>Lut</th>
                                <th>Mar</th>
                                <th>Kwi</th>
                                <th>Maj</th>
                                <th>Cze</th>
                                <th>Lip</th>
                                <th>Sie</th>
                                <th>Wrz</th>
                                <th>Paź</th>
                                <th>Lis</th>
                                <th>Gru</th>
                            </tr>
                        </thead>
                    <tbody>
                        {% set dividends_by_year_month = {} %}
                        {% set yearly_totals = {} %}
                        {% for dividend in dividends %}
                            {% set year = dividend.payment_date.year %}
                            {% set month = dividend.payment_date.month %}
                            {% if year not in dividends_by_year_month %}
                                {% set _ = dividends_by_year_month.update({year: {}}) %}
                                {% set _ = yearly_totals.update({year: 0}) %}
                            {% endif %}
                            {% if month not in dividends_by_year_month[year] %}
                                {% set _ = dividends_by_year_month[year].update({month: []}) %}
                            {% endif %}
                            {% set _ = dividends_by_year_month[year][month].append(dividend.normalized_amount) %}
                            {% set _ = yearly_totals.update({year: yearly_totals[year] + dividend.normalized_amount}) %}
                        {% endfor %}
                        
                        {% set years = dividends_by_year_month.keys()|sort(reverse=true) %}
                        {% for year in years %}
                            {% set current_total = yearly_totals[year] %}
                            {% set previous_year = years[loop.index0 + 1] if loop.index0 + 1 < years|length else None %}
                            {% set previous_total = yearly_totals[previous_year] if previous_year else None %}
                            
                            {% if previous_total %}
                                {% if current_total > previous_total %}
                                    {% set total_class = "table-success" %}
                                    {% set total_title = "Wzrost z " + (previous_total | comma_format(5)) + " na " + (current_total | comma_format(5)) %}
                                {% elif current_total < previous_total %}
                                    {% set total_class = "table-warning" %}
                                    {% set total_title = "Spadek z " + (previous_total | comma_format(5)) + " na " + (current_total | comma_format(5)) %}
                                {% else %}
                                    {% set total_class = "table-secondary" %}
                                    {% set total_title = "Bez zmian: " + (current_total | comma_format(5)) %}
                                {% endif %}
                            {% else %}
                                {% set total_class = "table-light" %}
                                                                    {% set total_title = "Pierwszy rok: " + (current_total | comma_format(5)) %}
                            {% endif %}
                            
                                                                    <tr>
                                            <td class="{{ total_class }} yearly-total" title="{{ total_title }}" data-original="{{ current_total | dot_format(5) }}">
                                                <strong>{{ current_total | comma_format(5) }}</strong>
                                            </td>
                                            <td class="year-column">{{ year }}</td>
                                            {% for month in range(1, 13) %}
                                                {% if month in dividends_by_year_month[year] %}
                                                    {% set amounts = dividends_by_year_month[year][month] %}
                                                    {% set total = amounts|sum %}
                                                    {% set count = amounts|length %}
                                                    {% if count > 1 %}
                                                        <td class="dividend-value monthly-dividend" title="Liczba wypłat: {{ count }}" data-original="{{ total | dot_format(5) }}">
                                                            {{ total | comma_format(5) }}
                                                        </td>
                                                    {% else %}
                                                        <td class="dividend-summary" data-original="{{ total | dot_format(5) }}">
                                                            {{ total | comma_format(5) }}
                                                        </td>
                                                    {% endif %}
                                                {% else %}
                                                    <td class="no-dividend">0,00</td>
                                                {% endif %}
                                            {% endfor %}
                                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
                                    <div class="mt-3 text-muted">
                            <small>
                                <i class="bi bi-info-circle"></i>
                                <strong>Suma Roczna:</strong> 
                                <span class="text-success">Zielone</span> = wzrost dywidendy rok do roku, 
                                <span class="text-warning">Żółte</span> = spadek dywidendy rok do roku, 
                                <span class="text-secondary">Szare</span> = bez zmian. 
                                <br>
                                <strong>Split akcji:</strong> 
                                {% if etf.splits.count() > 0 %}
                                    {% for split in etf.splits %}
                                        {{ split.description }} dnia {{ split.split_date.strftime('%d %B %Y') }}
                                        {% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    Brak splitów akcji w historii tego ETF.
                                {% endif %}
                                <br>
                                <strong>Komórki miesięczne:</strong> Suma dywidend wypłaconych w danym miesiącu. 
                                Jeśli w miesiącu wypłacono kilka dywidend, pokazana jest suma.
                                <br>
                                <strong>Uwaga:</strong> Dywidendy przed splitem są automatycznie normalizowane dla porównywalności.
                            </small>
                        </div>
        </div>
        
        <!-- Wykres rocznych dywidend -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-bar-chart"></i> 
                            Wykres rocznych dywidend - ostatnie 15 lat
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Przełącznik brutto/netto -->
                        <div class="row mb-3">
                            <div class="col-12 text-center">
                                <div class="btn-group" role="group" aria-label="Przełącznik typu dywidend">
                                    <input type="radio" class="btn-check" name="dividendType" id="grossBtn" value="gross">
                                    <label class="btn btn-outline-primary" for="grossBtn">
                                        <i class="bi bi-cash-stack"></i> Dywidendy brutto
                                    </label>
                                    
                                    <input type="radio" class="btn-check" name="dividendType" id="netBtn" value="net" checked>
                                    <label class="btn btn-outline-success" for="netBtn">
                                        <i class="bi bi-cash"></i> Dywidendy netto (po podatku)
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-container" style="position: relative; height:400px; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px; background-color: #f8f9fa;">
                            <canvas id="dividendChart"></canvas>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i>
                                Wykres pokazuje sumę rocznych dywidend brutto i netto (po podatku). 
                                Bieżący rok to estymacja na podstawie wypłaconych dywidend.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wykres break-even dywidend -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">                                     <div class="card-header">
                         <div class="d-flex justify-content-between align-items-center">
                             <h5 class="mb-0">
                                 <i class="bi bi-clock-history"></i> 
                                 Break-even time dla dywidend - ostatnie 15 lat
                             </h5>
                             <div class="d-flex align-items-center">
                                 <label class="me-2 mb-0">Cel ROI:</label>
                                 <div class="input-group input-group-sm" style="width: 120px;">
                                     <button class="btn btn-outline-secondary btn-sm" type="button" onclick="changeTargetPercentage(-0.1)">
                                         <i class="bi bi-dash"></i>
                                     </button>
                                     <input type="number" class="form-control form-control-sm text-center" id="targetPercentage" 
                                            value="5.00" step="0.1" min="0.1" max="20.0" 
                                            onchange="updateBreakEvenChart()">
                                     <button class="btn btn-outline-secondary btn-sm" type="button" onclick="changeTargetPercentage(0.1)">
                                         <i class="bi bi-plus"></i>
                                     </button>
                                 </div>
                                 <span class="ms-2">%</span>
                             </div>
                         </div>
                     </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:400px; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px; background-color: #f8f9fa;">
                        <canvas id="breakEvenChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Wykres pokazuje ile miesięcy potrzeba, żeby dywidenda netto z inwestycji $1000 osiągnęła <span id="targetAmount">$50</span> (<span id="targetPercentageDisplay">5.00</span>% ROI). 
                            Każdy punkt to inwestycja w danym miesiącu po cenie zamknięcia tego miesiąca.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wykres cen tygodniowych -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i> 
                        Analiza techniczna - ceny tygodniowe
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Przełącznik timeframe -->
                    <div class="mb-3">
                        <label for="timeframeSelect" class="form-label">Timeframe:</label>
                        <select class="form-select" id="timeframeSelect" style="width: auto;">
                            <option value="weekly" selected>1W (Tygodniowe)</option>
                            <option value="monthly">1M (Miesięczne)</option>
                            <option value="daily">1D (Dzienne)</option>
                        </select>
                    </div>
                    
                    <div class="chart-container" style="height: 300px; border: 1px solid #ddd; padding: 15px; background-color: #f9f9f9;">
                        <h5>Ceny - ostatnie 15 lat</h5>
                        <canvas id="weeklyPriceChart"></canvas>
                    </div>
                    
                    <!-- Wykres MACD -->
                    <div class="chart-container" style="height: 300px; border: 1px solid #ddd; padding: 15px; background-color: #f9f9f9; margin-top: 20px;">
                        <h5>MACD (8-17-9)</h5>
                        <canvas id="macdChart"></canvas>
                    </div>
                    
                    <!-- Wykres Stochastic Oscillator -->
                    <div class="chart-container" style="height: 300px; border: 1px solid #ddd; padding: 15px; background-color: #f9f9f9; margin-top: 20px;">
                        <h5>Stochastic Oscillator (36-12-12)</h5>
                        <canvas id="stochasticChart"></canvas>
                    </div>
                    
                    <!-- Wykres Krótkiego Stochastic Oscillator -->
                    <div class="chart-container" style="height: 300px; border: 1px solid #ddd; padding: 15px; background-color: #f9f9f9; margin-top: 20px;">
                        <h5>Stochastic Oscillator (9-3-3)</h5>
                        <canvas id="stochasticChartShort"></canvas>
                    </div>
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Wykres pokazuje ceny zamknięcia dla wybranej ramy czasowej (1D/1W/1M). 
                            Ceny są znormalizowane względem splitów akcji.
                        </small>
                        <br>
                        <small class="text-muted">
                            <i class="bi bi-graph-up"></i>
                            MACD: linia zielona (MACD Line), linia czerwona (Signal Line), histogram
                        </small>
                        <br>
                        <small class="text-muted">
                            <i class="bi bi-graph-up"></i>
                            Stochastic Oscillator: %K (zielona), %D (czerwona), poziomy 20% (oversold) i 80% (overbought)
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wykres cen miesięcznych -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i> 
                        Ceny miesięczne - ostatnie 15 lat
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:400px; border: 1px solid #e9ecef; border-radius: 8px; padding: 10px; background-color: #f8f9fa;">
                        <canvas id="priceChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Wykres pokazuje oryginalne ceny historyczne (jakie były w danym momencie). 
                            Dywidendy w tabeli powyżej są znormalizowane względem splitów akcji.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Skrypty JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script>
        // Rejestracja pluginu DataLabels
        Chart.register(ChartDataLabels);
        
        let currentTaxRate = 0.0;
        
        // Inicjalizacja wykresów
        let priceChart = null;
        let weeklyPriceChart = null;
        let macdChart = null;
        let stochasticChart = null;
        let stochasticChartShort = null;
        let dividendChart = null;
        let breakEvenChart = null;
        
        // Funkcja do tworzenia wykresu dywidend
        function createDividendChart(ticker, currentYearEstimate) {
            fetch(`/api/etfs/${ticker}/dividends`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const ctx = document.getElementById('dividendChart').getContext('2d');
                        
                        // Grupowanie dywidend po latach
                        const dividendsByYear = {};
                        data.data.forEach(dividend => {
                            const year = new Date(dividend.payment_date).getFullYear();
                            if (!dividendsByYear[year]) {
                                dividendsByYear[year] = [];
                            }
                            dividendsByYear[year].push(dividend.normalized_amount);
                        });
                        
                        // Przygotowanie danych dla wykresu
                        const years = Object.keys(dividendsByYear).sort();
                        const currentYear = new Date().getFullYear();
                        
                        // Ograniczenie do ostatnich 15 lat
                        const startYear = Math.max(Math.min(...years), currentYear - 14);
                        const filteredYears = years.filter(year => year >= startYear);
                        
                        const labels = filteredYears.map(year => year);
                        const grossData = filteredYears.map(year => {
                            const yearDividends = dividendsByYear[year] || [];
                            let total = yearDividends.reduce((sum, amount) => sum + amount, 0);
                            
                            // Dla bieżącego roku dodaj estymację jeśli dostępna
                            if (parseInt(year) === currentYear && currentYearEstimate) {
                                total = Math.max(total, currentYearEstimate.gross);
                            }
                            
                            return total;
                        });
                        
                        const netData = filteredYears.map(year => {
                            const yearDividends = dividendsByYear[year] || [];
                            let total = yearDividends.reduce((sum, amount) => sum + amount, 0);
                            
                            // Dla bieżącego roku dodaj estymację jeśli dostępna
                            if (parseInt(year) === currentYear && currentYearEstimate) {
                                total = Math.max(total, currentYearEstimate.net);
                            }
                            
                            // Zastosuj podatek
                            return total * (1 - currentTaxRate / 100);
                        });
                        
                        console.log(`📊 Przygotowane dane dywidend: ${labels.length} lat, ${grossData.length} wartości brutto, ${netData.length} wartości netto`);
                        console.log(`📊 Przykładowe dane dywidend:`, {
                            labels: labels.slice(0, 3),
                            grossData: grossData.slice(0, 3),
                            netData: netData.slice(0, 3)
                        });
                        
                        // Sprawdzenie czy dane są poprawne
                        if (grossData.some(g => isNaN(g) || g === null || g === undefined)) {
                            console.error('❌ BŁĄD: Nieprawidłowe dane brutto:', grossData.filter(g => isNaN(g) || g === null || g === undefined));
                        }
                        if (netData.some(n => isNaN(n) || n === null || n === undefined)) {
                            console.error('❌ BŁĄD: Nieprawidłowe dane netto:', netData.filter(n => isNaN(n) || n === null || n === undefined));
                        }
                        
                        // Sprawdzenie zakresu danych
                        const grossMin = Math.min(...grossData);
                        const grossMax = Math.max(...grossData);
                        const netMin = Math.min(...netData);
                        const netMax = Math.max(...netData);
                        console.log(`📊 Zakres dywidend: brutto [${grossMin.toFixed(5)}, ${grossMax.toFixed(5)}], netto [${netMin.toFixed(5)}, ${netMax.toFixed(5)}]`);
                        
                        // Zapisanie danych globalnie dla przełącznika
                        window.dividendChartData = {
                            labels: labels,
                            grossData: grossData,
                            netData: netData,
                            currentYear: currentYear
                        };
                        
                        // Pobranie aktualnie wybranego typu
                        const selectedType = document.querySelector('input[name="dividendType"]:checked').value;
                        updateDividendChart(selectedType);
                        
                        console.log(`Wykres dywidend utworzony dla ${ticker}: ${labels.length} lat`);
                        
                    } else {
                        console.error('Błąd pobierania danych dywidendowych:', data.error);
                        document.getElementById('dividendChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu dywidend</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych dywidendowych:', error);
                    document.getElementById('dividendChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu dywidend</div>';
                });
        }
        
        // Funkcja do aktualizacji wykresu na podstawie wybranego typu
        function updateDividendChart(type) {
            if (!window.dividendChartData) return;
            
            const { labels, grossData, netData, currentYear } = window.dividendChartData;
            const currentYearEstimate = window.currentYearEstimate;
            
            // Wybór danych na podstawie typu
            let data, backgroundColor, borderColor, label, yAxisTitle;
            
            if (type === 'gross') {
                data = grossData;
                backgroundColor = 'rgba(54, 162, 235, 0.8)';
                borderColor = 'rgb(54, 162, 235)';
                label = 'Dywidendy brutto';
                yAxisTitle = 'Suma dywidend brutto ($)';
            } else {
                data = netData;
                backgroundColor = 'rgba(75, 192, 192, 0.8)';
                borderColor = 'rgb(75, 192, 192)';
                label = 'Dywidendy netto (po podatku)';
                yAxisTitle = 'Suma dywidend netto ($)';
            }
            
            // Obliczenie procentów wzrostu względem poprzedniego roku
            const growthPercentages = data.map((value, index) => {
                if (index === 0) return null; // Pierwszy rok - brak poprzedniego
                const previousValue = data[index - 1];
                if (previousValue === 0) return null; // Unikanie dzielenia przez zero
                return ((value - previousValue) / previousValue * 100).toFixed(1);
            });
            
            // Usunięcie poprzedniego wykresu jeśli istnieje
            if (dividendChart) {
                dividendChart.destroy();
            }
            
            // Tworzenie nowego wykresu
            const ctx = document.getElementById('dividendChart').getContext('2d');
            dividendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: data.map((value, index) => {
                            const year = parseInt(labels[index]);
                            const currentYear = new Date().getFullYear();
                            // Bieżący rok - jaśniejszy kolor dla estymacji
                            if (year === currentYear) {
                                if (type === 'gross') {
                                    return 'rgba(54, 162, 235, 0.4)'; // Jaśniejszy niebieski
                                } else {
                                    return 'rgba(75, 192, 192, 0.4)'; // Jaśniejszy zielony
                                }
                            }
                            return backgroundColor;
                        }),
                        borderColor: borderColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: {
                            top: 50
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        tooltip: {
                            enabled: false
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        datalabels: {
                            display: true,
                            color: '#333',
                            anchor: 'end',
                            align: 'top',
                            offset: 4,
                            font: {
                                weight: 'bold',
                                size: 10
                            },
                            formatter: function(value, context) {
                                const growth = growthPercentages[context.dataIndex];
                                let label = `$${formatNumber(value, 4)}`;
                                
                                if (growth !== null) {
                                    const growthSymbol = parseFloat(growth) >= 0 ? '↗' : '↘';
                                    label += `\n${growthSymbol} ${growth}%`;
                                }
                                
                                return label;
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Rok'
                            },
                            ticks: {
                                maxRotation: 0
                            }
                        },
                        y: {
                            display: true,
                            title: {
                                display: true,
                                text: yAxisTitle
                            },
                            ticks: {
                                callback: function(value) {
                                    return '$' + formatNumber(value, 4);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Funkcja do tworzenia wykresu break-even dywidend
        function createBreakEvenChart(ticker) {
            console.log(`🚀 Tworzenie wykresu break-even dla ticker: "${ticker}" (typ: ${typeof ticker}, długość: ${ticker ? ticker.length : 'undefined'})`);
            
            // Sprawdzenie czy ticker jest poprawny
            if (!ticker || ticker.trim() === '') {
                console.error('❌ Ticker jest pusty lub undefined!');
                return;
            }
            
            // Sprawdzenie czy Chart.js jest dostępny
            if (typeof Chart === 'undefined') {
                console.error('❌ Chart.js nie jest załadowany!');
                return;
            }
            console.log(`📊 Chart.js dostępny:`, Chart);
            
            // Sprawdzenie czy element canvas istnieje
            const canvasElement = document.getElementById('breakEvenChart');
            if (!canvasElement) {
                console.error('❌ Element breakEvenChart nie został znaleziony!');
                return;
            }
            console.log(`🎨 Canvas element:`, canvasElement);
            
            // Pobieranie aktualnej wartości target percentage
            const targetPercentageElement = document.getElementById('targetPercentage');
            if (!targetPercentageElement) {
                console.error('❌ Element targetPercentage nie został znaleziony w createBreakEvenChart!');
                return;
            }
            const targetPercentage = targetPercentageElement.value;
            console.log(`📊 Target percentage w createBreakEvenChart: ${targetPercentage}%`);
            
            console.log(`🔗 Tworzę URL: /api/etfs/${ticker}/break-even-dividends?target_percentage=${targetPercentage}`);
            fetch(`/api/etfs/${ticker}/break-even-dividends?target_percentage=${targetPercentage}`)
                .then(response => response.json())
                .then(data => {
                    console.log(`📊 Otrzymane dane break-even:`, data);
                    if (data.success) {
                        const ctx = canvasElement.getContext('2d');
                        console.log(`🎨 Canvas context:`, ctx);
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.data.map(item => item.month);
                        const breakEvenMonths = data.data.data.map(item => item.months_to_break_even);
                        console.log(`📈 Labels:`, labels);
                        console.log(`📊 Break-even months:`, breakEvenMonths);
                        console.log(`📊 Liczba labels:`, labels.length);
                        console.log(`📊 Liczba breakEvenMonths:`, breakEvenMonths.length);
                        console.log(`📊 Pierwsze 5 labels:`, labels.slice(0, 5));
                        console.log(`📊 Pierwsze 5 breakEvenMonths:`, breakEvenMonths.slice(0, 5));
                        
                        // Sprawdzenie czy dane są poprawne
                        if (breakEvenMonths.some(m => isNaN(m) || m === null || m === undefined)) {
                            console.error('❌ BŁĄD: Nieprawidłowe dane break-even:', breakEvenMonths.filter(m => isNaN(m) || m === null || m === undefined));
                        }
                        
                        // Sprawdzenie zakresu danych
                        const monthsMin = Math.min(...breakEvenMonths.filter(m => m !== null));
                        const monthsMax = Math.max(...breakEvenMonths.filter(m => m !== null));
                        console.log(`📊 Zakres break-even: [${monthsMin}, ${monthsMax}] miesięcy`);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (breakEvenChart) {
                            console.log(`🗑️ Usuwanie poprzedniego wykresu break-even...`);
                            breakEvenChart.destroy();
                        }
                        
                        // Tworzenie nowego wykresu
                        console.log(`🎨 Tworzenie obiektu Chart...`);
                        breakEvenChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: `Break-even time ${ticker} (miesiące do ${targetPercentage}% ROI)`,
                                    data: breakEvenMonths,
                                    borderColor: 'rgb(255, 99, 132)',
                                    backgroundColor: 'rgba(255, 99, 132, 0.1)',
                                    borderWidth: 2,
                                    pointRadius: 3,
                                    pointHoverRadius: 6,
                                    tension: 0.1,
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const months = context.parsed.y;
                                                if (months === null) {
                                                    return 'Break-even nie osiągnięty';
                                                }
                                                return `Miesięcy do ${targetPercentage}% ROI: ${months}`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    datalabels: {
                                        display: false  // Wyłącz etykiety z wartościami na punktach
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Miesiąc inwestycji'
                                        },
                                        ticks: {
                                            maxTicksLimit: 20,
                                            maxRotation: 45
                                        }
                                    },
                                    y: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Miesiące do break-even'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                if (value === null) return 'N/A';
                                                return Math.round(value);
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Wykres break-even utworzony pomyślnie!`);
                        console.log(`📊 Wykres ma ${labels.length} punktów danych`);
                        
                        // Sprawdzenie czy wykres jest widoczny
                        setTimeout(() => {
                            console.log(`🔍 Sprawdzenie widoczności wykresu break-even po 1s...`);
                            console.log(`🔍 Canvas dimensions: ${canvasElement.width} x ${canvasElement.height}`);
                            console.log(`🔍 Chart instance:`, breakEvenChart);
                            
                            // Sprawdzenie czy dane są w wykresie
                            if (breakEvenChart.data && breakEvenChart.data.datasets) {
                                console.log(`🔍 Dataset: ${breakEvenChart.data.datasets[0].data.length} punktów`);
                                console.log(`🔍 Labels: ${breakEvenChart.data.labels.length} etykiet`);
                            }
                            
                            // Sprawdzenie czy wykres jest renderowany
                            if (breakEvenChart.width && breakEvenChart.height) {
                                console.log(`🔍 Chart dimensions: ${breakEvenChart.width} x ${breakEvenChart.height}`);
                            } else {
                                console.warn('⚠️ Wykres nie ma wymiarów!');
                            }
                        }, 1000);
                        
                    } else {
                        console.error('❌ Błąd pobierania danych break-even:', data.error);
                        document.getElementById('breakEvenChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu break-even</div>';
                    }
                })
                .catch(error => {
                    console.error('❌ Błąd podczas pobierania danych break-even:', error);
                    document.getElementById('breakEvenChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu break-even</div>';
                });
        }
         
        // Funkcja do zmiany target percentage
        function changeTargetPercentage(delta) {
            console.log(`🔄 Zmiana target percentage o ${delta}`);
            const input = document.getElementById('targetPercentage');
            if (!input) {
                console.error('❌ Element targetPercentage nie został znaleziony!');
                return;
            }
            let currentValue = parseFloat(input.value);
            let newValue = currentValue + delta;
            
            // Ograniczenie wartości do zakresu 0.1 - 20.0
            newValue = Math.max(0.1, Math.min(20.0, newValue));
            
            // Formatowanie do 2 miejsc po przecinku
            input.value = newValue.toFixed(2);
            console.log(`📊 Nowa wartość target percentage: ${newValue}%`);
            
            // Aktualizacja opisów na stronie
            updateTargetDisplays();
            
            // Aktualizacja wykresu
            console.log(`🔄 Wywołanie updateBreakEvenChart()...`);
            updateBreakEvenChart();
        }
        
        // Funkcja do aktualizacji wykresu break-even
        function updateBreakEvenChart() {
            console.log(`🔄 Aktualizacja wykresu break-even...`);
            const h2Element = document.querySelector('h2');
            if (!h2Element) {
                console.error('❌ Element h2 nie został znaleziony!');
                return;
            }
            console.log(`🔍 H2 element text: "${h2Element.textContent}"`);
            // Poprawiona logika wyciągania tickera - ignorujemy puste elementy
            const words = h2Element.textContent.trim().split(/\s+/).filter(word => word.length > 0);
            const currentTicker = words[0];
            console.log(`📊 Słowa po split: [${words.map(w => `"${w}"`).join(', ')}]`);
            console.log(`📊 Znaleziony ticker: "${currentTicker}" (typ: ${typeof currentTicker}, długość: ${currentTicker ? currentTicker.length : 'undefined'})`);
            
            // Sprawdzenie czy ticker jest poprawny
            if (!currentTicker || currentTicker.trim() === '') {
                console.error('❌ Ticker jest pusty lub undefined!');
                return;
            }
            
            // Sprawdzenie czy ticker ma poprawny format
            if (!/^[A-Z]+$/.test(currentTicker)) {
                console.error('❌ Ticker ma nieprawidłowy format:', currentTicker);
                return;
            }
            
            console.log(`✅ Ticker jest poprawny: ${currentTicker}`);
            updateTargetDisplays(); // Aktualizacja opisów przed wykresem
            createBreakEvenChart(currentTicker);
        }
        
        // Funkcja do aktualizacji opisów na stronie
        function updateTargetDisplays() {
            console.log(`🔄 Aktualizacja opisów na stronie...`);
            const targetPercentage = document.getElementById('targetPercentage').value;
            const targetAmount = (1000 * parseFloat(targetPercentage) / 100).toFixed(2);
            console.log(`📊 Target percentage: ${targetPercentage}%, Target amount: $${targetAmount}`);
            
            // Aktualizacja opisu pod wykresem
            const targetAmountElement = document.getElementById('targetAmount');
            const targetPercentageElement = document.getElementById('targetPercentageDisplay');
            
            if (targetAmountElement && targetPercentageElement) {
                targetAmountElement.textContent = `$${targetAmount}`;
                targetPercentageElement.textContent = targetPercentage;
                console.log(`✅ Opisy zaktualizowane: $${targetAmount} (${targetPercentage}%)`);
            } else {
                console.error('❌ Elementy opisów nie zostały znalezione!');
                console.error('  - targetAmountElement:', targetAmountElement);
                console.error('  - targetPercentageElement:', targetPercentageElement);
            }
        }
        
        // Funkcja do tworzenia wykresu cen tygodniowych
        function createWeeklyPriceChart(ticker) {
            console.log(`🔄 Tworzenie wykresu cen tygodniowych dla ${ticker}...`);
            
            fetch(`/api/etfs/${ticker}/weekly-prices`)
                .then(response => {
                    console.log(`📊 Weekly prices response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`📊 Weekly prices data response:`, data);
                    
                    if (data.success) {
                        const canvasElement = document.getElementById('weeklyPriceChart');
                        if (!canvasElement) {
                            console.error('❌ Canvas element weeklyPriceChart nie został znaleziony!');
                            return;
                        }
                        
                        const ctx = canvasElement.getContext('2d');
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.prices.map(p => p.date);
                        const prices = data.data.prices.map(p => p.close_price);
                        
                        console.log(`📊 Przygotowane dane tygodniowe: ${labels.length} etykiet, ${prices.length} cen`);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (weeklyPriceChart) {
                            weeklyPriceChart.destroy();
                        }
                        
                        // Tworzenie nowego wykresu cen tygodniowych
                        weeklyPriceChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: `Cena tygodniowa ${ticker}`,
                                    data: prices,
                                    borderColor: 'rgb(255, 159, 64)',
                                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                                    borderWidth: 2,
                                    pointRadius: 2,
                                    pointHoverRadius: 5,
                                    tension: 0.1,
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: function(context) {
                                                // Format daty: YYYY.MM.DD
                                                const date = new Date(context[0].label);
                                                return date.toISOString().split('T')[0].replace(/-/g, '.');
                                            },
                                            label: function(context) {
                                                const price = context.parsed.y;
                                                return `Cena: $${formatNumber(price, 2)}`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    datalabels: {
                                        display: false  // Wyłącz etykiety z cenami na punktach
                                    }
                                },
                                scales: {
                                    x: {
                                        display: false,  // Ukryj oś X - będzie wspólna z wskaźnikami
                                        grid: {
                                            display: false
                                        }
                                    },
                                    y: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Cena ($)'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return '$' + formatNumber(value, 2);
                                            }
                                        },
                                        grid: {
                                            color: 'rgba(0, 0, 0, 0.1)'
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Wykres cen tygodniowych utworzony pomyślnie!`);
                        
                    } else {
                        console.error('Błąd pobierania danych cen tygodniowych:', data.error);
                        document.getElementById('weeklyPriceChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu cen tygodniowych</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych cen tygodniowych:', error);
                    document.getElementById('weeklyPriceChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu cen tygodniowych</div>';
                });
        }
        
        // Funkcja do tworzenia wykresu Stochastic Oscillator
        function createStochasticChart(ticker) {
            console.log(`🔄 Tworzenie wykresu Stochastic Oscillator dla ${ticker}...`);
            
            fetch(`/api/etfs/${ticker}/weekly-stochastic`)
                .then(response => {
                    console.log(`📊 Response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`📊 Stochastic data response:`, data);
                    
                    if (data.success) {
                        const canvasElement = document.getElementById('stochasticChart');
                        if (!canvasElement) {
                            console.error('❌ Canvas element stochasticChart nie został znaleziony!');
                            return;
                        }
                        
                        console.log(`🔍 Canvas element:`, canvasElement);
                        console.log(`🔍 Canvas dimensions: ${canvasElement.width} x ${canvasElement.height}`);
                        console.log(`🔍 Canvas style:`, window.getComputedStyle(canvasElement));
                        
                        const ctx = canvasElement.getContext('2d');
                        if (!ctx) {
                            console.error('❌ Nie można uzyskać kontekstu 2D!');
                            return;
                        }
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.stochastic.map(s => s.date);
                        const kPercent = data.data.stochastic.map(s => s.k_percent);
                        const dPercent = data.data.stochastic.map(s => s.d_percent);
                        
                        console.log(`📊 Przygotowane dane: ${labels.length} etykiet, ${kPercent.length} wartości %K, ${dPercent.length} wartości %D`);
                        console.log(`📊 Przykładowe dane:`, {
                            labels: labels.slice(0, 3),
                            kPercent: kPercent.slice(0, 3),
                            dPercent: dPercent.slice(0, 3)
                        });
                        
                        // Sprawdzenie czy dane są poprawne
                        if (kPercent.some(k => isNaN(k) || k === null || k === undefined)) {
                            console.error('❌ BŁĄD: Nieprawidłowe dane %K:', kPercent.filter(k => isNaN(k) || k === null || k === undefined));
                        }
                        if (dPercent.some(d => isNaN(d) || d === null || d === undefined)) {
                            console.error('❌ BŁĄD: Nieprawidłowe dane %D:', dPercent.filter(d => isNaN(d) || d === null || d === undefined));
                        }
                        
                        // Sprawdzenie zakresu danych
                        const kMin = Math.min(...kPercent);
                        const kMax = Math.max(...kPercent);
                        const dMin = Math.min(...dPercent);
                        const dMax = Math.max(...dPercent);
                        console.log(`📊 Zakres danych: %K [${kMin.toFixed(2)}, ${kMax.toFixed(2)}], %D [${dMin.toFixed(2)}, ${dMax.toFixed(2)}]`);
                        
                        // Sprawdzenie czy dane są w rozsądnym zakresie (0-100)
                        if (kMin < 0 || kMax > 100) {
                            console.warn('⚠️ Wartości %K są poza zakresem [0, 100]:', { kMin, kMax });
                        }
                        if (dMin < 0 || dMax > 100) {
                            console.warn('⚠️ Wartości %D są poza zakresem [0, 100]:', { dMin, dMax });
                        }
                        
                        // Sprawdzenie czy dane nie są wszystkie takie same
                        if (kMin === kMax) {
                            console.warn('⚠️ Wszystkie wartości %K są takie same:', kMin);
                        }
                        if (dMin === dMax) {
                            console.warn('⚠️ Wszystkie wartości %D są takie same:', dMin);
                        }
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (stochasticChart) {
                            console.log(`🗑️ Usuwanie poprzedniego wykresu Stochastic...`);
                            stochasticChart.destroy();
                        }
                        
                        console.log(`🎨 Tworzenie nowego wykresu Stochastic Oscillator...`);
                        
                        // Tworzenie nowego wykresu Stochastic Oscillator
                        stochasticChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: '%K (zielona)',
                                        data: kPercent,
                                        borderColor: 'rgb(34, 197, 94)',
                                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-stochastic'
                                    },
                                    {
                                        label: '%D (czerwona)',
                                        data: dPercent,
                                        borderColor: 'rgb(239, 68, 68)',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-stochastic'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: function(context) {
                                                // Format daty: YYYY.MM.DD
                                                const date = new Date(context[0].label);
                                                return date.toISOString().split('T')[0].replace(/-/g, '.');
                                            },
                                            label: function(context) {
                                                const value = context.parsed.y;
                                                const datasetLabel = context.dataset.label;
                                                return `${datasetLabel}: ${value.toFixed(2)}%`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    datalabels: {
                                        display: false  // Wyłącz etykiety z wartościami na punktach
                                    }
                                },
                                scales: {
                                    x: {
                                        display: false,  // Ukryj oś X - będzie wspólna z wykresem cen
                                        grid: {
                                            display: false
                                        }
                                    },
                                    'y-stochastic': {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Stochastic %'
                                        },
                                        min: 0,
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        },
                                        grid: {
                                            color: function(context) {
                                                if (context.tick.value === 20 || context.tick.value === 80) {
                                                    return 'rgba(239, 68, 68, 0.5)';  // Czerwone linie dla 20% i 80%
                                                }
                                                return 'rgba(0, 0, 0, 0.1)';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Wykres Stochastic Oscillator utworzony pomyślnie!`);
                        console.log(`📊 Wykres ma ${data.data.count} punktów danych`);
                        
                        // Sprawdzenie czy wykres jest widoczny
                        setTimeout(() => {
                            console.log(`🔍 Sprawdzenie widoczności wykresu Stochastic po 1s...`);
                            console.log(`�� Canvas dimensions: ${canvasElement.width} x ${canvasElement.height}`);
                            console.log(`🔍 Chart instance:`, stochasticChart);
                            console.log(`🔍 Chart data:`, stochasticChart.data);
                            console.log(`🔍 Chart options:`, stochasticChart.options);
                            
                            // Sprawdzenie czy dane są w wykresie
                            if (stochasticChart.data && stochasticChart.data.datasets) {
                                console.log(`🔍 Dataset 1 (%K): ${stochasticChart.data.datasets[0].data.length} punktów`);
                                console.log(`🔍 Dataset 2 (%D): ${stochasticChart.data.datasets[1].data.length} punktów`);
                                console.log(`🔍 Labels: ${stochasticChart.data.labels.length} etykiet`);
                            }
                            
                            // Sprawdzenie czy wykres jest renderowany
                            if (stochasticChart.width && stochasticChart.height) {
                                console.log(`🔍 Chart dimensions: ${stochasticChart.width} x ${stochasticChart.height}`);
                            } else {
                                console.warn('⚠️ Wykres nie ma wymiarów!');
                            }
                        }, 1000);
                        
                    } else {
                        console.error('❌ Błąd pobierania danych Stochastic Oscillator:', data.error);
                        document.getElementById('stochasticChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu Stochastic Oscillator</div>';
                    }
                })
                .catch(error => {
                    console.error('❌ Błąd podczas pobierania danych Stochastic Oscillator:', error);
                    document.getElementById('stochasticChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu Stochastic Oscillator</div>';
                });
        }
        
        // Funkcja do tworzenia wykresu cen
        function createPriceChart(ticker) {
            fetch(`/api/etfs/${ticker}/prices`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const canvasElement = document.getElementById('priceChart');
                        if (!canvasElement) {
                            console.error('❌ Canvas element priceChart nie został znaleziony!');
                            return;
                        }
                        
                        const ctx = canvasElement.getContext('2d');
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.prices.map(p => p.date);
                        const prices = data.data.prices.map(p => p.original_price);
                        
                        console.log(`📊 Przygotowane dane miesięczne: ${labels.length} etykiet, ${prices.length} cen`);
                        console.log(`📊 Przykładowe dane miesięczne:`, {
                            labels: labels.slice(0, 3),
                            prices: prices.slice(0, 3)
                        });
                        
                        // Sprawdzenie czy dane są poprawne
                        if (prices.some(p => isNaN(p) || p === null || p === undefined)) {
                            console.error('❌ BŁĄD: Nieprawidłowe ceny miesięczne:', prices.filter(p => isNaN(p) || p === null || p === undefined));
                        }
                        
                        // Sprawdzenie zakresu cen
                        const priceMin = Math.min(...prices);
                        const priceMax = Math.max(...prices);
                        console.log(`📊 Zakres cen miesięcznych: [${priceMin.toFixed(2)}, ${priceMax.toFixed(2)}]`);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (priceChart) {
                            console.log(`🗑️ Usuwanie poprzedniego wykresu cen miesięcznych...`);
                            priceChart.destroy();
                        }
                        
                        console.log(`🎨 Tworzenie nowego wykresu cen miesięcznych...`);
                        
                        // Tworzenie nowego wykresu
                        priceChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: `Cena miesięczna ${ticker} (oryginalna)`,
                                    data: prices,
                                    borderColor: 'rgb(75, 192, 192)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                    borderWidth: 2,
                                    pointRadius: 3,
                                    pointHoverRadius: 6,
                                    tension: 0.1,
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const price = context.parsed.y;
                                                return `Cena: $${formatNumber(price, 2)}`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Data'
                                        },
                                        ticks: {
                                            maxTicksLimit: 15,
                                            maxRotation: 45
                                        }
                                    },
                                    y: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Cena ($)'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return '$' + formatNumber(value, 2);
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Wykres cen miesięcznych utworzony pomyślnie!`);
                        console.log(`📊 Wykres ma ${data.data.count} punktów danych`);
                        
                        // Sprawdzenie czy wykres jest widoczny
                        setTimeout(() => {
                            console.log(`🔍 Sprawdzenie widoczności wykresu miesięcznego po 1s...`);
                            console.log(`🔍 Canvas dimensions: ${canvasElement.width} x ${canvasElement.height}`);
                            console.log(`🔍 Chart instance:`, priceChart);
                            
                            // Sprawdzenie czy dane są w wykresie
                            if (priceChart.data && priceChart.data.datasets) {
                                console.log(`🔍 Dataset: ${priceChart.data.datasets[0].data.length} punktów`);
                                console.log(`🔍 Labels: ${priceChart.data.labels.length} etykiet`);
                            }
                            
                            // Sprawdzenie czy wykres jest renderowany
                            if (priceChart.width && priceChart.height) {
                                console.log(`🔍 Chart dimensions: ${priceChart.width} x ${priceChart.height}`);
                            } else {
                                console.warn('⚠️ Wykres nie ma wymiarów!');
                            }
                        }, 1000);
                        
                    } else {
                        console.error('❌ Błąd pobierania danych cenowych:', data.error);
                        document.getElementById('priceChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu cen</div>';
                    }
                })
                .catch(error => {
                    console.error('❌ Błąd podczas pobierania danych cenowych:', error);
                    document.getElementById('priceChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu cen</div>';
                });
        }
        
        // Inicjalizacja wykresu po załadowaniu strony
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, initializing...');
            const ticker = '{{ etf.ticker }}';
            console.log('📊 Ticker:', ticker);
            
            console.log('🔄 Rozpoczynam tworzenie wykresów...');
            
            console.log('📊 1. Tworzenie wykresu cen miesięcznych...');
            createPriceChart(ticker);
            
            console.log('📊 2. Tworzenie wykresu cen tygodniowych...');
            createWeeklyPriceChart(ticker);
            
            console.log('📊 2a. Tworzenie wykresu MACD (8-17-9)...');
            createMACDChart(ticker);
            
            console.log('📊 3. Tworzenie wykresu Stochastic Oscillator...');
            createStochasticChart(ticker); // Dodanie wywołania createStochasticChart
            
            console.log('📊 3a. Tworzenie krótkiego wykresu Stochastic Oscillator (9-3-3)...');
            createStochasticChartShort(ticker);
            
            console.log('📊 4. Tworzenie wykresu break-even...');
            createBreakEvenChart(ticker);
            
            console.log('✅ Wszystkie wykresy zostały zainicjalizowane');
            
            // Debug - sprawdzenie stanu wszystkich wykresów po 2 sekundach
            setTimeout(() => {
                console.log('🔍 === SPRAWDZENIE STANU WSZYSTKICH WYKRESÓW ===');
                console.log('📊 Price Chart:', priceChart ? 'OK' : 'NULL');
                console.log('📊 Weekly Price Chart:', weeklyPriceChart ? 'OK' : 'NULL');
                console.log('📊 MACD Chart:', macdChart ? 'OK' : 'NULL');
                console.log('📊 Stochastic Chart:', stochasticChart ? 'OK' : 'NULL');
                console.log('📊 Stochastic Short Chart:', stochasticChartShort ? 'OK' : 'NULL');
                console.log('📊 Dividend Chart:', dividendChart ? 'OK' : 'NULL');
                console.log('📊 Break Even Chart:', breakEvenChart ? 'OK' : 'NULL');
                
                // Sprawdzenie canvas elementów
                const priceCanvas = document.getElementById('priceChart');
                const weeklyCanvas = document.getElementById('weeklyPriceChart');
                const macdCanvas = document.getElementById('macdChart');
                const stochasticCanvas = document.getElementById('stochasticChart');
                const stochasticShortCanvas = document.getElementById('stochasticChartShort');
                const dividendCanvas = document.getElementById('dividendChart');
                const breakEvenCanvas = document.getElementById('breakEvenChart');
                
                console.log('🔍 Canvas elements:');
                console.log('  - priceChart:', priceCanvas ? `${priceCanvas.width}x${priceCanvas.height}` : 'NOT FOUND');
                console.log('  - weeklyPriceChart:', weeklyCanvas ? `${weeklyCanvas.width}x${weeklyCanvas.height}` : 'NOT FOUND');
                console.log('  - macdChart:', macdCanvas ? `${macdCanvas.width}x${macdCanvas.height}` : 'NOT FOUND');
                console.log('  - stochasticChart:', stochasticCanvas ? `${stochasticCanvas.width}x${stochasticCanvas.height}` : 'NOT FOUND');
                console.log('  - stochasticShortChart:', stochasticShortCanvas ? `${stochasticShortCanvas.width}x${stochasticShortCanvas.height}` : 'NOT FOUND');
                console.log('  - dividendChart:', dividendCanvas ? `${dividendCanvas.width}x${dividendCanvas.height}` : 'NOT FOUND');
                console.log('  - breakEvenChart:', breakEvenCanvas ? `${breakEvenCanvas.width}x${breakEvenCanvas.height}` : 'NOT FOUND');
                
                // Sprawdzenie stylów
                if (stochasticCanvas) {
                    const style = window.getComputedStyle(stochasticCanvas);
                    console.log('🔍 Stochastic Canvas styles:');
                    console.log('  - display:', style.display);
                    console.log('  - visibility:', style.visibility);
                    console.log('  - opacity:', style.opacity);
                    console.log('  - width:', style.width);
                    console.log('  - height:', style.height);
                }
                
                console.log('🔍 === KONIEC SPRAWDZENIA ===');
            }, 2000);
            
            // Inicjalizacja opisów target percentage
            updateTargetDisplays();
            
            // Pobieranie estymacji bieżącego roku z nagłówka
            const lastDividendsSumElement = document.getElementById('lastDividendsSum');
            let currentYearEstimate = null;
            if (lastDividendsSumElement) {
                const originalValue = parseFloat(lastDividendsSumElement.getAttribute('data-original'));
                if (originalValue && !isNaN(originalValue)) {
                    currentYearEstimate = {
                        gross: originalValue,
                        net: originalValue // Będzie przeliczane po załadowaniu stawki podatku
                    };
                }
            }
            
            createDividendChart(ticker, currentYearEstimate);
            
            // Dodanie event listener dla przełącznika brutto/netto
            document.querySelectorAll('input[name="dividendType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    updateDividendChart(this.value);
                });
            });
            
            // Ładowanie stawki podatku i przeliczanie wartości
            console.log('🔄 Calling loadTaxRate()...');
            loadTaxRate();
        });
        
        // Funkcja do formatowania liczb z przecinkiem (polski format)
        function formatNumber(number, decimals = 2) {
            if (isNaN(number)) return 'N/A';
            return number.toFixed(decimals).replace('.', ',');
        }
        
        // Funkcje pomocnicze do obliczania wartości po podatku
        function calculateAfterTaxYield(originalYield, taxRate) {
            if (taxRate <= 0) return originalYield;
            return originalYield * (1 - taxRate / 100);
        }

        function calculateAfterTaxAmount(originalAmount, taxRate) {
            if (taxRate <= 0) return originalAmount;
            return originalAmount * (1 - taxRate / 100);
        }
        
        // Funkcje do obsługi podatku od dywidend
        
        async function loadTaxRate() {
            try {
                console.log('🔄 Fetching tax rate from API...');
                const response = await fetch('/api/system/dividend-tax-rate');
                const result = await response.json();
                console.log('📊 API response:', result);
                
                if (result.success) {
                    currentTaxRate = result.data.tax_rate;
                    console.log('📊 Tax rate loaded:', currentTaxRate);
                    
                    // Aktualizacja badge z stawką podatku
                    const taxRateElement = document.getElementById('currentTaxRate');
                    if (taxRateElement) {
                        taxRateElement.textContent = currentTaxRate;
                        console.log('✅ Tax rate badge updated');
                    } else {
                        console.error('❌ Tax rate element not found');
                    }
                    
                    // Przeliczenie wszystkich wartości
                    console.log('🔄 Calling recalculateAllValues()...');
                    recalculateAllValues();
                } else {
                    console.error('❌ API returned error:', result.error);
                }
            } catch (error) {
                console.error('❌ Error loading tax rate:', error);
            }
        }
        
        function recalculateAllValues() {
            console.log('🔢 Recalculating values with tax rate:', currentTaxRate);
            
            // Przeliczenie yield w nagłówku - BRUTTO i NETTO w formacie 2 miejsc po przecinku
            const currentYieldElement = document.getElementById('currentYield');
            if (currentYieldElement) {
                const originalYield = parseFloat(currentYieldElement.getAttribute('data-original'));
                if (originalYield && !isNaN(originalYield)) {
                    const afterTaxYield = calculateAfterTaxYield(originalYield, currentTaxRate);
                    currentYieldElement.textContent = `${formatNumber(originalYield, 2)} (B), ${formatNumber(afterTaxYield, 2)} (N)`;
                    console.log(`✅ Yield przeliczony: ${originalYield}% -> ${afterTaxYield}%`);
                } else {
                    console.warn('⚠️ Brak oryginalnej wartości yield do przeliczenia');
                }
            } else {
                console.error('❌ Element currentYield nie został znaleziony');
            }
            
            // Przeliczenie sumy ostatnich dywidend w nagłówku - BRUTTO i NETTO w jednej linii
            const lastDividendsSumElement = document.getElementById('lastDividendsSum');
            if (lastDividendsSumElement) {
                const originalValue = parseFloat(lastDividendsSumElement.getAttribute('data-original'));
                if (originalValue && !isNaN(originalValue)) {
                    const afterTaxValue = calculateAfterTaxAmount(originalValue, currentTaxRate);
                    lastDividendsSumElement.textContent = `${formatNumber(originalValue, 5)} (B), ${formatNumber(afterTaxValue, 5)} (N)`;
                    console.log(`✅ Suma dywidend przeliczona: $${originalValue} -> $${afterTaxValue}`);
                } else {
                    console.warn('⚠️ Brak oryginalnej wartości sumy dywidend do przeliczenia');
                }
            } else {
                console.error('❌ Element lastDividendsSum nie został znaleziony');
            }
            
            // Przeliczenie kolumny "Suma Roczna" w tabeli dywidend
            console.log('🔄 Przeliczanie sum rocznych w tabeli dywidend...');
            recalculateYearlyTotals();
            
            // Aktualizacja wykresu dywidend z nową stawką podatku
            if (dividendChart && window.dividendChartData) {
                console.log('🔄 Aktualizacja wykresu dywidend z nową stawką podatku...');
                // Aktualizacja danych netto z nową stawką podatku
                const { labels, grossData, currentYear } = window.dividendChartData;
                const lastDividendsSumElement = document.getElementById('lastDividendsSum');
                
                if (lastDividendsSumElement) {
                    const originalValue = parseFloat(lastDividendsSumElement.getAttribute('data-original'));
                    if (originalValue && !isNaN(originalValue)) {
                        // Aktualizacja estymacji bieżącego roku
                        window.currentYearEstimate = {
                            gross: originalValue,
                            net: originalValue * (1 - currentTaxRate / 100)
                        };
                        
                        // Aktualizacja danych netto z nową stawką podatku
                        window.dividendChartData.netData = grossData.map(gross => gross * (1 - currentTaxRate / 100));
                        
                        // Pobranie aktualnie wybranego typu i aktualizacja wykresu
                        const selectedType = document.querySelector('input[name="dividendType"]:checked').value;
                        console.log(`🔄 Aktualizacja wykresu dywidend dla typu: ${selectedType}`);
                        updateDividendChart(selectedType);
                    }
                }
            } else {
                console.log('⚠️ Wykres dywidend nie jest dostępny do aktualizacji');
            }
        }
        
        function recalculateYearlyTotals() {
            console.log('🔄 Przeliczanie sum rocznych w tabeli dywidend...');
            
            // Przeliczenie kolumny "Suma Roczna"
            const yearlyTotalCells = document.querySelectorAll('.yearly-total');
            console.log(`📊 Znaleziono ${yearlyTotalCells.length} komórek z sumami rocznymi`);
            
            yearlyTotalCells.forEach((cell, index) => {
                const originalValue = parseFloat(cell.getAttribute('data-original'));
                if (originalValue && !isNaN(originalValue)) {
                    const afterTaxValue = calculateAfterTaxAmount(originalValue, currentTaxRate);
                    cell.innerHTML = `
                        <div class="text-center">
                            <div class="fw-bold">${formatNumber(afterTaxValue, 5)}</div>
                            <small class="text-muted">${formatNumber(originalValue, 5)}</small>
                        </div>
                    `;
                    console.log(`✅ Suma roczna ${index + 1}: $${originalValue} -> $${afterTaxValue}`);
                } else {
                    console.warn(`⚠️ Brak oryginalnej wartości dla sumy rocznej ${index + 1}`);
                }
            });
            
            // Przeliczenie WSZYSTKICH komórek z dywidendami (miesięczne/kwartalne)
            const allDividendCells = document.querySelectorAll('.monthly-dividend, .dividend-summary');
            console.log(`📊 Znaleziono ${allDividendCells.length} komórek z dywidendami miesięcznymi/kwartalnymi`);
            
            allDividendCells.forEach((cell, index) => {
                const originalValue = parseFloat(cell.getAttribute('data-original'));
                if (originalValue && !isNaN(originalValue)) {
                    const afterTaxValue = calculateAfterTaxAmount(originalValue, currentTaxRate);
                    cell.innerHTML = `
                        <div class="text-center">
                            <div class="fw-bold">${formatNumber(afterTaxValue, 5)}</div>
                            <small class="text-muted">${formatNumber(originalValue, 5)}</small>
                        </div>
                    `;
                    if (index < 5) { // Loguj tylko pierwsze 5 dla czytelności
                        console.log(`✅ Dywidenda ${index + 1}: $${originalValue} -> $${afterTaxValue}`);
                    }
                } else {
                    if (index < 5) { // Loguj tylko pierwsze 5 dla czytelności
                        console.warn(`⚠️ Brak oryginalnej wartości dla dywidendy ${index + 1}`);
                    }
                }
            });
            
            console.log('✅ Przeliczanie sum rocznych zakończone');
        }
        
        // Funkcja do tworzenia krótkiego wykresu Stochastic Oscillator (9-3-3)
        function createStochasticChartShort(ticker) {
            console.log(`🔄 Tworzenie krótkiego wykresu Stochastic Oscillator (9-3-3) dla ${ticker}...`);
            
            fetch(`/api/etfs/${ticker}/weekly-stochastic-short`)
                .then(response => {
                    console.log(`📊 Short Stochastic response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`📊 Short Stochastic data response:`, data);
                    
                    if (data.success) {
                        const canvasElement = document.getElementById('stochasticChartShort');
                        if (!canvasElement) {
                            console.error('❌ Canvas element stochasticChartShort nie został znaleziony!');
                            return;
                        }
                        
                        const ctx = canvasElement.getContext('2d');
                        if (!ctx) {
                            console.error('❌ Nie można uzyskać kontekstu 2D dla krótkiego Stochastic!');
                            return;
                        }
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.stochastic.map(s => s.date);
                        const kPercent = data.data.stochastic.map(s => s.k_percent);
                        const dPercent = data.data.stochastic.map(s => s.d_percent);
                        
                        console.log(`📊 Krótki Stochastic: ${labels.length} etykiet, ${kPercent.length} wartości %K, ${dPercent.length} wartości %D`);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (stochasticChartShort) {
                            stochasticChartShort.destroy();
                        }
                        
                        // Tworzenie nowego wykresu krótkiego Stochastic Oscillator
                        stochasticChartShort = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: '%K (zielona)',
                                        data: kPercent,
                                        borderColor: 'rgb(34, 197, 94)',
                                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-stochastic-short'
                                    },
                                    {
                                        label: '%D (czerwona)',
                                        data: dPercent,
                                        borderColor: 'rgb(239, 68, 68)',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-stochastic-short'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: function(context) {
                                                // Format daty: YYYY.MM.DD
                                                const date = new Date(context[0].label);
                                                return date.toISOString().split('T')[0].replace(/-/g, '.');
                                            },
                                            label: function(context) {
                                                const value = context.parsed.y;
                                                const datasetLabel = context.dataset.label;
                                                return `${datasetLabel}: ${value.toFixed(2)}%`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    datalabels: {
                                        display: false  // Wyłącz etykiety z wartościami na punktach
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Data'
                                        },
                                        grid: {
                                            display: true
                                        }
                                    },
                                    'y-stochastic-short': {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Stochastic %'
                                        },
                                        min: 0,
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        },
                                        grid: {
                                            color: function(context) {
                                                if (context.tick.value === 20 || context.tick.value === 80) {
                                                    return 'rgba(239, 68, 68, 0.5)';  // Czerwone linie dla 20% i 80%
                                                }
                                                return 'rgba(0, 0, 0, 0.1)';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Krótki wykres Stochastic Oscillator (9-3-3) utworzony pomyślnie!`);
                        
                    } else {
                        console.error('Błąd pobierania danych krótkiego Stochastic:', data.error);
                        document.getElementById('stochasticChartShort').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować krótkiego wykresu Stochastic Oscillator</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych krótkiego Stochastic:', error);
                    document.getElementById('stochasticChartShort').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania krótkiego wykresu Stochastic Oscillator</div>';
                });
        }

        // Funkcja do tworzenia wykresu MACD (8-17-9)
        function createMACDChart(ticker) {
            console.log(`🔄 Tworzenie wykresu MACD (8-17-9) dla ${ticker}...`);
            
            fetch(`/api/etfs/${ticker}/weekly-macd`)
                .then(response => {
                    console.log(`📊 MACD response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`📊 MACD data response:`, data);
                    
                    if (data.success) {
                        const canvasElement = document.getElementById('macdChart');
                        if (!canvasElement) {
                            console.error('❌ Canvas element macdChart nie został znaleziony!');
                            return;
                        }
                        
                        const ctx = canvasElement.getContext('2d');
                        if (!ctx) {
                            console.error('❌ Nie można uzyskać kontekstu 2D dla MACD!');
                            return;
                        }
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.macd.map(m => m.date);
                        const macdLine = data.data.macd.map(m => m.macd_line);
                        const signalLine = data.data.macd.map(m => m.signal_line);
                        const histogram = data.data.macd.map(m => m.histogram);
                        
                        console.log(`📊 MACD: ${labels.length} etykiet, ${macdLine.length} wartości MACD Line, ${signalLine.length} wartości Signal Line`);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (macdChart) {
                            macdChart.destroy();
                        }
                        
                        // Tworzenie nowego wykresu MACD
                        macdChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'MACD Line (zielona)',
                                        data: macdLine,
                                        borderColor: 'rgb(34, 197, 94)',
                                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-macd'
                                    },
                                    {
                                        label: 'Signal Line (czerwona)',
                                        data: signalLine,
                                        borderColor: 'rgb(239, 68, 68)',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-macd'
                                    },
                                    {
                                        label: 'Histogram',
                                        data: histogram,
                                        type: 'bar',
                                        backgroundColor: histogram.map(h => h >= 0 ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)'),
                                        borderColor: histogram.map(h => h >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                                        borderWidth: 1,
                                        yAxisID: 'y-macd'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: function(context) {
                                                // Format daty: YYYY.MM.DD
                                                const date = new Date(context[0].label);
                                                return date.toISOString().split('T')[0].replace(/-/g, '.');
                                            },
                                            label: function(context) {
                                                const value = context.parsed.y;
                                                const datasetLabel = context.dataset.label;
                                                if (datasetLabel === 'Histogram') {
                                                    return `${datasetLabel}: ${value.toFixed(4)}`;
                                                }
                                                return `${datasetLabel}: ${value.toFixed(4)}`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    datalabels: {
                                        display: false  // Wyłącz etykiety z wartościami na punktach
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Data'
                                        },
                                        grid: {
                                            display: true
                                        }
                                    },
                                    'y-macd': {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'MACD'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return value.toFixed(4);
                                            }
                                        },
                                        grid: {
                                            color: 'rgba(0, 0, 0, 0.1)'
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Wykres MACD (8-17-9) utworzony pomyślnie!`);
                        
                    } else {
                        console.error('Błąd pobierania danych MACD:', data.error);
                        document.getElementById('macdChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu MACD</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych MACD:', error);
                    document.getElementById('macdChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu MACD</div>';
                });
        }

        // Funkcja do przełączania timeframe i aktualizacji wszystkich wykresów
        function switchTimeframe(timeframe) {
            // Pobierz ticker z aktualnej strony
            const ticker = window.location.pathname.split('/').pop();
            console.log(`🔄 Przełączanie timeframe na: ${timeframe} dla ticker: ${ticker}`);
            console.log(`🔍 Debug: timeframe = "${timeframe}", ticker = "${ticker}"`);
            
            // Aktualizacja wykresu cen
            if (timeframe === 'weekly') {
                console.log(`📊 Wywołuję createWeeklyPriceChart(${ticker})`);
                createWeeklyPriceChart(ticker);
            } else if (timeframe === 'monthly') {
                console.log(`📊 Wywołuję createMonthlyPriceChart(${ticker})`);
                createMonthlyPriceChart(ticker);
            } else if (timeframe === 'daily') {
                console.log(`📊 Wywołuję createDailyPriceChart(${ticker})`);
                createDailyPriceChart(ticker);
            } else {
                console.error(`❌ Nieznany timeframe: "${timeframe}"`);
            }
            
            // Aktualizacja wszystkich wskaźników technicznych
            if (timeframe === 'weekly') {
                console.log(`📊 Wywołuję wskaźniki tygodniowe dla ${ticker}`);
                createMACDChart(ticker);
                createStochasticChart(ticker);
                createStochasticChartShort(ticker);
            } else if (timeframe === 'monthly') {
                console.log(`📊 Wywołuję wskaźniki miesięczne dla ${ticker}`);
                createMonthlyMACDChart(ticker);
                createMonthlyStochasticChart(ticker);
                createMonthlyStochasticChartShort(ticker);
            } else if (timeframe === 'daily') {
                console.log(`📊 Wywołuję wskaźniki dzienne dla ${ticker}`);
                createDailyMACDChart(ticker);
                createDailyStochasticChart(ticker);
                createDailyStochasticShortChart(ticker);
            } else {
                console.error(`❌ Nieznany timeframe dla wskaźników: "${timeframe}"`);
            }
            
            console.log(`✅ Funkcja switchTimeframe zakończona dla ${timeframe}`);
        }

        // Event listener dla przełącznika timeframe
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, dodaję event listener dla timeframe...');
            const timeframeSelect = document.getElementById('timeframeSelect');
            console.log('🔍 Znaleziony timeframeSelect:', timeframeSelect);
            
            if (timeframeSelect) {
                console.log('✅ Dodaję event listener dla timeframeSelect');
                timeframeSelect.addEventListener('change', function() {
                    const selectedTimeframe = this.value;
                    console.log(`🔄 Event listener: zmiana timeframe na "${selectedTimeframe}"`);
                    console.log(`🔍 this.value = "${this.value}", selectedTimeframe = "${selectedTimeframe}"`);
                    switchTimeframe(selectedTimeframe);
                });
                console.log('✅ Event listener dodany pomyślnie');
            } else {
                console.error('❌ Nie znaleziono elementu timeframeSelect!');
            }
        });

        // Funkcja do tworzenia wykresu cen miesięcznych
        function createMonthlyPriceChart(ticker) {
            console.log(`🔄 Tworzenie wykresu cen miesięcznych dla ${ticker}...`);
            
            fetch(`/api/etfs/${ticker}/monthly-prices`)
                .then(response => {
                    console.log(`📊 Monthly prices response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`📊 Monthly prices data response:`, data);
                    
                    if (data.success) {
                        const canvasElement = document.getElementById('weeklyPriceChart');
                        if (!canvasElement) {
                            console.error('❌ Canvas element weeklyPriceChart nie został znaleziony!');
                            return;
                        }
                        
                        const ctx = canvasElement.getContext('2d');
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.prices.map(p => p.date);
                        const prices = data.data.prices.map(p => p.close_price);
                        
                        console.log(`📊 Przygotowane dane miesięczne: ${labels.length} etykiet, ${prices.length} cen`);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (weeklyPriceChart) {
                            weeklyPriceChart.destroy();
                        }
                        
                        // Tworzenie nowego wykresu cen miesięcznych
                        weeklyPriceChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: `Cena miesięczna ${ticker}`,
                                    data: prices,
                                    borderColor: 'rgb(255, 159, 64)',
                                    backgroundColor: 'rgba(255, 159, 64, 0.1)',
                                    borderWidth: 2,
                                    pointRadius: 2,
                                    pointHoverRadius: 5,
                                    tension: 0.1,
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: function(context) {
                                                // Format daty: YYYY.MM.DD
                                                const date = new Date(context[0].label);
                                                return date.toISOString().split('T')[0].replace(/-/g, '.');
                                            },
                                            label: function(context) {
                                                const price = context.parsed.y;
                                                return `Cena: $${formatNumber(price, 2)}`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    datalabels: {
                                        display: false  // Wyłącz etykiety z cenami na punktach
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Data'
                                        },
                                        grid: {
                                            display: true
                                        }
                                    },
                                    y: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Cena ($)'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return '$' + formatNumber(value, 2);
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Wykres cen miesięcznych utworzony pomyślnie!`);
                        
                    } else {
                        console.error('Błąd pobierania danych cen miesięcznych:', data.error);
                        document.getElementById('weeklyPriceChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu cen miesięcznych</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych cen miesięcznych:', error);
                    document.getElementById('weeklyPriceChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu cen miesięcznych</div>';
                });
        }

        // Funkcja do tworzenia wykresu MACD (8-17-9)
        function createMonthlyMACDChart(ticker) {
            console.log(`🔄 Tworzenie wykresu MACD (8-17-9) dla ${ticker}...`);
            
            fetch(`/api/etfs/${ticker}/monthly-macd`)
                .then(response => {
                    console.log(`📊 Monthly MACD response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`📊 Monthly MACD data response:`, data);
                    
                    if (data.success) {
                        const canvasElement = document.getElementById('macdChart');
                        if (!canvasElement) {
                            console.error('❌ Canvas element macdChart nie został znaleziony!');
                            return;
                        }
                        
                        const ctx = canvasElement.getContext('2d');
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.macd.map(m => m.date);
                        const macdLine = data.data.macd.map(m => m.macd_line);
                        const signalLine = data.data.macd.map(m => m.signal_line);
                        const histogram = data.data.macd.map(m => m.histogram);
                        
                        console.log(`📊 Monthly MACD: ${labels.length} etykiet, ${macdLine.length} wartości MACD Line, ${signalLine.length} wartości Signal Line`);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (macdChart) {
                            macdChart.destroy();
                        }
                        
                        // Tworzenie nowego wykresu MACD
                        macdChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'MACD Line (zielona)',
                                        data: macdLine,
                                        borderColor: 'rgb(34, 197, 94)',
                                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-macd'
                                    },
                                    {
                                        label: 'Signal Line (czerwona)',
                                        data: signalLine,
                                        borderColor: 'rgb(239, 68, 68)',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-macd'
                                    },
                                    {
                                        label: 'Histogram',
                                        data: histogram,
                                        type: 'bar',
                                        backgroundColor: histogram.map(h => h >= 0 ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)'),
                                        borderColor: histogram.map(h => h >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                                        borderWidth: 1,
                                        yAxisID: 'y-macd'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: function(context) {
                                                // Format daty: YYYY.MM.DD
                                                const date = new Date(context[0].label);
                                                return date.toISOString().split('T')[0].replace(/-/g, '.');
                                            },
                                            label: function(context) {
                                                const value = context.parsed.y;
                                                const datasetLabel = context.dataset.label;
                                                if (datasetLabel === 'Histogram') {
                                                    return `${datasetLabel}: ${value.toFixed(4)}`;
                                                }
                                                return `${datasetLabel}: ${value.toFixed(4)}`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    datalabels: {
                                        display: false  // Wyłącz etykiety z wartościami na punktach
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Data'
                                        },
                                        grid: {
                                            display: true
                                        }
                                    },
                                    'y-macd': {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'MACD'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return value.toFixed(4);
                                            }
                                        },
                                        grid: {
                                            color: 'rgba(0, 0, 0, 0.1)'
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Wykres MACD (8-17-9) utworzony pomyślnie!`);
                        
                    } else {
                        console.error('Błąd pobierania danych MACD:', data.error);
                        document.getElementById('macdChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu MACD</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych MACD:', error);
                    document.getElementById('macdChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu MACD</div>';
                });
        }

        // Funkcja do tworzenia wykresu Stochastic Oscillator
        function createMonthlyStochasticChart(ticker) {
            console.log(`🔄 Tworzenie wykresu Stochastic Oscillator dla ${ticker}...`);
            
            fetch(`/api/etfs/${ticker}/monthly-stochastic`)
                .then(response => {
                    console.log(`📊 Monthly Stochastic response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`📊 Monthly Stochastic data response:`, data);
                    
                    if (data.success) {
                        const canvasElement = document.getElementById('stochasticChart');
                        if (!canvasElement) {
                            console.error('❌ Canvas element stochasticChart nie został znaleziony!');
                            return;
                        }
                        
                        const ctx = canvasElement.getContext('2d');
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.stochastic.map(s => s.date);
                        const kPercent = data.data.stochastic.map(s => s.k_percent);
                        const dPercent = data.data.stochastic.map(s => s.d_percent);
                        
                        console.log(`📊 Monthly Stochastic: ${labels.length} etykiet, ${kPercent.length} wartości %K, ${dPercent.length} wartości %D`);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (stochasticChart) {
                            stochasticChart.destroy();
                        }
                        
                        // Tworzenie nowego wykresu Stochastic Oscillator
                        stochasticChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: '%K (zielona)',
                                        data: kPercent,
                                        borderColor: 'rgb(34, 197, 94)',
                                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-stochastic'
                                    },
                                    {
                                        label: '%D (czerwona)',
                                        data: dPercent,
                                        borderColor: 'rgb(239, 68, 68)',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-stochastic'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: function(context) {
                                                // Format daty: YYYY.MM.DD
                                                const date = new Date(context[0].label);
                                                return date.toISOString().split('T')[0].replace(/-/g, '.');
                                            },
                                            label: function(context) {
                                                const value = context.parsed.y;
                                                const datasetLabel = context.dataset.label;
                                                return `${datasetLabel}: ${value.toFixed(2)}%`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    datalabels: {
                                        display: false  // Wyłącz etykiety z wartościami na punktach
                                    }
                                },
                                scales: {
                                    x: {
                                        display: false,  // Ukryj oś X - będzie wspólna z wykresem cen
                                        grid: {
                                            display: false
                                        }
                                    },
                                    'y-stochastic': {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Stochastic %'
                                        },
                                        min: 0,
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        },
                                        grid: {
                                            color: function(context) {
                                                if (context.tick.value === 20 || context.tick.value === 80) {
                                                    return 'rgba(239, 68, 68, 0.5)';  // Czerwone linie dla 20% i 80%
                                                }
                                                return 'rgba(0, 0, 0, 0.1)';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Wykres Stochastic Oscillator (36-12-12) utworzony pomyślnie!`);
                        
                    } else {
                        console.error('Błąd pobierania danych Stochastic:', data.error);
                        document.getElementById('stochasticChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu Stochastic Oscillator</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych Stochastic:', error);
                    document.getElementById('stochasticChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu Stochastic Oscillator</div>';
                });
        }

        // Funkcja do tworzenia krótkiego wykresu Stochastic Oscillator (9-3-3) dla danych miesięcznych
        function createMonthlyStochasticShortChart(ticker) {
            console.log(`🔄 Tworzenie krótkiego wykresu Stochastic Oscillator (9-3-3) dla ${ticker}...`);
            
            fetch(`/api/etfs/${ticker}/monthly-stochastic-short`)
                .then(response => {
                    console.log(`📊 Monthly Stochastic Short response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`📊 Monthly Stochastic Short data response:`, data);
                    
                    if (data.success) {
                        const canvasElement = document.getElementById('stochasticChartShort');
                        if (!canvasElement) {
                            console.error('❌ Canvas element stochasticChartShort nie został znaleziony!');
                            return;
                        }
                        
                        const ctx = canvasElement.getContext('2d');
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.stochastic.map(s => s.date);
                        const kPercent = data.data.stochastic.map(s => s.k_percent);
                        const dPercent = data.data.stochastic.map(s => s.d_percent);
                        
                        console.log(`📊 Monthly Stochastic Short: ${labels.length} etykiet, ${kPercent.length} wartości %K, ${dPercent.length} wartości %D`);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (stochasticChartShort) {
                            stochasticChartShort.destroy();
                        }
                        
                        // Tworzenie nowego wykresu Stochastic Oscillator
                        stochasticChartShort = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: '%K (zielona)',
                                        data: kPercent,
                                        borderColor: 'rgb(34, 197, 94)',
                                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-stochastic-short'
                                    },
                                    {
                                        label: '%D (czerwona)',
                                        data: dPercent,
                                        borderColor: 'rgb(239, 68, 68)',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-stochastic-short'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: function(context) {
                                                // Format daty: YYYY.MM.DD
                                                const date = new Date(context[0].label);
                                                return date.toISOString().split('T')[0].replace(/-/g, '.');
                                            },
                                            label: function(context) {
                                                const value = context.parsed.y;
                                                const datasetLabel = context.dataset.label;
                                                return `${datasetLabel}: ${value.toFixed(2)}%`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    datalabels: {
                                        display: false  // Wyłącz etykiety z wartościami na punktach
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Data'
                                        },
                                        grid: {
                                            display: true
                                        }
                                    },
                                    'y-stochastic-short': {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Stochastic %'
                                        },
                                        min: 0,
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        },
                                        grid: {
                                            color: function(context) {
                                                if (context.tick.value === 20 || context.tick.value === 80) {
                                                    return 'rgba(239, 68, 68, 0.5)';  // Czerwone linie dla 20% i 80%
                                                }
                                                return 'rgba(0, 0, 0, 0.1)';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Krótki wykres Stochastic Oscillator (9-3-3) utworzony pomyślnie!`);
                        
                    } else {
                        console.error('Błąd pobierania danych krótkiego Stochastic:', data.error);
                        document.getElementById('stochasticChartShort').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować krótkiego wykresu Stochastic Oscillator</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych krótkiego Stochastic:', error);
                    document.getElementById('stochasticChartShort').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania krótkiego wykresu Stochastic Oscillator</div>';
                });
        }

        // Funkcja do tworzenia wykresu cen dziennych
        function createDailyPriceChart(ticker) {
            console.log(`🔄 Tworzenie wykresu cen dziennych dla ${ticker}...`);
            
            fetch(`/api/etfs/${ticker}/daily-prices`)
                .then(response => {
                    console.log(`📊 Daily prices response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`📊 Daily prices data response:`, data);
                    
                    if (data.success) {
                        const canvasElement = document.getElementById('weeklyPriceChart');
                        if (!canvasElement) {
                            console.error('❌ Canvas element weeklyPriceChart nie został znaleziony!');
                            return;
                        }
                        
                        const ctx = canvasElement.getContext('2d');
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.daily_prices.map(p => p.date);
                        const prices = data.data.daily_prices.map(p => p.close);
                        
                        console.log(`📊 Przygotowane dane dzienne: ${labels.length} etykiet, ${prices.length} cen`);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (weeklyPriceChart) {
                            weeklyPriceChart.destroy();
                        }
                        
                        // Tworzenie nowego wykresu cen dziennych
                        weeklyPriceChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: `Cena dzienna ${ticker}`,
                                    data: prices,
                                    borderColor: 'rgb(75, 192, 192)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                    borderWidth: 2,
                                    pointRadius: 1,
                                    pointHoverRadius: 4,
                                    tension: 0.1,
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: function(context) {
                                                // Format daty: YYYY.MM.DD
                                                const date = new Date(context[0].label);
                                                return date.toISOString().split('T')[0].replace(/-/g, '.');
                                            },
                                            label: function(context) {
                                                const price = context.parsed.y;
                                                return `Cena: $${formatNumber(price, 2)}`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    datalabels: {
                                        display: false  // Wyłącz etykiety z cenami na punktach
                                    }
                                },
                                scales: {
                                    x: {
                                        display: false,  // Ukryj oś X - będzie wspólna z wskaźnikami
                                        grid: {
                                            display: false
                                        }
                                    },
                                    y: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Cena ($)'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return '$' + formatNumber(value, 2);
                                            }
                                        },
                                        grid: {
                                            color: 'rgba(0, 0, 0, 0.1)'
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Wykres cen dziennych utworzony pomyślnie!`);
                        
                    } else {
                        console.error('Błąd pobierania danych cen dziennych:', data.error);
                        document.getElementById('weeklyPriceChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu cen dziennych</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych cen dziennych:', error);
                    document.getElementById('weeklyPriceChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu cen dziennych</div>';
                });
        }

        // Funkcja do tworzenia wykresu MACD dziennego
        function createDailyMACDChart(ticker) {
            console.log(`🔄 Tworzenie wykresu MACD dziennego dla ${ticker}...`);
            
            fetch(`/api/etfs/${ticker}/daily-macd`)
                .then(response => {
                    console.log(`📊 Daily MACD response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`📊 Daily MACD data response:`, data);
                    
                    if (data.success) {
                        const canvasElement = document.getElementById('macdChart');
                        if (!canvasElement) {
                            console.error('❌ Canvas element macdChart nie został znaleziony!');
                            return;
                        }
                        
                        const ctx = canvasElement.getContext('2d');
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.daily_macd.map(m => m.date);
                        const macdLine = data.data.daily_macd.map(m => m.macd_line);
                        const signalLine = data.data.daily_macd.map(m => m.signal_line);
                        const histogram = data.data.daily_macd.map(m => m.histogram);
                        
                        console.log(`📊 Daily MACD: ${labels.length} etykiet, ${macdLine.length} wartości MACD Line, ${signalLine.length} wartości Signal Line`);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (macdChart) {
                            macdChart.destroy();
                        }
                        
                        // Tworzenie nowego wykresu MACD
                        macdChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: 'MACD Line (zielona)',
                                        data: macdLine,
                                        borderColor: 'rgb(34, 197, 94)',
                                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-macd'
                                    },
                                    {
                                        label: 'Signal Line (czerwona)',
                                        data: signalLine,
                                        borderColor: 'rgb(239, 68, 68)',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-macd'
                                    },
                                    {
                                        label: 'Histogram',
                                        data: histogram,
                                        type: 'bar',
                                        backgroundColor: histogram.map(h => h >= 0 ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)'),
                                        borderColor: histogram.map(h => h >= 0 ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)'),
                                        borderWidth: 1,
                                        yAxisID: 'y-macd'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: function(context) {
                                                // Format daty: YYYY.MM.DD
                                                const date = new Date(context[0].label);
                                                return date.toISOString().split('T')[0].replace(/-/g, '.');
                                            },
                                            label: function(context) {
                                                const value = context.parsed.y;
                                                const datasetLabel = context.dataset.label;
                                                if (datasetLabel === 'Histogram') {
                                                    return `${datasetLabel}: ${value.toFixed(4)}`;
                                                }
                                                return `${datasetLabel}: ${value.toFixed(4)}`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    datalabels: {
                                        display: false  // Wyłącz etykiety z wartościami na punktach
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Data'
                                        },
                                        grid: {
                                            display: true
                                        }
                                    },
                                    'y-macd': {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'MACD'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return value.toFixed(4);
                                            }
                                        },
                                        grid: {
                                            color: 'rgba(0, 0, 0, 0.1)'
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Wykres MACD dzienny utworzony pomyślnie!`);
                        
                    } else {
                        console.error('Błąd pobierania danych MACD dziennego:', data.error);
                        document.getElementById('macdChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu MACD dziennego</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych MACD dziennego:', error);
                    document.getElementById('macdChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu MACD dziennego</div>';
                });
        }

        // Funkcja do tworzenia wykresu Stochastic Oscillator dziennego
        function createDailyStochasticChart(ticker) {
            console.log(`🔄 Tworzenie wykresu Stochastic Oscillator dziennego dla ${ticker}...`);
            
            fetch(`/api/etfs/${ticker}/daily-stochastic`)
                .then(response => {
                    console.log(`📊 Daily Stochastic response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`📊 Daily Stochastic data response:`, data);
                    
                    if (data.success) {
                        const canvasElement = document.getElementById('stochasticChart');
                        if (!canvasElement) {
                            console.error('❌ Canvas element stochasticChart nie został znaleziony!');
                            return;
                        }
                        
                        const ctx = canvasElement.getContext('2d');
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.daily_stochastic.map(s => s.date);
                        const kPercent = data.data.daily_stochastic.map(s => s.k_percent);
                        const dPercent = data.data.daily_stochastic.map(s => s.d_percent);
                        
                        console.log(`📊 Daily Stochastic: ${labels.length} etykiet, ${kPercent.length} wartości %K, ${dPercent.length} wartości %D`);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (stochasticChart) {
                            stochasticChart.destroy();
                        }
                        
                        // Tworzenie nowego wykresu Stochastic Oscillator
                        stochasticChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: '%K (zielona)',
                                        data: kPercent,
                                        borderColor: 'rgb(34, 197, 94)',
                                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-stochastic'
                                    },
                                    {
                                        label: '%D (czerwona)',
                                        data: dPercent,
                                        borderColor: 'rgb(239, 68, 68)',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-stochastic'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: function(context) {
                                                // Format daty: YYYY.MM.DD
                                                const date = new Date(context[0].label);
                                                return date.toISOString().split('T')[0].replace(/-/g, '.');
                                            },
                                            label: function(context) {
                                                const value = context.parsed.y;
                                                const datasetLabel = context.dataset.label;
                                                return `${datasetLabel}: ${value.toFixed(2)}%`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    datalabels: {
                                        display: false  // Wyłącz etykiety z wartościami na punktach
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Data'
                                        },
                                        grid: {
                                            display: true
                                        }
                                    },
                                    'y-stochastic': {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Stochastic %'
                                        },
                                        min: 0,
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        },
                                        grid: {
                                            color: function(context) {
                                                if (context.tick.value === 20 || context.tick.value === 80) {
                                                    return 'rgba(239, 68, 68, 0.5)';  // Czerwone linie dla 20% i 80%
                                                }
                                                return 'rgba(0, 0, 0, 0.1)';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Wykres Stochastic Oscillator dzienny utworzony pomyślnie!`);
                        
                    } else {
                        console.error('Błąd pobierania danych Stochastic dziennego:', data.error);
                        document.getElementById('stochasticChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu Stochastic Oscillator dziennego</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych Stochastic dziennego:', error);
                    document.getElementById('stochasticChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu Stochastic Oscillator dziennego</div>';
                });
        }

        // Funkcja do tworzenia krótkiego wykresu Stochastic Oscillator dziennego
        function createDailyStochasticShortChart(ticker) {
            console.log(`🔄 Tworzenie krótkiego wykresu Stochastic Oscillator dziennego dla ${ticker}...`);
            
            fetch(`/api/etfs/${ticker}/daily-stochastic-short`)
                .then(response => {
                    console.log(`📊 Daily Stochastic Short response status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`📊 Daily Stochastic Short data response:`, data);
                    
                    if (data.success) {
                        const canvasElement = document.getElementById('stochasticChartShort');
                        if (!canvasElement) {
                            console.error('❌ Canvas element stochasticChartShort nie został znaleziony!');
                            return;
                        }
                        
                        const ctx = canvasElement.getContext('2d');
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.daily_stochastic.map(s => s.date);
                        const kPercent = data.data.daily_stochastic.map(s => s.k_percent);
                        const dPercent = data.data.daily_stochastic.map(s => s.d_percent);
                        
                        console.log(`📊 Daily Stochastic Short: ${labels.length} etykiet, ${kPercent.length} wartości %K, ${dPercent.length} wartości %D`);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (stochasticChartShort) {
                            stochasticChartShort.destroy();
                        }
                        
                        // Tworzenie nowego wykresu Stochastic Oscillator
                        stochasticChartShort = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [
                                    {
                                        label: '%K (zielona)',
                                        data: kPercent,
                                        borderColor: 'rgb(34, 197, 94)',
                                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-stochastic-short'
                                    },
                                    {
                                        label: '%D (czerwona)',
                                        data: dPercent,
                                        borderColor: 'rgb(239, 68, 68)',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        borderWidth: 2,
                                        pointRadius: 1,
                                        pointHoverRadius: 4,
                                        tension: 0.1,
                                        fill: false,
                                        yAxisID: 'y-stochastic-short'
                                    }
                                ]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            title: function(context) {
                                                // Format daty: YYYY.MM.DD
                                                const date = new Date(context[0].label);
                                                return date.toISOString().split('T')[0].replace(/-/g, '.');
                                            },
                                            label: function(context) {
                                                const value = context.parsed.y;
                                                const datasetLabel = context.dataset.label;
                                                return `${datasetLabel}: ${value.toFixed(2)}%`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    },
                                    datalabels: {
                                        display: false  // Wyłącz etykiety z wartościami na punktach
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Data'
                                        },
                                        grid: {
                                            display: true
                                        }
                                    },
                                    'y-stochastic-short': {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Stochastic %'
                                        },
                                        min: 0,
                                        max: 100,
                                        ticks: {
                                            callback: function(value) {
                                                return value + '%';
                                            }
                                        },
                                        grid: {
                                            color: function(context) {
                                                if (context.tick.value === 20 || context.tick.value === 80) {
                                                    return 'rgba(239, 68, 68, 0.5)';  // Czerwone linie dla 20% i 80%
                                                }
                                                return 'rgba(0, 0, 0, 0.1)';
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`✅ Krótki wykres Stochastic Oscillator dzienny utworzony pomyślnie!`);
                        
                    } else {
                        console.error('Błąd pobierania danych krótkiego Stochastic dziennego:', data.error);
                        document.getElementById('stochasticChartShort').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować krótkiego wykresu Stochastic Oscillator dziennego</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych krótkiego Stochastic dziennego:', error);
                    document.getElementById('stochasticChartShort').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania krótkiego wykresu Stochastic Oscillator dziennego</div>';
                });
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>