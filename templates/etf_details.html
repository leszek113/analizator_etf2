<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF {{ etf.ticker }} - Szczegóły</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .dividend-matrix {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
        }
        .matrix-table {
            font-size: 0.9em;
            border-collapse: collapse;
        }
        .matrix-table th {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 8px 4px;
            text-align: center;
            font-weight: 600;
            min-width: 50px;
        }
        .matrix-table td {
            border: 1px solid #dee2e6;
            padding: 6px 4px;
            text-align: center;
            min-width: 50px;
        }
        .matrix-table .year-column {
            background: #e9ecef;
            font-weight: 600;
            text-align: right;
            padding-right: 12px;
            min-width: 60px;
        }
        .dividend-value {
            background: #d4edda;
            color: #155724;
            font-weight: 600;
        }
        .no-dividend {
            background: #f8f9fa;
            color: #6c757d;
        }
        .table-success {
            background: #d1e7dd !important;
            color: #0f5132 !important;
        }
        .table-warning {
            background: #fff3cd !important;
            color: #664d03 !important;
        }
        .table-secondary {
            background: #e2e3e5 !important;
            color: #41464b !important;
        }
                            .table-light {
                        background: #f8f9fa !important;
                        color: #6c757d !important;
                    }
                    .split-info {
                        background: #f8f9fa;
                        text-align: center;
                        min-width: 60px;
                    }
                    .split-info .badge {
                        font-size: 0.8em;
                    }
                    .header-card {
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        border-radius: 10px;
                        padding: 20px;
                        margin: 20px 0;
                    }
        .back-button {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
        }
        .back-button:hover {
            background: rgba(255,255,255,0.3);
            color: white;
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid">
        <!-- Back Button -->
        <div class="row mt-3">
            <div class="col-12">
                <a href="/" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Powrót do Dashboard
                </a>
            </div>
        </div>

        <!-- ETF Header Info -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2 class="card-title mb-2">
                                    <i class="bi bi-graph-up text-primary"></i>
                                    {{ etf.ticker }} - {{ etf.name or 'N/A' }}
                                </h2>
                                <div class="etf-info">
                                    <span class="badge bg-primary me-2">
                                        <i class="bi bi-currency-dollar"></i>
                                        Cena: ${{ "%.2f"|format(etf.current_price) if etf.current_price else 'N/A' }}
                                    </span>
                                    <span class="badge bg-success me-2">
                                        <i class="bi bi-percent"></i>
                                        Yield: <span id="currentYield" data-original="{{ "%.2f"|format(etf.current_yield) if etf.current_yield else 'N/A' }}">{{ "%.2f"|format(etf.current_yield) if etf.current_yield else 'N/A' }}</span>%
                                    </span>
                                    <span class="badge bg-warning text-dark me-2" id="taxRateBadge">
                                        <i class="bi bi-receipt"></i>
                                        Podatek od dyw.: <span id="currentTaxRate">0</span>%
                                    </span>
                                    <span class="badge bg-info me-2">
                                        <i class="bi bi-calendar-event"></i>
                                        Częstotliwość: {{ etf.frequency or 'N/A' }}
                                    </span>
                                    <span class="badge bg-secondary me-2">
                                        <i class="bi bi-calculator"></i>
                                        Suma {{ "12" if etf.frequency == "monthly" else "4" }} ost.: 
                                        $<span id="lastDividendsSum" data-original="{{ "%.5f"|format(last_dividends_sum) if last_dividends_sum else 'N/A' }}">{{ "%.5f"|format(last_dividends_sum) if last_dividends_sum else 'N/A' }}</span>
                                    </span>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="mb-2">
                                    <small class="text-muted">Ostatnia aktualizacja:</small><br>
                                    <span class="badge bg-light text-dark">
                                        {{ etf.last_updated.strftime('%Y-%m-%d %H:%M') if etf.last_updated else 'N/A' }}
                                    </span>
                                </div>
                                <button class="btn btn-success btn-sm" onclick="updateEtfData()">
                                    <i class="bi bi-arrow-clockwise"></i> Aktualizuj
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dividend Matrix -->
        <div class="dividend-matrix">
            <h3 class="mb-4">
                <i class="bi bi-calendar-check"></i>
                Historia wypłaconych dywidend
            </h3>

            
            <div class="table-responsive">
                <table class="table matrix-table">
                                            <thead>
                            <tr>
                                <th class="year-column">Suma Roczna</th>
                                <th class="year-column">Rok</th>
                                <th>Sty</th>
                                <th>Lut</th>
                                <th>Mar</th>
                                <th>Kwi</th>
                                <th>Maj</th>
                                <th>Cze</th>
                                <th>Lip</th>
                                <th>Sie</th>
                                <th>Wrz</th>
                                <th>Paź</th>
                                <th>Lis</th>
                                <th>Gru</th>
                            </tr>
                        </thead>
                    <tbody>
                        {% set dividends_by_year_month = {} %}
                        {% set yearly_totals = {} %}
                        {% for dividend in dividends %}
                            {% set year = dividend.payment_date.year %}
                            {% set month = dividend.payment_date.month %}
                            {% if year not in dividends_by_year_month %}
                                {% set _ = dividends_by_year_month.update({year: {}}) %}
                                {% set _ = yearly_totals.update({year: 0}) %}
                            {% endif %}
                            {% if month not in dividends_by_year_month[year] %}
                                {% set _ = dividends_by_year_month[year].update({month: []}) %}
                            {% endif %}
                            {% set _ = dividends_by_year_month[year][month].append(dividend.normalized_amount) %}
                            {% set _ = yearly_totals.update({year: yearly_totals[year] + dividend.normalized_amount}) %}
                        {% endfor %}
                        
                        {% set years = dividends_by_year_month.keys()|sort(reverse=true) %}
                        {% for year in years %}
                            {% set current_total = yearly_totals[year] %}
                            {% set previous_year = years[loop.index0 + 1] if loop.index0 + 1 < years|length else None %}
                            {% set previous_total = yearly_totals[previous_year] if previous_year else None %}
                            
                            {% if previous_total %}
                                {% if current_total > previous_total %}
                                    {% set total_class = "table-success" %}
                                    {% set total_title = "Wzrost z " + "%.5f"|format(previous_total) + " na " + "%.5f"|format(current_total) %}
                                {% elif current_total < previous_total %}
                                    {% set total_class = "table-warning" %}
                                    {% set total_title = "Spadek z " + "%.5f"|format(previous_total) + " na " + "%.5f"|format(current_total) %}
                                {% else %}
                                    {% set total_class = "table-secondary" %}
                                    {% set total_title = "Bez zmian: " + "%.5f"|format(current_total) %}
                                {% endif %}
                            {% else %}
                                {% set total_class = "table-light" %}
                                                                    {% set total_title = "Pierwszy rok: " + "%.5f"|format(current_total) %}
                            {% endif %}
                            
                                                                    <tr>
                                            <td class="{{ total_class }} yearly-total" title="{{ total_title }}" data-original="{{ "%.5f"|format(current_total) }}">
                                                <strong>{{ "%.5f"|format(current_total) }}</strong>
                                            </td>
                                            <td class="year-column">{{ year }}</td>
                                            {% for month in range(1, 13) %}
                                                {% if month in dividends_by_year_month[year] %}
                                                    {% set amounts = dividends_by_year_month[year][month] %}
                                                    {% set total = amounts|sum %}
                                                    {% set count = amounts|length %}
                                                    {% if count > 1 %}
                                                        <td class="dividend-value monthly-dividend" title="Liczba wypłat: {{ count }}" data-original="{{ "%.5f"|format(total) }}">
                                                            {{ "%.5f"|format(total) }}
                                                        </td>
                                                    {% else %}
                                                        <td class="dividend-value monthly-dividend" data-original="{{ "%.5f"|format(total) }}">
                                                            {{ "%.5f"|format(total) }}
                                                        </td>
                                                    {% endif %}
                                                {% else %}
                                                    <td class="no-dividend">0,00</td>
                                                {% endif %}
                                            {% endfor %}
                                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
                                    <div class="mt-3 text-muted">
                            <small>
                                <i class="bi bi-info-circle"></i>
                                <strong>Suma Roczna:</strong> 
                                <span class="text-success">Zielone</span> = wzrost dywidendy rok do roku, 
                                <span class="text-warning">Żółte</span> = spadek dywidendy rok do roku, 
                                <span class="text-secondary">Szare</span> = bez zmian. 
                                <br>
                                <strong>Split akcji:</strong> 
                                {% if etf.splits.count() > 0 %}
                                    {% for split in etf.splits %}
                                        {{ split.description }} dnia {{ split.split_date.strftime('%d %B %Y') }}
                                        {% if not loop.last %}, {% endif %}
                                    {% endfor %}
                                {% else %}
                                    Brak splitów akcji w historii tego ETF.
                                {% endif %}
                                <br>
                                <strong>Komórki miesięczne:</strong> Suma dywidend wypłaconych w danym miesiącu. 
                                Jeśli w miesiącu wypłacono kilka dywidend, pokazana jest suma.
                                <br>
                                <strong>Uwaga:</strong> Dywidendy przed splitem są automatycznie normalizowane dla porównywalności.
                            </small>
                        </div>
        </div>
    </div>

    <!-- Wykres cen miesięcznych -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up"></i> 
                        Ceny miesięczne - ostatnie 15 lat
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height:400px;">
                        <canvas id="priceChart"></canvas>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="bi bi-info-circle"></i>
                            Wykres pokazuje oryginalne ceny historyczne (jakie były w danym momencie). 
                            Dywidendy w tabeli powyżej są znormalizowane względem splitów akcji.
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Skrypty JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let currentTaxRate = 0.0;
        let originalValues = {};

        // Inicjalizacja
        document.addEventListener('DOMContentLoaded', function() {
            loadTaxRate();
            loadOriginalValues();
        });

        async function loadTaxRate() {
            try {
                const response = await fetch('/api/system/dividend-tax-rate');
                const result = await response.json();
                
                if (result.success) {
                    currentTaxRate = result.data.tax_rate;
                    document.getElementById('currentTaxRate').textContent = currentTaxRate;
                    recalculateAllValues();
                }
            } catch (error) {
                console.error('Error loading tax rate:', error);
            }
        }

        function loadOriginalValues() {
            // Zapisz oryginalne wartości
            originalValues = {
                yield: parseFloat(document.querySelector('.badge.bg-success').textContent.match(/Yield: ([\d.]+)%/)[1]),
                lastDividendsSum: parseFloat(document.getElementById('lastDividendsSum').textContent.replace('$', ''))
            };
        }

        function recalculateAllValues() {
            if (currentTaxRate <= 0) {
                // Przywróć oryginalne wartości
                document.querySelector('.badge.bg-success').innerHTML = 
                    `<i class="bi bi-percent"></i> Yield: ${originalValues.yield.toFixed(5)}%`;
                document.getElementById('lastDividendsSum').textContent = 
                    originalValues.lastDividendsSum.toFixed(5);
                return;
            }

            // Przelicz yield
            const afterTaxYield = originalValues.yield * (1 - currentTaxRate / 100);
            document.querySelector('.badge.bg-success').innerHTML = 
                `<i class="bi bi-percent"></i> Yield: ${afterTaxYield.toFixed(5)}%`;

            // Przelicz sumę dywidend
            const afterTaxDividends = originalValues.lastDividendsSum * (1 - currentTaxRate / 100);
            document.getElementById('lastDividendsSum').textContent = 
                afterTaxDividends.toFixed(5);

            // Przelicz wszystkie kwoty w tabeli dywidend
            recalculateDividendTable();
        }

        function recalculateDividendTable() {
            // Przelicz wszystkie kwoty w macierzy dywidend
            const dividendCells = document.querySelectorAll('.dividend-value');
            dividendCells.forEach(cell => {
                const originalAmount = parseFloat(cell.dataset.originalAmount || cell.textContent);
                if (!isNaN(originalAmount)) {
                    if (!cell.dataset.originalAmount) {
                        cell.dataset.originalAmount = originalAmount;
                    }
                    
                    if (currentTaxRate > 0) {
                        const afterTaxAmount = originalAmount * (1 - currentTaxRate / 100);
                        cell.innerHTML = `
                            <div class="text-center">
                                <div class="fw-bold">${afterTaxAmount.toFixed(5)}</div>
                                <small class="text-muted">${originalAmount.toFixed(5)}</small>
                            </div>
                        `;
                    } else {
                        cell.innerHTML = originalAmount.toFixed(5);
                    }
                }
            });

            // Przelicz sumy roczne
            const yearlyTotalCells = document.querySelectorAll('td:first-child');
            yearlyTotalCells.forEach(cell => {
                if (cell.classList.contains('table-success') || cell.classList.contains('table-warning') || 
                    cell.classList.contains('table-secondary') || cell.classList.contains('table-light')) {
                    const originalAmount = parseFloat(cell.dataset.originalAmount || cell.querySelector('strong').textContent);
                    if (!isNaN(originalAmount)) {
                        if (!cell.dataset.originalAmount) {
                            cell.dataset.originalAmount = originalAmount;
                        }
                        
                        if (currentTaxRate > 0) {
                            const afterTaxAmount = originalAmount * (1 - currentTaxRate / 100);
                            cell.querySelector('strong').innerHTML = afterTaxAmount.toFixed(5);
                        } else {
                            cell.querySelector('strong').innerHTML = originalAmount.toFixed(5);
                        }
                    }
                }
            });
        }


        
        function calculateAfterTaxYield(originalYield, taxRate) {
            if (taxRate <= 0) return originalYield;
            return originalYield * (1 - taxRate / 100);
        }

        function calculateAfterTaxAmount(originalAmount, taxRate) {
            if (taxRate <= 0) return originalAmount;
            return originalAmount * (1 - taxRate / 100);
        }
        
        // Inicjalizacja wykresu cen
        let priceChart = null;
        
        // Funkcja do tworzenia wykresu cen
        function createPriceChart(ticker) {
            fetch(`/api/etfs/${ticker}/prices`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const ctx = document.getElementById('priceChart').getContext('2d');
                        
                        // Przygotowanie danych dla Chart.js
                        const labels = data.data.prices.map(p => p.date);
                        const prices = data.data.prices.map(p => p.original_price);
                        
                        // Usunięcie poprzedniego wykresu jeśli istnieje
                        if (priceChart) {
                            priceChart.destroy();
                        }
                        
                        // Tworzenie nowego wykresu
                        priceChart = new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: `Cena miesięczna ${ticker} (oryginalna)`,
                                    data: prices,
                                    borderColor: 'rgb(75, 192, 192)',
                                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                                    borderWidth: 2,
                                    pointRadius: 3,
                                    pointHoverRadius: 6,
                                    tension: 0.1,
                                    fill: false
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                interaction: {
                                    intersect: false,
                                    mode: 'index'
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const price = context.parsed.y;
                                                return `Cena: $${price.toFixed(2)}`;
                                            }
                                        }
                                    },
                                    legend: {
                                        display: true,
                                        position: 'top'
                                    }
                                },
                                scales: {
                                    x: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Data'
                                        },
                                        ticks: {
                                            maxTicksLimit: 15,
                                            maxRotation: 45
                                        }
                                    },
                                    y: {
                                        display: true,
                                        title: {
                                            display: true,
                                            text: 'Cena ($)'
                                        },
                                        ticks: {
                                            callback: function(value) {
                                                return '$' + value.toFixed(2);
                                            }
                                        }
                                    }
                                }
                            }
                        });
                        
                        console.log(`Wykres cen utworzony dla ${ticker}: ${data.data.count} punktów danych`);
                    } else {
                        console.error('Błąd pobierania danych cenowych:', data.error);
                        document.getElementById('priceChart').innerHTML = 
                            '<div class="alert alert-warning">Nie udało się załadować wykresu cen</div>';
                    }
                })
                .catch(error => {
                    console.error('Błąd podczas pobierania danych cenowych:', error);
                    document.getElementById('priceChart').innerHTML = 
                        '<div class="alert alert-danger">Błąd podczas ładowania wykresu cen</div>';
                });
        }
        
        // Inicjalizacja wykresu po załadowaniu strony
        document.addEventListener('DOMContentLoaded', function() {
            const ticker = '{{ etf.ticker }}';
            createPriceChart(ticker);
            
            // Ładowanie stawki podatku i przeliczanie wartości
            loadTaxRate();
        });
        
        // Funkcje do obsługi podatku od dywidend
        
        async function loadTaxRate() {
            try {
                const response = await fetch('/api/system/dividend-tax-rate');
                const result = await response.json();
                
                if (result.success) {
                    currentTaxRate = result.data.tax_rate;
                    console.log('📊 Tax rate loaded:', currentTaxRate);
                    
                    // Aktualizacja badge z stawką podatku
                    document.getElementById('currentTaxRate').textContent = currentTaxRate;
                    
                    // Przeliczenie wszystkich wartości
                    recalculateAllValues();
                }
            } catch (error) {
                console.error('Error loading tax rate:', error);
            }
        }
        
        function recalculateAllValues() {
            console.log('🔢 Recalculating values with tax rate:', currentTaxRate);
            
            // Przeliczenie yield w nagłówku - BRUTTO i NETTO w formacie 2 miejsc po przecinku
            const currentYieldElement = document.getElementById('currentYield');
            if (currentYieldElement) {
                const originalYield = parseFloat(currentYieldElement.getAttribute('data-original'));
                if (originalYield && !isNaN(originalYield)) {
                    const afterTaxYield = calculateAfterTaxYield(originalYield, currentTaxRate);
                    currentYieldElement.textContent = `${originalYield.toFixed(2)} (B), ${afterTaxYield.toFixed(2)} (N)`;
                }
            }
            
            // Przeliczenie sumy ostatnich dywidend w nagłówku - BRUTTO i NETTO w jednej linii
            const lastDividendsSumElement = document.getElementById('lastDividendsSum');
            if (lastDividendsSumElement) {
                const originalValue = parseFloat(lastDividendsSumElement.getAttribute('data-original'));
                if (originalValue && !isNaN(originalValue)) {
                    const afterTaxValue = calculateAfterTaxAmount(originalValue, currentTaxRate);
                    lastDividendsSumElement.textContent = `${originalValue.toFixed(5)} (B), ${afterTaxValue.toFixed(5)} (N)`;
                }
            }
            
            // Przeliczenie kolumny "Suma Roczna" w tabeli dywidend
            recalculateYearlyTotals();
        }
        
        function recalculateYearlyTotals() {
            // Przeliczenie kolumny "Suma Roczna"
            const yearlyTotalCells = document.querySelectorAll('.yearly-total');
            yearlyTotalCells.forEach(cell => {
                const originalValue = parseFloat(cell.getAttribute('data-original'));
                if (originalValue && !isNaN(originalValue)) {
                    const afterTaxValue = calculateAfterTaxAmount(originalValue, currentTaxRate);
                    cell.innerHTML = `
                        <div class="text-center">
                            <div class="fw-bold">${originalValue.toFixed(5)}</div>
                            <small class="text-muted">${afterTaxValue.toFixed(5)}</small>
                        </div>
                    `;
                }
            });
            
            // Przeliczenie komórek miesięcznych/kwartalnych
            const monthlyDividendCells = document.querySelectorAll('.monthly-dividend');
            monthlyDividendCells.forEach(cell => {
                const originalValue = parseFloat(cell.getAttribute('data-original'));
                if (originalValue && !isNaN(originalValue)) {
                    const afterTaxValue = calculateAfterTaxAmount(originalValue, currentTaxRate);
                    cell.innerHTML = `
                        <div class="text-center">
                            <div class="fw-bold">${originalValue.toFixed(5)}</div>
                            <small class="text-muted">${afterTaxValue.toFixed(5)}</small>
                        </div>
                    `;
                }
            });
        }
        
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
